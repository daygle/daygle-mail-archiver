{% extends "base.html" %}
{% block content %}

<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-users me-2"></i>User Management</h2>
    </div>
    <div class="col text-end">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
            <i class="fa-solid fa-user-plus"></i> Create New User
        </button>
    </div>
</div>

<!-- Existing Users Section -->
<div class="settings-section">
    <h3>Existing Users</h3>
    <p class="section-description">View and manage all user accounts</p>
    
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ (user.first_name or '') ~ ' ' ~ (user.last_name or '') if user.first_name or user.last_name else '-' }}</td>
                    <td>{{ user.email or '-' }}</td>
                    <td>
                        {% if user.enabled %}
                            <span class="badge bg-success">Enabled</span>
                        {% else %}
                            <span class="badge bg-danger">Disabled</span>
                        {% endif %}
                    </td>
                    <td>{{ user.last_login.strftime(request.session.date_format) if user.last_login else 'Never' }}</td>
                    <td>{{ user.created_at.strftime(request.session.date_format) }}</td>
                    <td>
                        <button type="button" class="btn btn-primary btn-sm" onclick="editUser({{ user.id }})">
                            <i class="fa-solid fa-edit"></i> Edit
                        </button>
                        <form method="post" action="/users/{{ user.id }}/toggle" style="display: inline;">
                            <button type="submit" class="btn btn-sm {% if user.enabled %}btn-warning{% else %}btn-success{% endif %}">
                                <i class="fa-solid {% if user.enabled %}fa-ban{% else %}fa-check{% endif %}"></i> 
                                {{ "Disable" if user.enabled else "Enable" }}
                            </button>
                        </form>
                        <form method="post" action="/users/{{ user.id }}/delete" style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this user?')"><i class="fa-solid fa-trash"></i> Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createUserModalLabel"><i class="fa-solid fa-user-plus"></i> Create New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="/users/create">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="create_username">Username <span class="text-danger">*</span></label>
                                <input id="create_username" class="form-control" name="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="create_password">Password <span class="text-danger">*</span></label>
                                <input id="create_password" class="form-control" name="password" type="password" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="create_first_name">First Name</label>
                                <input id="create_first_name" class="form-control" name="first_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="create_last_name">Last Name</label>
                                <input id="create_last_name" class="form-control" name="last_name">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="create_email">Email</label>
                                <input id="create_email" class="form-control" name="email" type="email">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="create_enabled">Account Status</label>
                                <select id="create_enabled" class="form-control" name="enabled">
                                    <option value="true" selected>Enabled</option>
                                    <option value="false">Disabled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fa-solid fa-user-plus"></i> Create User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel"><i class="fa-solid fa-user-edit"></i> Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="editUserForm">
                <div class="modal-body">
                    <input type="hidden" id="edit_user_id" name="user_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="edit_username">Username <span class="text-danger">*</span></label>
                                <input id="edit_username" class="form-control" name="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="edit_password">New Password <small class="text-muted">(leave blank to keep current)</small></label>
                                <input id="edit_password" class="form-control" name="password" type="password">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="edit_first_name">First Name</label>
                                <input id="edit_first_name" class="form-control" name="first_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="edit_last_name">Last Name</label>
                                <input id="edit_last_name" class="form-control" name="last_name">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="edit_email">Email</label>
                                <input id="edit_email" class="form-control" name="email" type="email">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="edit_enabled">Account Status</label>
                                <select id="edit_enabled" class="form-control" name="enabled">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Account Information:</strong><br>
                        <small>
                            <strong>Last Login:</strong> <span id="edit_last_login">-</span><br>
                            <strong>Created:</strong> <span id="edit_created_at">-</span>
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fa-solid fa-save"></i> Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
async function editUser(userId) {
    try {
        const response = await fetch(`/api/users/${userId}`);
        const user = await response.json();
        
        if (user.error) {
            alert('Error loading user: ' + user.error);
            return;
        }
        
        // Populate the form
        document.getElementById('edit_user_id').value = user.id;
        document.getElementById('edit_username').value = user.username;
        document.getElementById('edit_first_name').value = user.first_name || '';
        document.getElementById('edit_last_name').value = user.last_name || '';
        document.getElementById('edit_email').value = user.email || '';
        document.getElementById('edit_enabled').value = user.enabled ? 'true' : 'false';
        document.getElementById('edit_password').value = '';
        
        // Display read-only info
        document.getElementById('edit_last_login').textContent = user.last_login ? new Date(user.last_login).toLocaleString() : 'Never';
        document.getElementById('edit_created_at').textContent = user.created_at ? new Date(user.created_at).toLocaleString() : '-';
        
        // Set form action
        document.getElementById('editUserForm').action = `/users/${userId}/update`;
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
        modal.show();
    } catch (error) {
        console.error('Error loading user:', error);
        alert('Failed to load user details');
    }
}
</script>

{% endblock %}