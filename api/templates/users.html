{% extends "base.html" %}

{% block page_title %}User Management{% endblock %}

{% block content %}
<!-- Users Table Card -->
<div class="card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-users"></i>
            <span>User Accounts</span>
        </div>
        <button type="button" class="btn btn-primary" onclick="showCreateUserModal()">
            <i class="fas fa-user-plus"></i>
            <span>Create New User</span>
        </button>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td><strong>{{ user.username }}</strong></td>
                        <td>{{ (user.first_name or '') ~ ' ' ~ (user.last_name or '') if user.first_name or user.last_name else '-' }}</td>
                        <td>{{ user.email or '-' }}</td>
                        <td>
                            {% if user.role == 'administrator' %}
                                <span class="badge badge-primary">
                                    <i class="fas fa-user-shield"></i> Administrator
                                </span>
                            {% elif user.role == 'read_only' %}
                                <span class="badge badge-info">
                                    <i class="fas fa-eye"></i> Read Only
                                </span>
                            {% else %}
                                <span class="badge badge-secondary">{{ user.role }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.enabled %}
                                <span class="badge badge-success"><i class="fas fa-check"></i> Enabled</span>
                            {% else %}
                                <span class="badge badge-danger"><i class="fas fa-times"></i> Disabled</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.last_login %}
                                <small>{{ user.last_login.strftime(request.session.date_format) }}</small>
                            {% else %}
                                <span style="color: var(--text-secondary);">Never</span>
                            {% endif %}
                        </td>
                        <td><small>{{ user.created_at.strftime(request.session.date_format) }}</small></td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <button type="button" class="btn btn-secondary btn-sm" title="Edit" onclick="editUser({{ user.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form method="post" action="/users/{{ user.id }}/toggle" style="display: inline;">
                                    <button type="submit" class="btn {% if user.enabled %}btn-warning{% else %}btn-success{% endif %} btn-sm" title="{{ 'Disable' if user.enabled else 'Enable' }}">
                                        <i class="fas {% if user.enabled %}fa-ban{% else %}fa-check{% endif %}"></i>
                                    </button>
                                </form>
                                <form method="post" action="/users/{{ user.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this user?');">
                                    <button type="submit" class="btn btn-danger btn-sm" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if users|length == 0 %}
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 48px 0;">
                            <div style="color: var(--text-secondary);">
                                <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                                <p>No users found.</p>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal" id="createUserModal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Create New User</h3>
            <button class="modal-close" onclick="hideCreateUserModal()">&times;</button>
        </div>
        <form method="post" action="/users/create">
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="create_username">Username <span style="color: var(--color-danger);">*</span></label>
                        <input id="create_username" class="form-control" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="create_password">Password <span style="color: var(--color-danger);">*</span></label>
                        <input id="create_password" class="form-control" name="password" type="password" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="create_first_name">First Name</label>
                        <input id="create_first_name" class="form-control" name="first_name">
                    </div>
                    <div class="form-group">
                        <label for="create_last_name">Last Name</label>
                        <input id="create_last_name" class="form-control" name="last_name">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="create_email">Email</label>
                        <input id="create_email" class="form-control" name="email" type="email">
                    </div>
                    <div class="form-group">
                        <label for="create_role">Role <span style="color: var(--color-danger);">*</span></label>
                        <select id="create_role" class="form-control" name="role" required>
                            <option value="administrator">Administrator (Full Access)</option>
                            <option value="read_only">Read Only (View Emails Only)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="create_enabled">Account Status</label>
                    <select id="create_enabled" class="form-control" name="enabled">
                        <option value="true" selected>Enabled</option>
                        <option value="false">Disabled</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideCreateUserModal()">Cancel</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus"></i> Create User</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal" id="editUserModal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3><i class="fas fa-user-edit"></i> Edit User</h3>
            <button class="modal-close" onclick="hideEditUserModal()">&times;</button>
        </div>
        <form method="post" id="editUserForm">
            <div class="modal-body">
                <input type="hidden" id="edit_user_id" name="user_id">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="edit_username">Username <span style="color: var(--color-danger);">*</span></label>
                        <input id="edit_username" class="form-control" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_password">New Password <small style="color: var(--text-secondary);">(leave blank to keep current)</small></label>
                        <input id="edit_password" class="form-control" name="password" type="password">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="edit_first_name">First Name</label>
                        <input id="edit_first_name" class="form-control" name="first_name">
                    </div>
                    <div class="form-group">
                        <label for="edit_last_name">Last Name</label>
                        <input id="edit_last_name" class="form-control" name="last_name">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="edit_email">Email</label>
                        <input id="edit_email" class="form-control" name="email" type="email">
                    </div>
                    <div class="form-group">
                        <label for="edit_role">Role <span style="color: var(--color-danger);">*</span></label>
                        <select id="edit_role" class="form-control" name="role" required>
                            <option value="administrator">Administrator (Full Access)</option>
                            <option value="read_only">Read Only (View Emails Only)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="edit_enabled">Account Status</label>
                    <select id="edit_enabled" class="form-control" name="enabled">
                        <option value="true">Enabled</option>
                        <option value="false">Disabled</option>
                    </select>
                </div>
                
                <div class="alert alert-info">
                    <strong>Account Information:</strong><br>
                    <small>
                        <strong>Last Login:</strong> <span id="edit_last_login">-</span><br>
                        <strong>Created:</strong> <span id="edit_created_at">-</span>
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="hideEditUserModal()">Cancel</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
// Define functions immediately so onclick handlers can access them
function showCreateUserModal() {
    document.getElementById('createUserModal').style.display = 'flex';
}

function hideCreateUserModal() {
    document.getElementById('createUserModal').style.display = 'none';
}

function hideEditUserModal() {
    document.getElementById('editUserModal').style.display = 'none';
}

async function editUser(userId) {
    try {
        const response = await fetch(`/api/users/${userId}`);
        const user = await response.json();
        
        if (user.error) {
            alert('Error loading user: ' + user.error);
            return;
        }
        
        // Populate the form
        document.getElementById('edit_user_id').value = user.id;
        document.getElementById('edit_username').value = user.username;
        document.getElementById('edit_first_name').value = user.first_name || '';
        document.getElementById('edit_last_name').value = user.last_name || '';
        document.getElementById('edit_email').value = user.email || '';
        document.getElementById('edit_role').value = user.role || 'administrator';
        document.getElementById('edit_enabled').value = user.enabled ? 'true' : 'false';
        document.getElementById('edit_password').value = '';
        
        // Display read-only info
        document.getElementById('edit_last_login').textContent = user.last_login ? new Date(user.last_login).toLocaleString() : 'Never';
        document.getElementById('edit_created_at').textContent = user.created_at ? new Date(user.created_at).toLocaleString() : '-';
        
        // Set form action
        document.getElementById('editUserForm').action = `/users/${userId}/update`;
        
        // Show the modal
        document.getElementById('editUserModal').style.display = 'flex';
    } catch (error) {
        console.error('Error loading user:', error);
        alert('Failed to load user details');
    }
}

// Close modals on background click - wait for DOM
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('createUserModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideCreateUserModal();
        }
    });

    document.getElementById('editUserModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideEditUserModal();
        }
    });
});
</script>

{% endblock %}
