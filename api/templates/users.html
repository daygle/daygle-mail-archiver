{% extends "base.html" %}

{% block page_title %}User Management{% endblock %}

{% block content %}
<!-- Create/Edit User Form Card (Initially Hidden) -->
<div class="card mb-4" id="userFormCard" style="display: none;">
    <div class="card-header flex-between">
        <div class="card-title">
            <i class="fas fa-user-plus" id="formIcon"></i>
            <span id="formTitle">Create New User</span>
        </div>
        <button type="button" class="btn btn-secondary btn-sm" onclick="hideUserForm()" title="Cancel">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="card-body">
        <form method="post" id="userForm" action="/users/create">
            <input type="hidden" id="user_id" name="user_id">
            
            <div class="two-col-grid">
                <div class="form-group">
                    <label for="username">Username <span style="color: var(--danger);">*</span></label>
                    <input id="username" class="form-control" name="username" autocomplete="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password <span id="passwordLabel"><span style="color: var(--danger);">*</span></span></label>
                    <input id="password" class="form-control" name="password" type="password" autocomplete="new-password" required>
                </div>
            </div>
            
            <div class="two-col-grid">
                <div class="form-group">
                    <label for="first_name">First Name</label>
                    <input id="first_name" class="form-control" name="first_name" autocomplete="given-name">
                </div>
                <div class="form-group">
                    <label for="last_name">Last Name</label>
                    <input id="last_name" class="form-control" name="last_name" autocomplete="family-name">
                </div>
            </div>
            
            <div class="two-col-grid">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input id="email" class="form-control" name="email" type="email" autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="email_notifications">Email Notifications</label>
                    <select id="email_notifications" class="form-control" name="email_notifications">
                        <option value="true" selected>Enabled</option>
                        <option value="false">Disabled</option>
                    </select>
                    <small class="form-text">Receive email alerts and notifications</small>
                </div>
            </div>
            
            <div class="two-col-grid">
            <div class="form-group col-span-2">
                <label>Roles <span style="color: var(--danger);">*</span></label>
                <div class="roles-grid">
                    {% for role in roles %}
                    <div class="role-item">
                        <label class="role-checkbox">
                            <input type="checkbox" name="role_ids" value="{{ role.id }}">
                            <span class="checkmark"></span>
                            <div class="role-details">
                                <strong>{{ role.display_name or (role.name | replace('_', ' ') | replace('-', ' ') | title) }}</strong>
                                {% if role.description %}
                                <br><small>{{ role.description }}</small>
                                {% endif %}
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <small class="form-text">Select one or more roles for this user</small>
            </div>

            </div>
            
            <div class="alert alert-info" id="userInfoAlert" style="display: none;">
                <strong>Account Information:</strong><br>
                <small>
                    <strong>Last Login:</strong> <span id="last_login">-</span><br>
                    <strong>Created:</strong> <span id="created_at">-</span>
                </small>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="hideUserForm()">
                    <i class="fas fa-times"></i>
                    <span>Cancel</span>
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save" id="submitIcon"></i>
                    <span id="submitText">Create User</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Users Table Card -->
<div class="card" id="usersListCard">
    <div class="card-header flex-between">
        <div class="card-title">
            <i class="fas fa-users"></i>
            <span>User Accounts</span>
        </div>
        <button type="button" class="btn btn-primary" onclick="showCreateUserForm()">
            <i class="fas fa-user-plus"></i>
            <span>Create New User</span>
        </button>
    </div>
    <div class="card-body" style="padding: 0;">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th class="hide-mobile">Roles</th>
                            <th>Status</th>
                            <th class="hide-mobile">Created</th>
                            <th class="hide-mobile">Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td><strong>{{ user.username }}</strong></td>
                            <td>{{ (user.first_name or '') ~ ' ' ~ (user.last_name or '') if user.first_name or user.last_name else '-' }}</td>
                            <td>{{ user.email or '-' }}</td>
                            <td class="hide-mobile">
                                {% if user.roles %}
                                    {% for role in user.roles.split(', ') %}
                                        <span class="badge badge-secondary">{{ role }}</span>
                                    {% endfor %}
                                {% else %}
                                    <em class="text-muted">No roles assigned</em>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.enabled %}
                                    <span class="badge badge-success"><i class="fas fa-check"></i> Enabled</span>
                                {% else %}
                                    <span class="badge badge-danger"><i class="fas fa-times"></i> Disabled</span>
                                {% endif %}
                            </td>
                            <td class="hide-mobile"><small>{{ user.created_at | format_user_datetime(request.session.user_id) }}</small></td>
                            <td class="hide-mobile">
                                {% if user.last_login %}
                                    <small>{{ user.last_login | format_user_datetime(request.session.user_id) }}</small>
                                {% else %}
                                    <span style="color: var(--text-secondary);">Never</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="flex-gap-8">
                                    <button type="button" class="btn btn-secondary btn-sm" title="Edit" onclick="editUser({{ user.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <form method="post" action="/users/{{ user.id }}/toggle" style="display: inline;">
                                        <button type="submit" class="btn {% if user.enabled %}btn-warning{% else %}btn-success{% endif %} btn-sm" title="{{ 'Disable' if user.enabled else 'Enable' }}" {% if user.id == request.session.user_id %}disabled{% endif %}>
                                            <i class="fas {% if user.enabled %}fa-ban{% else %}fa-check{% endif %}"></i>
                                        </button>
                                    </form>
                                    <form method="post" action="/users/{{ user.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this user?');">
                                        <button type="submit" class="btn btn-danger btn-sm" title="Delete" {% if user.id == request.session.user_id %}disabled{% endif %}>
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if users|length == 0 %}
                        <tr>
                            <td colspan="8" class="text-center empty-state">
                                <div>
                                    <i class="fas fa-users empty-icon"></i>
                                    <p>No users found.</p>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
function showCreateUserForm() {
    const formCard = document.getElementById('userFormCard');
    const usersListCard = document.getElementById('usersListCard');
    const form = document.getElementById('userForm');
    
    // Reset form
    form.reset();
    form.action = '/users/create';
    document.getElementById('user_id').value = '';
    document.getElementById('password').required = true;
    document.getElementById('userInfoAlert').style.display = 'none';
    
    // Update UI text
    document.getElementById('formTitle').textContent = 'Create New User';
    document.getElementById('formIcon').className = 'fas fa-user-plus';
    document.getElementById('submitIcon').className = 'fas fa-user-plus';
    document.getElementById('submitText').textContent = 'Create User';
    document.getElementById('passwordLabel').innerHTML = '<span style="color: var(--danger);">*</span>';
    
    // Hide users table and show form
    usersListCard.style.display = 'none';
    formCard.style.display = 'block';
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function hideUserForm() {
    const formCard = document.getElementById('userFormCard');
    const usersListCard = document.getElementById('usersListCard');
    
    // Hide form and show users table
    formCard.style.display = 'none';
    usersListCard.style.display = 'block';
}

async function editUser(userId) {
    try {
        const response = await fetch(`/api/users/${userId}`);
        if (!response.ok) {
            let body;
            try {
                body = await response.json();
            } catch (e) {
                body = await response.text();
            }
            const msg = (body && body.error) ? body.error : (typeof body === 'string' ? body : response.statusText);
            alert('Error loading user: ' + msg);
            return;
        }

        const user = await response.json();
        
        if (user.error) {
            alert('Error loading user: ' + user.error);
            return;
        }
        
        const formCard = document.getElementById('userFormCard');
        const usersListCard = document.getElementById('usersListCard');
        const form = document.getElementById('userForm');
        
        // Populate the form (guard against missing elements)
        const setIfExists = (id, value) => { const el = document.getElementById(id); if (el) el.value = value; };
        setIfExists('user_id', user.id);
        setIfExists('username', user.username);
        setIfExists('first_name', user.first_name || '');
        setIfExists('last_name', user.last_name || '');
        setIfExists('email', user.email || '');
        setIfExists('email_notifications', user.email_notifications ? 'true' : 'false');
        // Legacy role field (if present) and enabled field may not exist in the form
        const roleEl = document.getElementById('role');
        if (roleEl) { roleEl.value = user.role || 'administrator'; }
        const enabledEl = document.getElementById('enabled');
        if (enabledEl) { enabledEl.value = user.enabled ? 'true' : 'false'; }
        setIfExists('password', '');
        const pwEl = document.getElementById('password'); if (pwEl) pwEl.required = false;
        
        // Populate role checkboxes
        const roleIds = user.role_ids || [];
        const roleCheckboxes = document.querySelectorAll('input[name="role_ids"]');
        roleCheckboxes.forEach(cb => {
            cb.checked = roleIds.includes(parseInt(cb.value));
        });

        // Display read-only info
        document.getElementById('last_login').textContent = user.last_login || 'Never';
        document.getElementById('created_at').textContent = user.created_at || '-';
        document.getElementById('userInfoAlert').style.display = 'block';
        
        // Update UI text
        document.getElementById('formTitle').textContent = 'Edit User';
        document.getElementById('formIcon').className = 'fas fa-user-edit';
        document.getElementById('submitIcon').className = 'fas fa-save';
        document.getElementById('submitText').textContent = 'Save Changes';
        document.getElementById('passwordLabel').innerHTML = '<small style="color: var(--text-secondary);">(leave blank to keep current)</small>';
        
        // Set form action
        form.action = `/users/${userId}/update`;
        
        // Hide users table and show form
        usersListCard.style.display = 'none';
        formCard.style.display = 'block';
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (error) {
        console.error('Error loading user:', error);
        alert('Failed to load user details');
    }
}

// Reveal users UI only after styles have loaded to reduce FOUC
function revealUsers(){
    try{
        var els = document.querySelectorAll('#userFormCard, #usersListCard');
        for(var i=0;i<els.length;i++) els[i].classList.add('visible');
    }catch(e){/* ignore */}
}
if (document.readyState === 'complete') { setTimeout(revealUsers, 50); }
window.addEventListener('load', function(){ setTimeout(revealUsers, 50); });

</script>

{% block extra_css %}
<style>
.roles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 0.75rem;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border);
    border-radius: 0.375rem;
    padding: 1rem;
    background-color: var(--bg-secondary);
}

.role-item {
    margin: 0;
}

.role-checkbox {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 0.25rem;
    transition: background-color 0.2s;
}

.role-checkbox:hover {
    background-color: var(--bg-hover);
}

.role-checkbox input[type="checkbox"] {
    margin-top: 0.125rem;
    flex-shrink: 0;
}

.checkmark {
    width: 1.2rem;
    height: 1.2rem;
    border: 2px solid var(--border);
    border-radius: 0.25rem;
    background-color: var(--bg);
    position: relative;
    flex-shrink: 0;
}

.role-checkbox input[type="checkbox"]:checked + .checkmark {
    background-color: var(--primary);
    border-color: var(--primary);
}

.role-checkbox input[type="checkbox"]:checked + .checkmark::after {
    content: 'âœ“';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 0.8rem;
    font-weight: bold;
}

.role-details {
    flex: 1;
    line-height: 1.4;
}

.role-details strong {
    color: var(--text);
}

.role-details small {
    color: var(--text-secondary);
}
</style>
{% endblock %}

{% endblock %}
