{% extends "base.html" %}

{% block page_title %}Alerts{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<!-- Notification Container -->
<div id="notification-container" style="position: fixed; top: 80px; right: 20px; z-index: 10000; max-width: 400px;"></div>

<!-- Filters Card (Initially Hidden) -->
<div id="filterCard" class="card mb-4" style="display: none;">
    <div class="card-header" style="display: flex; align-items: center; justify-content: space-between;">
        <div class="card-title">
            <i class="fas fa-filter"></i>
            <span>Filter Alerts</span>
        </div>
        <button type="button" class="btn btn-secondary btn-sm" onclick="toggleFilters()" title="Close">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="card-body">
        <form method="get" action="/alerts">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="alert_type" class="form-label">Alert Type</label>
                    <select id="alert_type" name="alert_type" class="form-select">
                        <option value="">All Types</option>
                        <option value="error" {% if alert_type == 'error' %}selected{% endif %}>Errors</option>
                        <option value="warning" {% if alert_type == 'warning' %}selected{% endif %}>Warnings</option>
                        <option value="info" {% if alert_type == 'info' %}selected{% endif %}>Info</option>
                        <option value="success" {% if alert_type == 'success' %}selected{% endif %}>Success</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="show_acknowledged" name="show_acknowledged"
                               {% if show_acknowledged %}checked{% endif %}>
                        <label class="form-check-label" for="show_acknowledged">
                            Show Acknowledged Alerts
                        </label>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-fill">
                            <i class="fas fa-filter"></i>
                            <span>Apply Filters</span>
                        </button>
                        <a href="/alerts" class="btn btn-secondary">
                            <i class="fas fa-times"></i>
                            <span>Clear</span>
                        </a>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-end">
                        <div class="h5 mb-0">{{ unacknowledged_count }}</div>
                        <small class="text-secondary">Unacknowledged</small>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Alerts List Card -->
<div class="card">
    <div class="card-header" style="display: flex; align-items: center; justify-content: space-between;">
        <div class="card-title">
            <i class="fas fa-bell"></i>
            <span>System Alerts</span>
        </div>
        <div class="d-flex gap-2">
            <button id="toggleFilterBtn" class="btn btn-secondary btn-sm" onclick="toggleFilters()">
                <i class="fas fa-filter"></i>
                <span>Filter Alerts</span>
            </button>
            <button class="btn btn-secondary btn-sm" onclick="refreshAlerts()">
                <i class="fas fa-sync-alt"></i>
                <span>Refresh</span>
            </button>
            {% if request.session.role == 'administrator' %}
            <button class="btn btn-primary btn-sm" onclick="createTestAlert()">
                <i class="fas fa-plus"></i>
                <span>Create Test Alert</span>
            </button>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        <!-- Flash Message -->
        {% if flash %}
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            {{ flash }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        {% for alert in alerts %}
        <div class="alert alert-{% if alert.alert_type == 'error' %}danger{% else %}{{ alert.alert_type }}{% endif %} {% if alert.acknowledged %}acknowledged{% endif %}">
            <div class="d-flex align-items-start gap-3">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="alert-badge {{ alert.alert_type }}">{{ alert.alert_type }}</span>
                        <h6 class="mb-0 fw-bold">{{ alert.title }}</h6>
                        {% if alert.acknowledged %}
                        <i class="fas fa-check-circle text-success" title="Acknowledged"></i>
                        {% endif %}
                        {% if alert.email_sent %}
                        <i class="fas fa-envelope text-primary" title="Email sent"></i>
                        {% endif %}
                    </div>
                    <div class="ms-auto">
                        {% if not alert.acknowledged %}
                        <button class="btn btn-sm btn-outline-primary" onclick="acknowledgeAlert({{ alert.id }})">
                            <i class="fas fa-check"></i>
                            <span>Acknowledge</span>
                        </button>
                        {% endif %}
                    </div>
                </div>

                <p class="mb-2">{{ alert.message }}</p>

                {% if alert.details %}
                <details>
                    <summary class="text-secondary" style="cursor: pointer;">Show Details</summary>
                    <pre class="mt-2 p-2 bg-light rounded small">{{ alert.details }}</pre>
                </details>
                {% endif %}

                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-clock"></i>
                        {{ alert.created_at.strftime(date_format) }}
                        {% if alert.acknowledged and alert.acknowledged_at %}
                        â€¢ Acknowledged {{ alert.acknowledged_at.strftime(date_format) }}
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}

        {% if not alerts %}
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-bell-slash fa-3x text-secondary mb-3"></i>
                <h5 class="text-secondary">No alerts found</h5>
                <p class="text-secondary">There are no alerts matching your current filters.</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="?page={{ page - 1 }}{% if alert_type %}&alert_type={{ alert_type }}{% endif %}{% if show_acknowledged %}&show_acknowledged=1{% endif %}" class="page-link">
            <i class="fas fa-chevron-left"></i>
        </a>
        {% endif %}

        {% for page_num in range(max(1, page - 2), min(total_pages + 1, page + 3)) %}
        <a href="?page={{ page_num }}{% if alert_type %}&alert_type={{ alert_type }}{% endif %}{% if show_acknowledged %}&show_acknowledged=1{% endif %}"
           class="page-link {% if page_num == page %}active{% endif %}">{{ page_num }}</a>
        {% endfor %}

        {% if page < total_pages %}
        <a href="?page={{ page + 1 }}{% if alert_type %}&alert_type={{ alert_type }}{% endif %}{% if show_acknowledged %}&show_acknowledged=1{% endif %}" class="page-link">
            <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
// Filter toggle function
window.toggleFilters = function() {
  const filterCard = document.getElementById('filterCard');
  const toggleBtn = document.getElementById('toggleFilterBtn');

  if (filterCard.style.display === 'none') {
    filterCard.style.display = 'block';
    toggleBtn.innerHTML = '<i class="fas fa-times"></i><span>Hide Filters</span>';
  } else {
    filterCard.style.display = 'none';
    toggleBtn.innerHTML = '<i class="fas fa-filter"></i><span>Filter Alerts</span>';
  }
};

// Show filter card if any filters are active
const hasFilters = {{ 'true' if alert_type or show_acknowledged else 'false' }};
if (hasFilters) {
  toggleFilters();
}

// Acknowledge an alert
function acknowledgeAlert(alertId) {
    // Show inline confirmation instead of browser popup
    if (!showInlineConfirmation('Are you sure you want to acknowledge this alert?')) {
        return;
    }

    fetch(`/api/alerts/${alertId}/acknowledge`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Alert acknowledged successfully!', 'success');
            // Refresh the alerts list
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert('Failed to acknowledge alert: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error acknowledging alert:', error);
        showAlert('Error acknowledging alert. Check the console for details.', 'error');
    });
}

// Refresh alerts
function refreshAlerts() {
    window.location.reload();
}

// Auto-refresh unacknowledged count in header
function updateUnacknowledgedBadge() {
    fetch('/api/alerts/unacknowledged-count')
        .then(response => response.json())
        .then(data => {
            const badge = document.querySelector('.nav-link[href="/alerts"] .badge');
            if (badge) {
                if (data.count > 0) {
                    badge.textContent = data.count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        })
        .catch(error => console.error('Error updating badge:', error));
}

// Update badge every 30 seconds
setInterval(updateUnacknowledgedBadge, 30000);

// Create test alert
function createTestAlert() {
    const alertTypes = ['error', 'warning', 'info', 'success'];
    const randomType = alertTypes[Math.floor(Math.random() * alertTypes.length)];

    const testTitles = {
        'error': 'Test Error Alert',
        'warning': 'Test Warning Alert',
        'info': 'Test Info Alert',
        'success': 'Test Success Alert'
    };

    const testMessages = {
        'error': 'This is a test error alert to demonstrate the alerting system.',
        'warning': 'This is a test warning alert to demonstrate the alerting system.',
        'info': 'This is a test info alert to demonstrate the alerting system.',
        'success': 'This is a test success alert to demonstrate the alerting system.'
    };

    const formData = new FormData();
    formData.append('alert_type', randomType);
    formData.append('title', testTitles[randomType]);
    formData.append('message', testMessages[randomType]);
    formData.append('send_email', 'false'); // Don't send email for test alerts

    fetch('/api/alerts', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Test alert created successfully!', 'success');
            setTimeout(() => refreshAlerts(), 1500);
        } else {
            showAlert('Failed to create test alert: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error creating test alert:', error);
        showAlert('Error creating test alert. Check the console for details.', 'error');
    });
}

// Show inline confirmation dialog
function showInlineConfirmation(message) {
    return confirm(message); // For now, keep using confirm but could be replaced with custom modal
}

// Show notification using Bootstrap alerts
function showAlert(message, type = 'info') {
    const container = document.getElementById('notification-container');
    const alertClass = type === 'error' ? 'danger' : type;
    const iconMap = {
        'success': 'check-circle',
        'error': 'exclamation-circle', 
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    };
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${alertClass} alert-dismissible fade show`;
    alert.style.cssText = 'box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 10px;';
    alert.innerHTML = `
        <i class="fas fa-${iconMap[type] || 'info-circle'}"></i>
        <span>${message}</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    container.appendChild(alert);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alert.parentElement) {
            alert.remove();
        }
    }, 5000);
}

function showError(message) {
    showAlert(message, 'error');
}
</script>
{% endblock %}