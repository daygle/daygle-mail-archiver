{% extends "base.html" %}

{% block page_title %}{{ email.subject or "(no subject)" }}{% endblock %}

{% block content %}
<!-- Email Metadata Card -->
<div class="card mb-4">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-envelope-open"></i>
            <span>Email Details</span>
        </div>
        <div class="flex gap-2">
            <a href="/emails" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left"></i>
                <span>Back</span>
            </a>
            <a href="/emails/{{ email.id }}/download" class="btn btn-primary btn-sm">
                <i class="fas fa-download"></i>
                <span>Download EML</span>
            </a>
            {% if request.session.role == 'administrator' %}
            <button type="button" class="btn btn-danger btn-sm" onclick="showDeleteModal()">
                <i class="fas fa-trash"></i>
                <span>Delete</span>
            </button>
            {% endif %}
        </div>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-container">
            <table class="table">
                <tbody>
                    <tr>
                        <td width="120" style="background: var(--bg-secondary); font-weight: 600;">Subject</td>
                        <td><strong>{{ email.subject or "(no subject)" }}</strong></td>
                    </tr>
                    <tr>
                        <td style="background: var(--bg-secondary); font-weight: 600;">From</td>
                        <td>{{ email.sender }}</td>
                    </tr>
                    <tr>
                        <td style="background: var(--bg-secondary); font-weight: 600;">To</td>
                        <td>{{ email.recipients }}</td>
                    </tr>
                    <tr>
                        <td style="background: var(--bg-secondary); font-weight: 600;">Date</td>
                        <td>{{ email.date }}</td>
                    </tr>
                    <tr>
                        <td style="background: var(--bg-secondary); font-weight: 600;">Account</td>
                        <td><span class="badge badge-primary">{{ email.source }}</span></td>
                    </tr>
                    <tr>
                        <td style="background: var(--bg-secondary); font-weight: 600;">Folder</td>
                        <td><span class="badge badge-secondary">{{ email.folder }}</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Headers Card -->
<div class="card mb-4">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-list"></i>
            <span>Email Headers</span>
        </div>
    </div>
    <div class="card-body">
        <pre style="background: var(--bg-secondary); padding: 16px; border-radius: var(--radius-md); overflow-x: auto; font-family: 'Courier New', monospace; font-size: 0.875rem;">
{% for k, v in headers.items() %}
{{ k }}: {{ v }}
{% endfor %}</pre>
    </div>
</div>

<!-- Body Card -->
<div class="card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-file-alt"></i>
            <span>Email Body</span>
        </div>
    </div>
    <div class="card-body">

    <div class="table-responsive mb-3">
        <table class="table table-bordered">
            <tbody>
                <tr>
                    <td width="15%"><strong>From:</strong></td>
                    <td>{{ email.sender }}</td>
                </tr>
                <tr>
                    <td><strong>To:</strong></td>
                    <td>{{ email.recipients }}</td>
                </tr>
                <tr>
                    <td><strong>Date:</strong></td>
                    <td>{{ email.date }}</td>
                </tr>
                <tr>
                    <td><strong>Account:</strong></td>
                    <td>{{ email.source }}</td>
                </tr>
                <tr>
                    <td><strong>Folder:</strong></td>
                    <td>{{ email.folder }}</td>
                </tr>
            </tbody>
        </table>
    </div>

        {% if body.html %}
            <div style="border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; background: white;">
                {{ body.html | safe }}
            </div>
        {% else %}
            <pre style="background: var(--bg-secondary); padding: 16px; border-radius: var(--radius-md); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;">{{ body.text }}</pre>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="hideDeleteModal()"></div>
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
                <h3 style="margin: 0;">Confirm Deletion</h3>
            </div>
            <button class="btn-icon" onclick="hideDeleteModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="alert alert-warning">
                <i class="fas fa-info-circle"></i>
                <span>You are about to delete <strong>1</strong> email.</span>
            </div>

            <p style="margin-top: 20px; margin-bottom: 20px;"><strong>Choose how you want to delete it:</strong></p>

            <form id="delete-form" method="post" action="/emails/delete">
                <input type="hidden" name="ids" value="{{ email.id }}">
                
                <div style="display: grid; gap: 12px; margin-bottom: 20px;">
                    <button type="submit" name="mode" value="db" class="btn btn-danger w-100">
                        <i class="fas fa-database"></i>
                        <span>Delete from Database Only</span>
                    </button>
                    <button type="submit" name="mode" value="imap" class="btn btn-warning w-100">
                        <i class="fas fa-server"></i>
                        <span>Delete from Database and Mail Server</span>
                    </button>
                </div>

                <div class="text-center">
                    <button type="button" class="btn btn-secondary" onclick="hideDeleteModal()">
                        <i class="fas fa-times"></i>
                        <span>Cancel</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}
.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
}
.modal-content {
    position: relative;
    background: var(--bg-primary);
    border-radius: var(--radius-lg);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    z-index: 1;
}
.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
}
.btn-icon {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
}
.btn-icon:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}
</style>

<script>
  function showDeleteModal() {
    document.getElementById('delete-modal').style.display = 'flex';
  }

  function hideDeleteModal() {
    document.getElementById('delete-modal').style.display = 'none';
  }

  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      hideDeleteModal();
    }
  });
</script>

{% endblock %}
