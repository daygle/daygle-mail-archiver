{% extends "base.html" %}

{% block page_title %}Reports{% endblock %}

{% block extra_css %}
<style>
.report-section {
    margin-bottom: 2rem;
}

.report-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.report-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.report-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.report-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 1rem;
}

.table-responsive {
    max-height: 400px;
    overflow-y: auto;
}

.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 0.5rem;
}

.status-online { background-color: #10b981; }
.status-warning { background-color: #f59e0b; }
.status-error { background-color: #ef4444; }
.status-offline { background-color: #6b7280; }

.metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.metric-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1rem;
    text-align: center;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.metric-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Email Volume Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">Email Volume Report</h2>
            <div class="report-controls">
                <select id="emailVolumePeriod" class="form-select form-select-sm me-2">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
                <div class="date-range-controls">
                    <label for="emailVolumeStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="emailVolumeStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="emailVolumeEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="emailVolumeEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshEmailVolume" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="chart-container">
                <canvas id="emailVolumeChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Account Activity Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">Account Activity Report</h2>
            <div class="report-controls">
                <div class="date-range-controls">
                    <label for="accountActivityStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="accountActivityStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="accountActivityEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="accountActivityEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshAccountActivity" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalAccounts">-</div>
                    <div class="metric-label">Total Accounts</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="enabledAccounts">-</div>
                    <div class="metric-label">Enabled Accounts</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="accountsWithErrors">-</div>
                    <div class="metric-label">Accounts with Errors</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="accountActivityChart"></canvas>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Account</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Last Success</th>
                            <th>Emails Today</th>
                            <th>Heartbeat</th>
                        </tr>
                    </thead>
                    <tbody id="accountTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Anti-Virus Statistics Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">Anti-Virus Statistics</h2>
            <div class="report-controls">
                <div class="date-range-controls">
                    <label for="avStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="avStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="avEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="avEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshAVStats" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="cleanEmails">-</div>
                    <div class="metric-label">Clean Emails</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="quarantinedEmails">-</div>
                    <div class="metric-label">Quarantined Emails</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="rejectedEmails">-</div>
                    <div class="metric-label">Rejected Emails</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="avStatsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- System Health Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">System Health Report</h2>
            <div class="report-controls">
                <div class="date-range-controls">
                    <label for="systemHealthStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="systemHealthStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="systemHealthEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="systemHealthEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshSystemHealth" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="databaseSize">-</div>
                    <div class="metric-label">Database Size</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgHeartbeat">-</div>
                    <div class="metric-label">Avg Hours Since Heartbeat</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="errorTrendsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script>
// Disable Chart.js source maps to prevent 404 errors
Chart = undefined; // Clear any existing Chart
</script>
<script src="/static/vendor/chart.min.js"></script>

<script>
// Global chart instances
let emailVolumeChart, accountActivityChart, errorTrendsChart, avStatsChart;

// Initialize charts and load data
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setDefaultDateRanges();
    loadAllReports();
});

// Set default date ranges (last 30 days)
function setDefaultDateRanges() {
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);

    const formatDate = (date) => {
        return date.toISOString().split('T')[0];
    };

    // Set default dates for all date range inputs
    document.getElementById('emailVolumeStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('emailVolumeEndDate').value = formatDate(today);
    document.getElementById('accountActivityStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('accountActivityEndDate').value = formatDate(today);
    document.getElementById('systemHealthStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('systemHealthEndDate').value = formatDate(today);
    document.getElementById('avStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('avEndDate').value = formatDate(today);
}

// Initialize chart instances
function initializeCharts() {
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js library not loaded - script might be blocked or unavailable');
        // Try again in 100ms
        setTimeout(initializeCharts, 100);
        return;
    }

    // Email Volume Chart
    const emailVolumeCtx = document.getElementById('emailVolumeChart');
    if (emailVolumeCtx) {
        emailVolumeChart = new Chart(emailVolumeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Emails',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Virus Detected',
                    data: [],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
    // Account Activity Chart
    const accountActivityCtx = document.getElementById('accountActivityChart').getContext('2d');
    accountActivityChart = new Chart(accountActivityCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Error Trends Chart
    const errorTrendsCtx = document.getElementById('errorTrendsChart').getContext('2d');
    errorTrendsChart = new Chart(errorTrendsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Errors',
                data: [],
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // AV Statistics Chart
    const avStatsCtx = document.getElementById('avStatsChart').getContext('2d');
    avStatsChart = new Chart(avStatsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Clean',
                data: [],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4
            }, {
                label: 'Quarantined',
                data: [],
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4
            }, {
                label: 'Rejected',
                data: [],
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Load all reports
function loadAllReports() {
    loadEmailVolumeReport();
    loadAccountActivityReport();
    loadSystemHealthReport();
    loadAVStatsReport();
}

// Email Volume Report
function loadEmailVolumeReport() {
    const startDate = document.getElementById('emailVolumeStartDate').value;
    const endDate = document.getElementById('emailVolumeEndDate').value;

    if (!startDate || !endDate) {
        console.warn('Start and end dates are required for email volume report');
        return;
    }

    fetch(`/api/reports/email-volume?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            emailVolumeChart.data.labels = data.labels;
            emailVolumeChart.data.datasets[0].data = data.email_counts;
            emailVolumeChart.data.datasets[1].data = data.virus_counts;
            emailVolumeChart.update();
        })
        .catch(error => console.error('Error loading email volume report:', error));
}

// Account Activity Report
function loadAccountActivityReport() {
    const startDate = document.getElementById('accountActivityStartDate').value;
    const endDate = document.getElementById('accountActivityEndDate').value;

    if (!startDate || !endDate) {
        console.warn('Start and end dates are required for account activity report');
        return;
    }

    fetch(`/api/reports/account-activity?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            // Update metrics
            document.getElementById('totalAccounts').textContent = data.accounts.length;
            document.getElementById('enabledAccounts').textContent = data.accounts.filter(a => a.enabled).length;
            document.getElementById('accountsWithErrors').textContent = data.accounts.filter(a => a.last_error).length;

            // Update chart
            accountActivityChart.data.labels = data.trend_labels;
            accountActivityChart.data.datasets = data.trend_datasets.map((dataset, index) => ({
                label: dataset.label,
                data: dataset.data,
                borderColor: `hsl(${(index * 137) % 360}, 70%, 50%)`,
                backgroundColor: `hsla(${(index * 137) % 360}, 70%, 50%, 0.1)`,
                tension: 0.4
            }));
            accountActivityChart.update();

            // Update table
            const tbody = document.getElementById('accountTableBody');
            tbody.innerHTML = data.accounts.map(account => {
                let statusClass = 'status-offline';
                let statusText = 'Offline';
                if (account.enabled) {
                    if (account.hours_since_heartbeat < 1) {
                        statusClass = 'status-online';
                        statusText = 'Online';
                    } else if (account.hours_since_heartbeat < 24) {
                        statusClass = 'status-warning';
                        statusText = 'Warning';
                    } else {
                        statusClass = 'status-error';
                        statusText = 'Error';
                    }
                }

                return `
                    <tr>
                        <td>${account.name}</td>
                        <td>${account.type.toUpperCase()}</td>
                        <td><span class="status-indicator ${statusClass}"></span>${statusText}</td>
                        <td>${account.last_success || 'Never'}</td>
                        <td>${account.emails_today}</td>
                        <td>${account.hours_since_heartbeat}h ago</td>
                    </tr>
                `;
            }).join('');
        })
        .catch(error => console.error('Error loading account activity report:', error));
}

// System Health Report
function loadSystemHealthReport() {
    const startDate = document.getElementById('systemHealthStartDate').value;
    const endDate = document.getElementById('systemHealthEndDate').value;

    if (!startDate || !endDate) {
        console.warn('Start and end dates are required for system health report');
        return;
    }

    fetch(`/api/reports/system-health?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            // Update metrics
            document.getElementById('databaseSize').textContent = data.database_size;
            document.getElementById('avgHeartbeat').textContent = `${data.worker_stats.avg_hours_since_heartbeat}h`;

            // Update chart
            errorTrendsChart.data.labels = data.error_labels;
            errorTrendsChart.data.datasets[0].data = data.error_counts;
            errorTrendsChart.update();
        })
        .catch(error => console.error('Error loading system health report:', error));
}

// Anti-Virus Statistics Report
function loadAVStatsReport() {
    const startDate = document.getElementById('avStartDate').value;
    const endDate = document.getElementById('avEndDate').value;

    if (!startDate || !endDate) {
        console.warn('Start and end dates are required for AV statistics report');
        return;
    }

    fetch(`/api/reports/av-stats?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            // Update metrics
            document.getElementById('cleanEmails').textContent = data.clean_emails;
            document.getElementById('quarantinedEmails').textContent = data.quarantined_emails;
            document.getElementById('rejectedEmails').textContent = data.rejected_emails;

            // Update chart if it exists
            if (avStatsChart) {
                avStatsChart.data.labels = data.labels;
                avStatsChart.data.datasets[0].data = data.clean_counts;
                avStatsChart.data.datasets[1].data = data.quarantined_counts;
                avStatsChart.data.datasets[2].data = data.rejected_counts;
                avStatsChart.update();
            }
        })
        .catch(error => console.error('Error loading AV statistics report:', error));
}

// Event listeners for refresh buttons
document.getElementById('refreshEmailVolume').addEventListener('click', loadEmailVolumeReport);
document.getElementById('refreshAccountActivity').addEventListener('click', loadAccountActivityReport);
document.getElementById('refreshSystemHealth').addEventListener('click', loadSystemHealthReport);
document.getElementById('refreshAVStats').addEventListener('click', loadAVStatsReport);

// Event listeners for date changes
document.getElementById('emailVolumeStartDate').addEventListener('change', loadEmailVolumeReport);
document.getElementById('emailVolumeEndDate').addEventListener('change', loadEmailVolumeReport);
document.getElementById('accountActivityStartDate').addEventListener('change', loadAccountActivityReport);
document.getElementById('accountActivityEndDate').addEventListener('change', loadAccountActivityReport);
document.getElementById('systemHealthStartDate').addEventListener('change', loadSystemHealthReport);
document.getElementById('systemHealthEndDate').addEventListener('change', loadSystemHealthReport);
document.getElementById('avStartDate').addEventListener('change', loadAVStatsReport);
document.getElementById('avEndDate').addEventListener('change', loadAVStatsReport);
</script>
{% endblock %}