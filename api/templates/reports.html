{% extends "base.html" %}

{% block page_title %}Reports{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Email Volume Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">Email Volume Report</h2>
            <div class="report-controls">
                <select id="emailVolumePeriod" class="form-select form-select-sm me-2">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
                <div class="date-range-controls">
                    <label for="emailVolumeStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="emailVolumeStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="emailVolumeEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="emailVolumeEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshEmailVolume" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="chart-container">
                <canvas id="emailVolumeChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Account Activity Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">Account Activity Report</h2>
            <div class="report-controls">
                <div class="date-range-controls">
                    <label for="accountActivityStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="accountActivityStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="accountActivityEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="accountActivityEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshAccountActivity" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalAccounts">-</div>
                    <div class="metric-label">Total Accounts</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="enabledAccounts">-</div>
                    <div class="metric-label">Enabled Accounts</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="accountsWithErrors">-</div>
                    <div class="metric-label">Accounts with Errors</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="accountActivityChart"></canvas>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Account</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Last Success</th>
                            <th>Emails Today</th>
                            <th>Heartbeat</th>
                        </tr>
                    </thead>
                    <tbody id="accountTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Anti-Virus Statistics Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">Anti-Virus Statistics</h2>
            <div class="report-controls">
                <div class="date-range-controls">
                    <label for="avStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="avStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="avEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="avEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshAVStats" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="cleanEmails">-</div>
                    <div class="metric-label">Clean Emails</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="quarantinedEmails">-</div>
                    <div class="metric-label">Quarantined Emails</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="rejectedEmails">-</div>
                    <div class="metric-label">Rejected Emails</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="avStatsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- System Health Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">System Health Report</h2>
            <div class="report-controls">
                <div class="date-range-controls">
                    <label for="systemHealthStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="systemHealthStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="systemHealthEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="systemHealthEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshSystemHealth" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="databaseSize">-</div>
                    <div class="metric-label">Database Size</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgHeartbeat">-</div>
                    <div class="metric-label">Avg Hours Since Heartbeat</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="errorTrendsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script>
// Disable Chart.js source maps to prevent 404 errors
Chart = undefined; // Clear any existing Chart
</script>
<script src="/static/vendor/chart.min.js"></script>

<script>
// Global chart instances - updated 2026-01-08
let emailVolumeChart, accountActivityChart, errorTrendsChart, avStatsChart;

// Initialize charts and load data
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setDefaultDateRanges();
    loadAllReports();
});

// Utility: show a report-level message (e.g., validation)
function showReportMessageForInput(inputEl, message, type = 'warning') {
    // Find the containing report-card
    const section = inputEl.closest('.report-section');
    if (!section) return;
    const card = section.querySelector('.report-card');
    if (!card) return;

    // Remove existing message
    const existing = card.querySelector('.report-message');
    if (existing) existing.remove();

    const div = document.createElement('div');
    div.className = `alert alert-${type} report-message`;
    div.style.margin = '0 0 1rem 0';
    div.textContent = message;

    card.insertBefore(div, card.firstChild);
}

function clearReportMessageForInput(inputEl) {
    const section = inputEl.closest('.report-section');
    if (!section) return;
    const card = section.querySelector('.report-card');
    if (!card) return;
    const existing = card.querySelector('.report-message');
    if (existing) existing.remove();
}

// Set default date ranges (last 30 days)
function setDefaultDateRanges() {
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);

    const formatDate = (date) => {
        return date.toISOString().split('T')[0];
    };

    // Set default dates for all date range inputs
    document.getElementById('emailVolumeStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('emailVolumeEndDate').value = formatDate(today);
    document.getElementById('accountActivityStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('accountActivityEndDate').value = formatDate(today);
    document.getElementById('systemHealthStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('systemHealthEndDate').value = formatDate(today);
    document.getElementById('avStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('avEndDate').value = formatDate(today);
}

// Initialize chart instances
function initializeCharts() {
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js library not loaded - script might be blocked or unavailable');
        // Try again in 100ms
        setTimeout(initializeCharts, 100);
        return;
    }

    // Email Volume Chart
    const emailVolumeCtx = document.getElementById('emailVolumeChart');
    if (emailVolumeCtx) {
        emailVolumeChart = new Chart(emailVolumeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Emails',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
    // Account Activity Chart
    const accountActivityCtx = document.getElementById('accountActivityChart').getContext('2d');
    accountActivityChart = new Chart(accountActivityCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Error Trends Chart
    const errorTrendsCtx = document.getElementById('errorTrendsChart').getContext('2d');
    errorTrendsChart = new Chart(errorTrendsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Errors',
                data: [],
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // AV Statistics Chart
    const avStatsCtx = document.getElementById('avStatsChart');
    if (avStatsCtx) {
        avStatsChart = new Chart(avStatsCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Clean',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Quarantined',
                    data: [],
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Rejected',
                    data: [],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    } else {
        console.error('avStatsCtx not found');
    }
}

// Load all reports
function loadAllReports() {
    loadEmailVolumeReport();
    loadAccountActivityReport();
    loadSystemHealthReport();
    loadAVStatsReport();
}

// Email Volume Report
function loadEmailVolumeReport() {
    const startDate = document.getElementById('emailVolumeStartDate').value;
    const endDate = document.getElementById('emailVolumeEndDate').value;

    if (!startDate || !endDate) {
        console.warn('Start and end dates are required for email volume report');
        return;
    }

    // Validate date range
    if (new Date(startDate) > new Date(endDate)) {
        showReportMessageForInput(document.getElementById('emailVolumeStartDate'), 'Invalid date range: start date must be on or before end date', 'warning');
        return;
    } else {
        clearReportMessageForInput(document.getElementById('emailVolumeStartDate'));
    }

    fetch(`/api/reports/email-volume?start_date=${startDate}&end_date=${endDate}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            // Clear any previous validation messages for this section
            clearReportMessageForInput(document.getElementById('emailVolumeStartDate'));

            // Defensive programming: ensure data structure exists
            if (!data || typeof data !== 'object') {
                console.error('Invalid response data:', data);
                return;
            }

            // Update chart with safe defaults
            const labels = Array.isArray(data.labels) ? data.labels : [];
            const emailCounts = Array.isArray(data.email_counts) ? data.email_counts : [];

            emailVolumeChart.data.labels = labels;
            emailVolumeChart.data.datasets[0].data = emailCounts;
            emailVolumeChart.update();
        })
        .catch(error => {
            console.error('Error loading email volume report:', error);
            // Could add user notification here if needed
        });
}

// Account Activity Report
function loadAccountActivityReport() {
    const startDate = document.getElementById('accountActivityStartDate').value;
    const endDate = document.getElementById('accountActivityEndDate').value;

    if (!startDate || !endDate) {
        console.warn('Start and end dates are required for account activity report');
        return;
    }

    // Validate date range
    if (new Date(startDate) > new Date(endDate)) {
        showReportMessageForInput(document.getElementById('accountActivityStartDate'), 'Invalid date range: start date must be on or before end date', 'warning');
        return;
    } else {
        clearReportMessageForInput(document.getElementById('accountActivityStartDate'));
    }

    fetch(`/api/reports/account-activity?start_date=${startDate}&end_date=${endDate}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            // Clear any previous validation messages for this section
            clearReportMessageForInput(document.getElementById('accountActivityStartDate'));

            // Defensive programming: ensure data structure exists
            if (!data || typeof data !== 'object') {
                console.error('Invalid response data:', data);
                return;
            }

            // Update metrics with safe defaults
            const accounts = Array.isArray(data.accounts) ? data.accounts : [];
            document.getElementById('totalAccounts').textContent = accounts.length;
            document.getElementById('enabledAccounts').textContent = accounts.filter(a => a && a.enabled).length;
            document.getElementById('accountsWithErrors').textContent = accounts.filter(a => a && a.last_error).length;

            // Update chart with safe defaults
            const trendLabels = Array.isArray(data.trend_labels) ? data.trend_labels : [];
            const trendDatasets = Array.isArray(data.trend_datasets) ? data.trend_datasets : [];

            accountActivityChart.data.labels = trendLabels;
            accountActivityChart.data.datasets = trendDatasets.map((dataset, index) => ({
                label: dataset && dataset.label ? dataset.label : `Dataset ${index + 1}`,
                data: Array.isArray(dataset.data) ? dataset.data : [],
                borderColor: `hsl(${(index * 137) % 360}, 70%, 50%)`,
                backgroundColor: `hsla(${(index * 137) % 360}, 70%, 50%, 0.1)`,
                tension: 0.4
            }));
            accountActivityChart.update();

            // Update table with safe account data
            const tbody = document.getElementById('accountTableBody');
            tbody.innerHTML = accounts.map(account => {
                if (!account || typeof account !== 'object') {
                    return '<tr><td colspan="6">Invalid account data</td></tr>';
                }

                let statusClass = 'status-offline';
                let statusText = 'Offline';
                if (account.enabled) {
                    const hoursSinceHeartbeat = typeof account.hours_since_heartbeat === 'number' ? account.hours_since_heartbeat : 999;
                    if (hoursSinceHeartbeat < 1) {
                        statusClass = 'status-online';
                        statusText = 'Online';
                    } else if (hoursSinceHeartbeat < 24) {
                        statusClass = 'status-warning';
                        statusText = 'Warning';
                    } else {
                        statusClass = 'status-error';
                        statusText = 'Error';
                    }
                }

                return `
                    <tr>
                        <td>${account.name || 'Unknown'}</td>
                        <td>${account.type ? account.type.toUpperCase() : 'UNKNOWN'}</td>
                        <td><span class="status-indicator ${statusClass}"></span>${statusText}</td>
                        <td>${account.last_success || 'Never'}</td>
                        <td>${typeof account.emails_today === 'number' ? account.emails_today : 0}</td>
                        <td>${typeof account.hours_since_heartbeat === 'number' ? account.hours_since_heartbeat + 'h ago' : 'Unknown'}</td>
                    </tr>
                `;
            }).join('');
        })
        .catch(error => {
            console.error('Error loading account activity report:', error);
            // Show user-friendly error message
            const tbody = document.getElementById('accountTableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="color: var(--danger);">Failed to load account activity report. Please try again.</td></tr>';
        });
}

// System Health Report
function loadSystemHealthReport() {
    const startDate = document.getElementById('systemHealthStartDate').value;
    const endDate = document.getElementById('systemHealthEndDate').value;

    if (!startDate || !endDate) {
        console.warn('Start and end dates are required for system health report');
        return;
    }

    // Validate date range
    if (new Date(startDate) > new Date(endDate)) {
        showReportMessageForInput(document.getElementById('systemHealthStartDate'), 'Invalid date range: start date must be on or before end date', 'warning');
        return;
    } else {
        clearReportMessageForInput(document.getElementById('systemHealthStartDate'));
    }

    fetch(`/api/reports/system-health?start_date=${startDate}&end_date=${endDate}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            // Clear any previous validation messages for this section
            clearReportMessageForInput(document.getElementById('systemHealthStartDate'));

            // Defensive programming: ensure data structure exists
            if (!data || typeof data !== 'object') {
                console.error('Invalid response data:', data);
                return;
            }

            // Update metrics with safe defaults
            document.getElementById('databaseSize').textContent = data.database_size || 'Unknown';
            const avgHeartbeat = data.worker_stats && typeof data.worker_stats.avg_hours_since_heartbeat === 'number'
                ? data.worker_stats.avg_hours_since_heartbeat
                : 0;
            document.getElementById('avgHeartbeat').textContent = `${avgHeartbeat}h`;

            // Update chart with safe defaults
            const errorLabels = Array.isArray(data.error_labels) ? data.error_labels : [];
            const errorCounts = Array.isArray(data.error_counts) ? data.error_counts : [];

            errorTrendsChart.data.labels = errorLabels;
            errorTrendsChart.data.datasets[0].data = errorCounts;
            errorTrendsChart.update();
        })
        .catch(error => {
            console.error('Error loading system health report:', error);
            // Could add user notification here if needed
        });
}

// Anti-Virus Statistics Report
function loadAVStatsReport() {
    const startDate = document.getElementById('avStartDate').value;
    const endDate = document.getElementById('avEndDate').value;

    if (!startDate || !endDate) {
        console.warn('Start and end dates are required for AV statistics report');
        return;
    }

    // Validate date range
    if (new Date(startDate) > new Date(endDate)) {
        showReportMessageForInput(document.getElementById('avStartDate'), 'Invalid date range: start date must be on or before end date', 'warning');
        return;
    } else {
        clearReportMessageForInput(document.getElementById('avStartDate'));
    }

    fetch(`/api/reports/av-stats?start_date=${startDate}&end_date=${endDate}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            // Clear any previous validation messages for this section
            clearReportMessageForInput(document.getElementById('avStartDate'));

            // Defensive programming: ensure data structure exists
            if (!data || typeof data !== 'object') {
                console.error('Invalid response data:', data);
                return;
            }

            // Update metrics with safe defaults
            document.getElementById('cleanEmails').textContent = typeof data.clean_emails === 'number' ? data.clean_emails : 0;
            document.getElementById('quarantinedEmails').textContent = typeof data.quarantined_emails === 'number' ? data.quarantined_emails : 0;
            document.getElementById('rejectedEmails').textContent = typeof data.rejected_emails === 'number' ? data.rejected_emails : 0;

            // Update chart if it exists
            if (avStatsChart) {
                const labels = Array.isArray(data.labels) ? data.labels : [];
                const cleanCounts = Array.isArray(data.clean_counts) ? data.clean_counts : [];
                const quarantinedCounts = Array.isArray(data.quarantined_counts) ? data.quarantined_counts : [];
                const rejectedCounts = Array.isArray(data.rejected_counts) ? data.rejected_counts : [];

                avStatsChart.data.labels = labels;
                avStatsChart.data.datasets[0].data = cleanCounts;
                avStatsChart.data.datasets[1].data = quarantinedCounts;
                avStatsChart.data.datasets[2].data = rejectedCounts;
                avStatsChart.update();
            }
        })
        .catch(error => {
            console.error('Error loading AV statistics report:', error);
            // Could add user notification here if needed
        });
}

// Event listeners for refresh buttons
document.getElementById('refreshEmailVolume').addEventListener('click', loadEmailVolumeReport);
document.getElementById('refreshAccountActivity').addEventListener('click', loadAccountActivityReport);
document.getElementById('refreshSystemHealth').addEventListener('click', loadSystemHealthReport);
document.getElementById('refreshAVStats').addEventListener('click', loadAVStatsReport);

// Event listeners for date changes
document.getElementById('emailVolumeStartDate').addEventListener('change', loadEmailVolumeReport);
document.getElementById('emailVolumeEndDate').addEventListener('change', loadEmailVolumeReport);
document.getElementById('accountActivityStartDate').addEventListener('change', loadAccountActivityReport);
document.getElementById('accountActivityEndDate').addEventListener('change', loadAccountActivityReport);
document.getElementById('systemHealthStartDate').addEventListener('change', loadSystemHealthReport);
document.getElementById('systemHealthEndDate').addEventListener('change', loadSystemHealthReport);
document.getElementById('avStartDate').addEventListener('change', loadAVStatsReport);
document.getElementById('avEndDate').addEventListener('change', loadAVStatsReport);
</script>
{% endblock %}