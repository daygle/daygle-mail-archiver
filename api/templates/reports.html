{% extends "base.html" %}

{% block page_title %}Reports{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Email Volume Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">Email Volume Report</h2>
            <div class="report-controls">
                <select id="emailVolumePeriod" class="form-select form-select-sm me-2">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
                <div class="date-range-controls">
                    <label for="emailVolumeStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="emailVolumeStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="emailVolumeEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="emailVolumeEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshEmailVolume" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="chart-container">
                <canvas id="emailVolumeChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Account Activity Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">Account Activity Report</h2>
            <div class="report-controls">
                <div class="date-range-controls">
                    <label for="accountActivityStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="accountActivityStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="accountActivityEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="accountActivityEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshAccountActivity" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalAccounts">-</div>
                    <div class="metric-label">Total Accounts</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="enabledAccounts">-</div>
                    <div class="metric-label">Enabled Accounts</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="accountsWithErrors">-</div>
                    <div class="metric-label">Accounts with Errors</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="accountActivityChart"></canvas>
            </div>
            <div class="table-responsive">
                <table class="table table-striped account-activity-table">
                    <thead>
                        <tr>
                            <th>Account</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Last Success</th>
                            <th>Emails Today</th>
                            <th>Heartbeat</th>
                        </tr>
                    </thead>
                    <tbody id="accountTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Anti-Virus Statistics Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">Anti-Virus Statistics</h2>
            <div class="report-controls">
                <div class="date-range-controls">
                    <label for="avStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="avStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="avEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="avEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshAVStats" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="cleanEmails">-</div>
                    <div class="metric-label">Clean Emails</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="quarantinedEmails">-</div>
                    <div class="metric-label">Quarantined Emails</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="rejectedEmails">-</div>
                    <div class="metric-label">Rejected Emails</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="avStatsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- System Health Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">System Health Report</h2>
            <div class="report-controls">
                <div class="date-range-controls">
                    <label for="systemHealthStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="systemHealthStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="systemHealthEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="systemHealthEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshSystemHealth" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="databaseSize">-</div>
                    <div class="metric-label">Database Size</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgHeartbeat">-</div>
                    <div class="metric-label">Avg Hours Since Heartbeat</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="errorTrendsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Storage Utilization Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">Storage Utilization Report</h2>
            <div class="report-controls">
                <div class="date-range-controls">
                    <label for="storageStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="storageStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="storageEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="storageEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshStorageUtilization" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalStorage">-</div>
                    <div class="metric-label">Total Storage Used</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgEmailSize">-</div>
                    <div class="metric-label">Avg Email Size</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="compressionRatio">-</div>
                    <div class="metric-label">Compression Savings</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalEmails">-</div>
                    <div class="metric-label">Total Emails</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="storageTrendsChart"></canvas>
            </div>
            <div class="table-responsive mt-4">
                <h5>Largest Emails</h5>
                <table class="table table-striped largest-emails-table">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Sender</th>
                            <th>Size</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="largestEmailsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Retention Policy Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">Retention Policy Effectiveness</h2>
            <div class="report-controls">
                <div class="date-range-controls">
                    <label for="retentionStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="retentionStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="retentionEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="retentionEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshRetentionPolicy" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalManualDeletions">-</div>
                    <div class="metric-label">Manual Deletions</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalRetentionDeletions">-</div>
                    <div class="metric-label">Retention Deletions</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalServerDeletions">-</div>
                    <div class="metric-label">Deleted from Server</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="retentionChart"></canvas>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <h5>Current Email Age Distribution</h5>
                    <div class="table-responsive">
                        <table class="table table-striped age-distribution-table">
                            <thead>
                                <tr>
                                    <th>Age Range</th>
                                    <th>Email Count</th>
                                </tr>
                            </thead>
                            <tbody id="ageDistributionTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>Retention Policy Settings</h5>
                    <div class="settings-display" id="retentionSettingsDisplay">
                        <p>Loading settings...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Performance Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">System Performance Report</h2>
            <div class="report-controls">
                <div class="date-range-controls">
                    <label for="performanceStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="performanceStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="performanceEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="performanceEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshSystemPerformance" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="currentActiveWorkers">-</div>
                    <div class="metric-label">Active Workers</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="currentTotalWorkers">-</div>
                    <div class="metric-label">Total Workers</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgProcessingRate">-</div>
                    <div class="metric-label">Avg Emails/Hour</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
            <div class="chart-container mt-4">
                <canvas id="workerActivityChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Security & Access Report (Admin Only) -->
    <div class="report-section" id="securityReportSection" style="display: none;">
        <div class="report-header">
            <h2 class="report-title">Security & Access Report</h2>
            <div class="report-controls">
                <div class="date-range-controls">
                    <label for="securityStartDate" class="form-label me-2">From:</label>
                    <input type="date" id="securityStartDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <label for="securityEndDate" class="form-label mx-2">To:</label>
                    <input type="date" id="securityEndDate" class="form-control form-control-sm d-inline-block" style="width: auto;">
                    <button id="refreshSecurityAccess" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="report-card">
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalSuccessfulLogins">-</div>
                    <div class="metric-label">Successful Logins</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalFailedLogins">-</div>
                    <div class="metric-label">Failed Login Attempts</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalPasswordChanges">-</div>
                    <div class="metric-label">Password Changes</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="securityChart"></canvas>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <h5>Recent Security Events (Last 24h)</h5>
                    <div class="table-responsive">
                        <table class="table table-striped security-events-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Level</th>
                                    <th>Event</th>
                                </tr>
                            </thead>
                            <tbody id="securityEventsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>User Activity Summary</h5>
                    <div class="table-responsive">
                        <table class="table table-striped user-activity-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Last Login</th>
                                    <th>Recent Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userActivityTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Quality Report -->
    <div class="report-section">
        <div class="report-header">
            <h2 class="report-title">Data Quality Report</h2>
            <button id="refreshDataQuality" class="btn btn-outline-primary btn-sm ms-2">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        <div class="report-card">
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value" id="dataCompleteness">-</div>
                    <div class="metric-label">Data Completeness</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="scanCoverage">-</div>
                    <div class="metric-label">Virus Scan Coverage</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="potentialDuplicates">-</div>
                    <div class="metric-label">Potential Duplicates</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="errorRate">-</div>
                    <div class="metric-label">System Error Rate</div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <h5>Email Size Distribution</h5>
                    <div class="chart-container">
                        <canvas id="sizeDistributionChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>Data Completeness Details</h5>
                    <div class="table-responsive">
                        <table class="table table-striped completeness-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody id="completenessTableBody">
                                <tr><td>Missing Subjects</td><td id="missingSubjectsPercent">-</td></tr>
                                <tr><td>Missing Senders</td><td id="missingSendersPercent">-</td></tr>
                                <tr><td>Missing Recipients</td><td id="missingRecipientsPercent">-</td></tr>
                                <tr><td>Unscanned Emails</td><td id="unscannedPercent">-</td></tr>
                                <tr><td>Virus Detected</td><td id="virusDetectedPercent">-</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script>
// Disable Chart.js source maps to prevent 404 errors
Chart = undefined; // Clear any existing Chart
</script>
<script src="/static/vendor/chart.min.js"></script>

<script>
// Global chart instances - updated 2026-01-08
let emailVolumeChart, accountActivityChart, errorTrendsChart, avStatsChart;

// Initialise chart variables on window to prevent undefined errors
window.storageTrendsChart = null;
window.retentionChart = null;
window.performanceChart = null;
window.workerActivityChart = null;
window.securityChart = null;
window.sizeDistributionChart = null;

// Initialise charts and load data
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setDefaultDateRanges();
    // Small delay to ensure dates are set before loading reports
    setTimeout(loadAllReports, 100);
});

// Utility: show a report-level message (e.g., validation)
function showReportMessageForInput(inputEl, message, type = 'warning') {
    // Find the containing report-card
    const section = inputEl.closest('.report-section');
    if (!section) return;
    const card = section.querySelector('.report-card');
    if (!card) return;

    // Remove existing message
    const existing = card.querySelector('.report-message');
    if (existing) existing.remove();

    const div = document.createElement('div');
    div.className = `alert alert-${type} report-message`;
    div.style.margin = '0 0 1rem 0';
    div.textContent = message;

    card.insertBefore(div, card.firstChild);
}

function clearReportMessageForInput(inputEl) {
    const section = inputEl.closest('.report-section');
    if (!section) return;
    const card = section.querySelector('.report-card');
    if (!card) return;
    const existing = card.querySelector('.report-message');
    if (existing) existing.remove();
}

// Set default date ranges (last 30 days)
function setDefaultDateRanges() {
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);

    const formatDate = (date) => {
        return date.toISOString().split('T')[0];
    };

    // Set default dates for all date range inputs
    document.getElementById('emailVolumeStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('emailVolumeEndDate').value = formatDate(today);
    document.getElementById('accountActivityStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('accountActivityEndDate').value = formatDate(today);
    document.getElementById('systemHealthStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('systemHealthEndDate').value = formatDate(today);
    document.getElementById('avStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('avEndDate').value = formatDate(today);
    
    // Set default dates for new reports
    document.getElementById('storageStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('storageEndDate').value = formatDate(today);
    document.getElementById('retentionStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('retentionEndDate').value = formatDate(today);
    document.getElementById('performanceStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('performanceEndDate').value = formatDate(today);
    document.getElementById('securityStartDate').value = formatDate(thirtyDaysAgo);
    document.getElementById('securityEndDate').value = formatDate(today);
}

// Initialise chart instances
function initializeCharts() {
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js library not loaded - script might be blocked or unavailable');
        // Try again in 100ms
        setTimeout(initializeCharts, 100);
        return;
    }

    // Email Volume Chart
    const emailVolumeCtx = document.getElementById('emailVolumeChart');
    if (emailVolumeCtx) {
        emailVolumeChart = new Chart(emailVolumeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Emails',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
    // Account Activity Chart
    const accountActivityCtx = document.getElementById('accountActivityChart').getContext('2d');
    accountActivityChart = new Chart(accountActivityCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Error Trends Chart
    const errorTrendsCtx = document.getElementById('errorTrendsChart').getContext('2d');
    errorTrendsChart = new Chart(errorTrendsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Errors',
                data: [],
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // AV Statistics Chart
    const avStatsCtx = document.getElementById('avStatsChart');
    if (avStatsCtx) {
        avStatsChart = new Chart(avStatsCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Clean',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Quarantined',
                    data: [],
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Rejected',
                    data: [],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    } else {
        console.error('avStatsCtx not found');
    }
}

// Load all reports
function loadAllReports() {
    loadEmailVolumeReport();
    loadAccountActivityReport();
    loadSystemHealthReport();
    loadAVStatsReport();
    loadStorageUtilizationReport();
    loadRetentionPolicyReport();
    loadSystemPerformanceReport();
    loadDataQualityReport();
}

// Email Volume Report
function loadEmailVolumeReport() {
    let startDate = document.getElementById('emailVolumeStartDate').value;
    let endDate = document.getElementById('emailVolumeEndDate').value;

    // Set default dates if not provided
    if (!startDate || !endDate) {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        const formatDate = (date) => date.toISOString().split('T')[0];
        
        if (!startDate) {
            startDate = formatDate(thirtyDaysAgo);
            document.getElementById('emailVolumeStartDate').value = startDate;
        }
        if (!endDate) {
            endDate = formatDate(today);
            document.getElementById('emailVolumeEndDate').value = endDate;
        }
    }

    // Validate date range
    if (new Date(startDate) > new Date(endDate)) {
        showReportMessageForInput(document.getElementById('emailVolumeStartDate'), 'Invalid date range: start date must be on or before end date', 'warning');
        return;
    } else {
        clearReportMessageForInput(document.getElementById('emailVolumeStartDate'));
    }

    fetch(`/api/reports/email-volume?start_date=${startDate}&end_date=${endDate}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            // Clear any previous validation messages for this section
            clearReportMessageForInput(document.getElementById('emailVolumeStartDate'));

            // Defensive programming: ensure data structure exists
            if (!data || typeof data !== 'object') {
                console.error('Invalid response data:', data);
                return;
            }

            // Update chart with safe defaults
            const labels = Array.isArray(data.labels) ? data.labels : [];
            const emailCounts = Array.isArray(data.email_counts) ? data.email_counts : [];

            emailVolumeChart.data.labels = labels;
            emailVolumeChart.data.datasets[0].data = emailCounts;
            emailVolumeChart.update();
        })
        .catch(error => {
            console.error('Error loading email volume report:', error);
            // Could add user notification here if needed
        });
}

// Account Activity Report
function loadAccountActivityReport() {
    let startDate = document.getElementById('accountActivityStartDate').value;
    let endDate = document.getElementById('accountActivityEndDate').value;

    // Set default dates if not provided
    if (!startDate || !endDate) {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        const formatDate = (date) => date.toISOString().split('T')[0];
        
        if (!startDate) {
            startDate = formatDate(thirtyDaysAgo);
            document.getElementById('accountActivityStartDate').value = startDate;
        }
        if (!endDate) {
            endDate = formatDate(today);
            document.getElementById('accountActivityEndDate').value = endDate;
        }
    }

    // Validate date range
    if (new Date(startDate) > new Date(endDate)) {
        showReportMessageForInput(document.getElementById('accountActivityStartDate'), 'Invalid date range: start date must be on or before end date', 'warning');
        return;
    } else {
        clearReportMessageForInput(document.getElementById('accountActivityStartDate'));
    }

    fetch(`/api/reports/account-activity?start_date=${startDate}&end_date=${endDate}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            // Clear any previous validation messages for this section
            clearReportMessageForInput(document.getElementById('accountActivityStartDate'));

            // Defensive programming: ensure data structure exists
            if (!data || typeof data !== 'object') {
                console.error('Invalid response data:', data);
                return;
            }

            // Update metrics with safe defaults
            const accounts = Array.isArray(data.accounts) ? data.accounts : [];
            document.getElementById('totalAccounts').textContent = accounts.length;
            document.getElementById('enabledAccounts').textContent = accounts.filter(a => a && a.enabled).length;
            document.getElementById('accountsWithErrors').textContent = accounts.filter(a => a && a.last_error).length;

            // Update chart with safe defaults
            const trendLabels = Array.isArray(data.trend_labels) ? data.trend_labels : [];
            const trendDatasets = Array.isArray(data.trend_datasets) ? data.trend_datasets : [];

            accountActivityChart.data.labels = trendLabels;
            accountActivityChart.data.datasets = trendDatasets.map((dataset, index) => ({
                label: dataset && dataset.label ? dataset.label : `Dataset ${index + 1}`,
                data: Array.isArray(dataset.data) ? dataset.data : [],
                borderColor: `hsl(${(index * 137) % 360}, 70%, 50%)`,
                backgroundColor: `hsla(${(index * 137) % 360}, 70%, 50%, 0.1)`,
                tension: 0.4
            }));
            accountActivityChart.update();

            // Update table with safe account data
            const tbody = document.getElementById('accountTableBody');
            tbody.innerHTML = accounts.map(account => {
                if (!account || typeof account !== 'object') {
                    return '<tr><td colspan="6">Invalid account data</td></tr>';
                }

                let statusClass = 'status-offline';
                let statusText = 'Offline';
                if (account.enabled) {
                    const hoursSinceHeartbeat = typeof account.hours_since_heartbeat === 'number' ? account.hours_since_heartbeat : 999;
                    if (hoursSinceHeartbeat < 1) {
                        statusClass = 'status-online';
                        statusText = 'Online';
                    } else if (hoursSinceHeartbeat < 24) {
                        statusClass = 'status-warning';
                        statusText = 'Warning';
                    } else {
                        statusClass = 'status-error';
                        statusText = 'Error';
                    }
                }

                return `
                    <tr>
                        <td>${account.name || 'Unknown'}</td>
                        <td>${account.type ? account.type.toUpperCase() : 'UNKNOWN'}</td>
                        <td><span class="status-indicator ${statusClass}"></span>${statusText}</td>
                        <td>${account.last_success || 'Never'}</td>
                        <td>${typeof account.emails_today === 'number' ? account.emails_today : 0}</td>
                        <td>${typeof account.hours_since_heartbeat === 'number' ? account.hours_since_heartbeat + 'h ago' : 'Unknown'}</td>
                    </tr>
                `;
            }).join('');
        })
        .catch(error => {
            console.error('Error loading account activity report:', error);
            // Show user-friendly error message
            const tbody = document.getElementById('accountTableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="color: var(--danger);">Failed to load account activity report. Please try again.</td></tr>';
        });
}

// System Health Report
function loadSystemHealthReport() {
    let startDate = document.getElementById('systemHealthStartDate').value;
    let endDate = document.getElementById('systemHealthEndDate').value;

    // Set default dates if not provided
    if (!startDate || !endDate) {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        const formatDate = (date) => date.toISOString().split('T')[0];
        
        if (!startDate) {
            startDate = formatDate(thirtyDaysAgo);
            document.getElementById('systemHealthStartDate').value = startDate;
        }
        if (!endDate) {
            endDate = formatDate(today);
            document.getElementById('systemHealthEndDate').value = endDate;
        }
    }

    // Validate date range
    if (new Date(startDate) > new Date(endDate)) {
        showReportMessageForInput(document.getElementById('systemHealthStartDate'), 'Invalid date range: start date must be on or before end date', 'warning');
        return;
    } else {
        clearReportMessageForInput(document.getElementById('systemHealthStartDate'));
    }

    fetch(`/api/reports/system-health?start_date=${startDate}&end_date=${endDate}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            // Clear any previous validation messages for this section
            clearReportMessageForInput(document.getElementById('systemHealthStartDate'));

            // Defensive programming: ensure data structure exists
            if (!data || typeof data !== 'object') {
                console.error('Invalid response data:', data);
                return;
            }

            // Update metrics with safe defaults
            document.getElementById('databaseSize').textContent = data.database_size || 'Unknown';
            const avgHeartbeat = data.worker_stats && typeof data.worker_stats.avg_hours_since_heartbeat === 'number'
                ? data.worker_stats.avg_hours_since_heartbeat
                : 0;
            document.getElementById('avgHeartbeat').textContent = `${avgHeartbeat}h`;

            // Update chart with safe defaults
            const errorLabels = Array.isArray(data.error_labels) ? data.error_labels : [];
            const errorCounts = Array.isArray(data.error_counts) ? data.error_counts : [];

            errorTrendsChart.data.labels = errorLabels;
            errorTrendsChart.data.datasets[0].data = errorCounts;
            errorTrendsChart.update();
        })
        .catch(error => {
            console.error('Error loading system health report:', error);
            // Could add user notification here if needed
        });
}

// Anti-Virus Statistics Report
function loadAVStatsReport() {
    let startDate = document.getElementById('avStartDate').value;
    let endDate = document.getElementById('avEndDate').value;

    // Set default dates if not provided
    if (!startDate || !endDate) {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        const formatDate = (date) => date.toISOString().split('T')[0];
        
        if (!startDate) {
            startDate = formatDate(thirtyDaysAgo);
            document.getElementById('avStartDate').value = startDate;
        }
        if (!endDate) {
            endDate = formatDate(today);
            document.getElementById('avEndDate').value = endDate;
        }
    }

    // Validate date range
    if (new Date(startDate) > new Date(endDate)) {
        showReportMessageForInput(document.getElementById('avStartDate'), 'Invalid date range: start date must be on or before end date', 'warning');
        return;
    } else {
        clearReportMessageForInput(document.getElementById('avStartDate'));
    }

    fetch(`/api/reports/av-stats?start_date=${startDate}&end_date=${endDate}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            // Clear any previous validation messages for this section
            clearReportMessageForInput(document.getElementById('avStartDate'));

            // Defensive programming: ensure data structure exists
            if (!data || typeof data !== 'object') {
                console.error('Invalid response data:', data);
                return;
            }

            // Update metrics with safe defaults
            document.getElementById('cleanEmails').textContent = typeof data.clean_emails === 'number' ? data.clean_emails : 0;
            document.getElementById('quarantinedEmails').textContent = typeof data.quarantined_emails === 'number' ? data.quarantined_emails : 0;
            document.getElementById('rejectedEmails').textContent = typeof data.rejected_emails === 'number' ? data.rejected_emails : 0;

            // Update chart if it exists
            if (avStatsChart) {
                const labels = Array.isArray(data.labels) ? data.labels : [];
                const cleanCounts = Array.isArray(data.clean_counts) ? data.clean_counts : [];
                const quarantinedCounts = Array.isArray(data.quarantined_counts) ? data.quarantined_counts : [];
                const rejectedCounts = Array.isArray(data.rejected_counts) ? data.rejected_counts : [];

                avStatsChart.data.labels = labels;
                avStatsChart.data.datasets[0].data = cleanCounts;
                avStatsChart.data.datasets[1].data = quarantinedCounts;
                avStatsChart.data.datasets[2].data = rejectedCounts;
                avStatsChart.update();
            }
        })
        .catch(error => {
            console.error('Error loading AV statistics report:', error);
            // Could add user notification here if needed
        });
}

// Load Storage Utilization Report
function loadStorageUtilizationReport() {
    let startDate = document.getElementById('storageStartDate').value;
    let endDate = document.getElementById('storageEndDate').value;
    
    // Set default dates if not provided
    if (!startDate || !endDate) {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        const formatDate = (date) => date.toISOString().split('T')[0];
        
        if (!startDate) {
            startDate = formatDate(thirtyDaysAgo);
            document.getElementById('storageStartDate').value = startDate;
        }
        if (!endDate) {
            endDate = formatDate(today);
            document.getElementById('storageEndDate').value = endDate;
        }
    }
    
    // Validate date range
    if (new Date(startDate) > new Date(endDate)) {
        showReportMessageForInput(document.getElementById('storageStartDate'), 'Invalid date range: start date must be on or before end date', 'warning');
        return;
    } else {
        clearReportMessageForInput(document.getElementById('storageStartDate'));
    }
    
    let url = '/api/reports/storage-utilization';
    if (startDate && endDate) {
        url += `?start_date=${startDate}&end_date=${endDate}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Clear any previous validation messages for this section
            clearReportMessageForInput(document.getElementById('storageStartDate'));
            
            // Update metrics
            document.getElementById('totalStorage').textContent = data.total_storage || '-';
            document.getElementById('avgEmailSize').textContent = data.avg_email_size || '-';
            document.getElementById('compressionRatio').textContent = data.compression_savings || '-';
            document.getElementById('totalEmails').textContent = data.total_emails || '-';
            
            // Update storage trends chart
            if (window.storageTrendsChart && typeof window.storageTrendsChart.destroy === 'function') {
                window.storageTrendsChart.destroy();
            }
            const ctx = document.getElementById('storageTrendsChart').getContext('2d');
            window.storageTrendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.storage_trends?.labels || [],
                    datasets: [{
                        label: 'Storage Used (MB)',
                        data: data.storage_trends?.data || [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Storage Usage Over Time'
                        }
                    }
                }
            });
            
            // Update largest emails table
            const tbody = document.getElementById('largestEmailsTableBody');
            tbody.innerHTML = '';
            if (data.largest_emails) {
                data.largest_emails.forEach(email => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${email.subject || 'No Subject'}</td>
                        <td>${email.sender || 'Unknown'}</td>
                        <td>${email.size || '-'}</td>
                        <td>${email.date || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        })
        .catch(error => {
            console.error('Error loading storage utilization report:', error);
        });
}

// Load Retention Policy Report
function loadRetentionPolicyReport() {
    let startDate = document.getElementById('retentionStartDate').value;
    let endDate = document.getElementById('retentionEndDate').value;
    
    // Set default dates if not provided
    if (!startDate || !endDate) {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        const formatDate = (date) => date.toISOString().split('T')[0];
        
        if (!startDate) {
            startDate = formatDate(thirtyDaysAgo);
            document.getElementById('retentionStartDate').value = startDate;
        }
        if (!endDate) {
            endDate = formatDate(today);
            document.getElementById('retentionEndDate').value = endDate;
        }
    }
    
    // Validate date range
    if (new Date(startDate) > new Date(endDate)) {
        showReportMessageForInput(document.getElementById('retentionStartDate'), 'Invalid date range: start date must be on or before end date', 'warning');
        return;
    } else {
        clearReportMessageForInput(document.getElementById('retentionStartDate'));
    }
    
    let url = '/api/reports/retention-policy';
    if (startDate && endDate) {
        url += `?start_date=${startDate}&end_date=${endDate}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Clear any previous validation messages for this section
            clearReportMessageForInput(document.getElementById('retentionStartDate'));
            
            // Update metrics
            document.getElementById('totalManualDeletions').textContent = data.manual_deletions || '-';
            document.getElementById('totalRetentionDeletions').textContent = data.retention_deletions || '-';
            document.getElementById('totalServerDeletions').textContent = data.server_deletions || '-';
            
            // Update retention chart
            if (window.retentionChart && typeof window.retentionChart.destroy === 'function') {
                window.retentionChart.destroy();
            }
            const ctx = document.getElementById('retentionChart').getContext('2d');
            window.retentionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Manual Deletions', 'Retention Deletions', 'Server Deletions'],
                    datasets: [{
                        label: 'Deletions',
                        data: [data.manual_deletions || 0, data.retention_deletions || 0, data.server_deletions || 0],
                        backgroundColor: ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 205, 86, 0.8)']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Deletion Statistics'
                        }
                    }
                }
            });
            
            // Update age distribution table
            const tbody = document.getElementById('ageDistributionTableBody');
            tbody.innerHTML = '';
            if (data.age_distribution) {
                data.age_distribution.forEach(range => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${range.range}</td>
                        <td>${range.count}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // Update retention settings
            const settingsDiv = document.getElementById('retentionSettingsDisplay');
            if (data.retention_settings) {
                settingsDiv.innerHTML = `
                    <p><strong>Auto-delete after:</strong> ${data.retention_settings.auto_delete_days || 'Not set'} days</p>
                    <p><strong>Max emails per account:</strong> ${data.retention_settings.max_emails_per_account || 'Not set'}</p>
                    <p><strong>Max storage per account:</strong> ${data.retention_settings.max_storage_per_account || 'Not set'}</p>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading retention policy report:', error);
        });
}

// Load System Performance Report
function loadSystemPerformanceReport() {
    let startDate = document.getElementById('performanceStartDate').value;
    let endDate = document.getElementById('performanceEndDate').value;
    
    // Set default dates if not provided
    if (!startDate || !endDate) {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        const formatDate = (date) => date.toISOString().split('T')[0];
        
        if (!startDate) {
            startDate = formatDate(thirtyDaysAgo);
            document.getElementById('performanceStartDate').value = startDate;
        }
        if (!endDate) {
            endDate = formatDate(today);
            document.getElementById('performanceEndDate').value = endDate;
        }
    }
    
    // Validate date range
    if (new Date(startDate) > new Date(endDate)) {
        showReportMessageForInput(document.getElementById('performanceStartDate'), 'Invalid date range: start date must be on or before end date', 'warning');
        return;
    } else {
        clearReportMessageForInput(document.getElementById('performanceStartDate'));
    }
    
    let url = '/api/reports/system-performance';
    if (startDate && endDate) {
        url += `?start_date=${startDate}&end_date=${endDate}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Clear any previous validation messages for this section
            clearReportMessageForInput(document.getElementById('performanceStartDate'));
            
            // Update metrics
            document.getElementById('currentActiveWorkers').textContent = data.active_workers || '-';
            document.getElementById('currentTotalWorkers').textContent = data.total_workers || '-';
            document.getElementById('avgProcessingRate').textContent = data.avg_processing_rate || '-';
            
            // Update performance chart
            if (window.performanceChart && typeof window.performanceChart.destroy === 'function') {
                window.performanceChart.destroy();
            }
            const ctx = document.getElementById('performanceChart').getContext('2d');
            window.performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.processing_rates?.labels || [],
                    datasets: [{
                        label: 'Emails Processed per Hour',
                        data: data.processing_rates?.data || [],
                        borderColor: 'rgb(153, 102, 255)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Processing Performance Over Time'
                        }
                    }
                }
            });
            
            // Update worker activity chart
            if (window.workerActivityChart && typeof window.workerActivityChart.destroy === 'function') {
                window.workerActivityChart.destroy();
            }
            const ctx2 = document.getElementById('workerActivityChart').getContext('2d');
            window.workerActivityChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: data.worker_activity?.labels || [],
                    datasets: [{
                        label: 'Worker Activity',
                        data: data.worker_activity?.data || [],
                        backgroundColor: 'rgba(255, 159, 64, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Worker Activity Distribution'
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading system performance report:', error);
        });
}

// Load Security & Access Report
function loadSecurityAccessReport() {
    let startDate = document.getElementById('securityStartDate').value;
    let endDate = document.getElementById('securityEndDate').value;
    
    // Set default dates if not provided
    if (!startDate || !endDate) {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        const formatDate = (date) => date.toISOString().split('T')[0];
        
        if (!startDate) {
            startDate = formatDate(thirtyDaysAgo);
            document.getElementById('securityStartDate').value = startDate;
        }
        if (!endDate) {
            endDate = formatDate(today);
            document.getElementById('securityEndDate').value = endDate;
        }
    }
    
    // Validate date range
    if (new Date(startDate) > new Date(endDate)) {
        showReportMessageForInput(document.getElementById('securityStartDate'), 'Invalid date range: start date must be on or before end date', 'warning');
        return;
    } else {
        clearReportMessageForInput(document.getElementById('securityStartDate'));
    }
    
    let url = '/api/reports/security-access';
    if (startDate && endDate) {
        url += `?start_date=${startDate}&end_date=${endDate}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Clear any previous validation messages for this section
            clearReportMessageForInput(document.getElementById('securityStartDate'));
            
            // Update metrics
            document.getElementById('totalSuccessfulLogins').textContent = data.total_successful_logins || '-';
            document.getElementById('totalFailedLogins').textContent = data.total_failed_logins || '-';
            document.getElementById('totalPasswordChanges').textContent = data.total_password_changes || '-';
            
            // Update security chart
            if (window.securityChart && typeof window.securityChart.destroy === 'function') {
                window.securityChart.destroy();
            }
            const ctx = document.getElementById('securityChart').getContext('2d');
            window.securityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Successful Logins', 'Failed Logins', 'Password Changes'],
                    datasets: [{
                        data: [data.total_successful_logins || 0, data.total_failed_logins || 0, data.total_password_changes || 0],
                        backgroundColor: ['rgba(75, 192, 192, 0.8)', 'rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Security Events Distribution'
                        }
                    }
                }
            });
            
            // Update security events table
            const tbody = document.getElementById('securityEventsTableBody');
            tbody.innerHTML = '';
            if (data.recent_security_events) {
                data.recent_security_events.forEach(event => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${event.timestamp || '-'}</td>
                        <td>${event.level || '-'}</td>
                        <td>${event.message || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // Update user activity table
            const tbody2 = document.getElementById('userActivityTableBody');
            tbody2.innerHTML = '';
            if (data.user_activity) {
                data.user_activity.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.username || '-'}</td>
                        <td>${user.role || '-'}</td>
                        <td>${user.last_login || '-'}</td>
                        <td>${user.recent_actions || '-'}</td>
                    `;
                    tbody2.appendChild(row);
                });
            }
        })
        .catch(error => {
            console.error('Error loading security access report:', error);
        });
}

// Load Data Quality Report
function loadDataQualityReport() {
    fetch('/api/reports/data-quality')
        .then(response => response.json())
        .then(data => {
            // Update metrics
            document.getElementById('dataCompleteness').textContent = (100 - (data.completeness_stats?.missing_subjects_percent || 0)) + '%';
            document.getElementById('scanCoverage').textContent = (100 - (data.completeness_stats?.unscanned_percent || 0)) + '%';
            document.getElementById('potentialDuplicates').textContent = data.potential_duplicates || '-';
            document.getElementById('errorRate').textContent = (data.processing_issues?.error_rate_percent || 0) + '%';
            
            // Update completeness percentages
            document.getElementById('missingSubjectsPercent').textContent = (data.completeness_stats?.missing_subjects_percent || 0) + '%';
            document.getElementById('missingSendersPercent').textContent = (data.completeness_stats?.missing_senders_percent || 0) + '%';
            document.getElementById('missingRecipientsPercent').textContent = (data.completeness_stats?.missing_recipients_percent || 0) + '%';
            document.getElementById('unscannedPercent').textContent = (data.completeness_stats?.unscanned_percent || 0) + '%';
            document.getElementById('virusDetectedPercent').textContent = (data.completeness_stats?.virus_detected_percent || 0) + '%';
            
            // Update size distribution chart
            if (window.sizeDistributionChart && typeof window.sizeDistributionChart.destroy === 'function') {
                window.sizeDistributionChart.destroy();
            }
            const ctx = document.getElementById('sizeDistributionChart').getContext('2d');
            window.sizeDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['< 1KB', '1-10KB', '10-100KB', '100KB-1MB', '> 1MB'],
                    datasets: [{
                        label: 'Email Count',
                        data: [
                            data.size_distribution?.under_1kb || 0,
                            data.size_distribution?.kb_1_10 || 0,
                            data.size_distribution?.kb_10_100 || 0,
                            data.size_distribution?.kb_100_1024 || 0,
                            data.size_distribution?.over_1mb || 0
                        ],
                        backgroundColor: 'rgba(153, 102, 255, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Email Size Distribution'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Size Range'
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading data quality report:', error);
        });
}

// Event listeners for refresh buttons
document.getElementById('refreshEmailVolume').addEventListener('click', loadEmailVolumeReport);
document.getElementById('refreshAccountActivity').addEventListener('click', loadAccountActivityReport);
document.getElementById('refreshSystemHealth').addEventListener('click', loadSystemHealthReport);
document.getElementById('refreshAVStats').addEventListener('click', loadAVStatsReport);
document.getElementById('refreshStorageUtilization').addEventListener('click', loadStorageUtilizationReport);
document.getElementById('refreshRetentionPolicy').addEventListener('click', loadRetentionPolicyReport);
document.getElementById('refreshSystemPerformance').addEventListener('click', loadSystemPerformanceReport);
document.getElementById('refreshSecurityAccess').addEventListener('click', loadSecurityAccessReport);
document.getElementById('refreshDataQuality').addEventListener('click', loadDataQualityReport);

// Event listeners for date changes
document.getElementById('emailVolumeStartDate').addEventListener('change', loadEmailVolumeReport);
document.getElementById('emailVolumeEndDate').addEventListener('change', loadEmailVolumeReport);
document.getElementById('accountActivityStartDate').addEventListener('change', loadAccountActivityReport);
document.getElementById('accountActivityEndDate').addEventListener('change', loadAccountActivityReport);
document.getElementById('systemHealthStartDate').addEventListener('change', loadSystemHealthReport);
document.getElementById('systemHealthEndDate').addEventListener('change', loadSystemHealthReport);
document.getElementById('avStartDate').addEventListener('change', loadAVStatsReport);
document.getElementById('avEndDate').addEventListener('change', loadAVStatsReport);
document.getElementById('storageStartDate').addEventListener('change', loadStorageUtilizationReport);
document.getElementById('storageEndDate').addEventListener('change', loadStorageUtilizationReport);
document.getElementById('retentionStartDate').addEventListener('change', loadRetentionPolicyReport);
document.getElementById('retentionEndDate').addEventListener('change', loadRetentionPolicyReport);
document.getElementById('performanceStartDate').addEventListener('change', loadSystemPerformanceReport);
document.getElementById('performanceEndDate').addEventListener('change', loadSystemPerformanceReport);
document.getElementById('securityStartDate').addEventListener('change', loadSecurityAccessReport);
document.getElementById('securityEndDate').addEventListener('change', loadSecurityAccessReport);

// Load all reports on page load
loadAllReports();

// Check user role and show/hide admin-only reports
fetch('/api/user/profile')
    .then(response => response.json())
    .then(data => {
        if (data.role === 'administrator') {
            document.getElementById('securityReportSection').style.display = 'block';
            loadSecurityAccessReport(); // Load security report for admins
        }
    })
    .catch(error => {
        console.error('Error checking user role:', error);
    });
</script>
{% endblock %}