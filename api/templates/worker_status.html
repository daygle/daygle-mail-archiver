{% extends "base.html" %}

{% block content %}
<h2>Worker Status</h2>

<!-- Overall System Health -->
<div class="settings-section">
    <div class="alert 
        {% if system_health == 'healthy' %}alert-success
        {% elif system_health == 'warning' %}alert-warning
        {% elif system_health == 'error' %}alert-danger
        {% elif system_health == 'pending' %}alert-info
        {% else %}alert-secondary
        {% endif %}
        d-flex align-items-center">
        <i class="fas 
            {% if system_health == 'healthy' %}fa-check-circle
            {% elif system_health == 'warning' %}fa-exclamation-triangle
            {% elif system_health == 'error' %}fa-times-circle
            {% elif system_health == 'pending' %}fa-clock
            {% else %}fa-info-circle
            {% endif %}
            me-2 fs-4"></i>
        <div>
            <strong>System Status:</strong> {{ system_health_label }}
        </div>
    </div>
</div>

<!-- Account Status Table -->
<div class="settings-section">
    <h3>Fetch Account Status</h3>
    <p class="section-description">Monitor the health and activity of email fetch workers</p>

    {% if accounts|length == 0 %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        No fetch accounts configured. <a href="/fetch_accounts/new">Create one now</a>.
    </div>
    {% else %}
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Account Name</th>
                    <th>Type</th>
                    <th>Last Heartbeat</th>
                    <th>Last Success</th>
                    <th>Poll Interval</th>
                    <th>Last Error</th>
                </tr>
            </thead>
            <tbody>
                {% for acc in accounts %}
                <tr class="
                    {% if acc.health == 'healthy' %}table-success
                    {% elif acc.health == 'error' %}table-danger
                    {% elif acc.health == 'stale' %}table-warning
                    {% elif acc.health == 'disabled' %}table-secondary
                    {% endif %}">
                    <td>
                        <span class="badge 
                            {% if acc.health == 'healthy' %}bg-success
                            {% elif acc.health == 'error' %}bg-danger
                            {% elif acc.health == 'stale' %}bg-warning text-dark
                            {% elif acc.health == 'disabled' %}bg-secondary
                            {% elif acc.health == 'pending' %}bg-info
                            {% endif %}">
                            <i class="fas 
                                {% if acc.health == 'healthy' %}fa-check-circle
                                {% elif acc.health == 'error' %}fa-times-circle
                                {% elif acc.health == 'stale' %}fa-exclamation-triangle
                                {% elif acc.health == 'disabled' %}fa-ban
                                {% elif acc.health == 'pending' %}fa-clock
                                {% endif %}
                                me-1"></i>
                            {{ acc.health_label }}
                        </span>
                    </td>
                    <td>
                        <a href="/fetch_accounts/{{ acc.id }}/edit">{{ acc.name }}</a>
                    </td>
                    <td>
                        <span class="badge 
                            {% if acc.account_type == 'imap' %}bg-primary
                            {% elif acc.account_type == 'gmail' %}bg-danger
                            {% elif acc.account_type == 'o365' %}bg-info
                            {% endif %}">
                            {{ acc.account_type|upper }}
                        </span>
                    </td>
                    <td>
                        {% if acc.last_heartbeat %}
                            <span class="text-muted">{{ acc.heartbeat_ago }}</span>
                            <br>
                            <small class="text-muted">{{ acc.last_heartbeat.strftime('%Y-%m-%d %H:%M:%S UTC') }}</small>
                        {% else %}
                            <span class="text-muted">Never</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if acc.last_success %}
                            <span class="text-success fw-bold">{{ acc.success_ago }}</span>
                            <br>
                            <small class="text-muted">{{ acc.last_success.strftime('%Y-%m-%d %H:%M:%S UTC') }}</small>
                        {% else %}
                            <span class="text-muted">Never</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if acc.poll_interval %}
                            {{ acc.poll_interval }}s
                        {% else %}
                            <span class="text-muted">Default (300s)</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if acc.last_error %}
                            <span class="text-danger">
                                <i class="fas fa-exclamation-circle me-1"></i>
                                {{ acc.last_error[:100] }}{% if acc.last_error|length > 100 %}...{% endif %}
                            </span>
                        {% else %}
                            <span class="text-muted">None</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="mt-3">
        <h5>Status Legend</h5>
        <ul class="list-unstyled">
            <li><span class="badge bg-success me-2">Healthy</span> Worker is active and fetching successfully</li>
            <li><span class="badge bg-warning text-dark me-2">Stale</span> No heartbeat in 3x the poll interval</li>
            <li><span class="badge bg-danger me-2">Error</span> Last fetch attempt encountered an error</li>
            <li><span class="badge bg-info me-2">Pending</span> Never been run yet</li>
            <li><span class="badge bg-secondary me-2">Disabled</span> Account is disabled and not being fetched</li>
        </ul>
    </div>

    <div class="mt-3">
        <a href="/fetch_accounts" class="btn btn-primary"><i class="fas fa-server me-2"></i>Manage Fetch Accounts</a>
        <a href="/logs" class="btn btn-secondary"><i class="fas fa-list me-2"></i>View System Logs</a>
    </div>
</div>

<style>
.table-responsive {
    overflow-x: auto;
}

.table td {
    vertical-align: middle;
}

.table small {
    font-size: 0.75rem;
}
</style>

{% endblock %}
