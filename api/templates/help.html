{% extends "base.html" %}

{% block page_title %}Help & Documentation{% endblock %}

{% block content %}
<!-- Quick Start Guide -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-rocket"></i>
            <span>Quick Start Guide</span>
        </div>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 16px;">Learn how to use Daygle Mail Archiver to fetch, store, and manage your emails.</p>
        <ol style="padding-left: 24px; margin-bottom: 0;">
            <li style="margin-bottom: 12px;"><strong>Set up a Fetch Account:</strong> Go to Settings → Fetch Accounts and add a new email account (IMAP, Gmail, or Office 365)</li>
            <li style="margin-bottom: 12px;"><strong>Enable the account:</strong> Make sure the "Enabled" checkbox is checked</li>
            <li style="margin-bottom: 12px;"><strong>Start the worker:</strong> The worker will automatically fetch emails based on the poll interval</li>
            <li style="margin-bottom: 0;"><strong>View your emails:</strong> Navigate to the Emails page to browse and search archived emails</li>
        </ol>
    </div>
</div>

<!-- Adding IMAP Accounts -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-server"></i>
            <span>Adding IMAP Accounts</span>
        </div>
    </div>
    <div class="card-body">
        <ol style="padding-left: 24px; margin-bottom: 0;">
            <li style="margin-bottom: 12px;">Go to <strong>Settings → Fetch Accounts</strong> and click <strong>"Add New Account"</strong></li>
            <li style="margin-bottom: 12px;">Select <strong>"IMAP"</strong> as the account type</li>
            <li style="margin-bottom: 12px;">Enter your IMAP server details (host, port, username, password, SSL)</li>
            <li style="margin-bottom: 12px;">Set the poll interval (how often to check for new emails)</li>
            <li style="margin-bottom: 12px;">Click <strong>"Test"</strong> to verify the connection</li>
            <li style="margin-bottom: 0;">Click <strong>"Create Account"</strong> to save</li>
        </ol>
    </div>
</div>

<!-- Adding Gmail API Accounts -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fab fa-google"></i>
            <span>Adding Gmail API Accounts</span>
        </div>
    </div>
    <div class="card-body">
        <ol style="padding-left: 24px; margin-bottom: 0;">
            <li style="margin-bottom: 12px;">Create a Google Cloud project and enable Gmail API</li>
            <li style="margin-bottom: 12px;">Create OAuth 2.0 credentials with redirect URI: <code>http://your-domain/oauth/gmail/callback</code></li>
            <li style="margin-bottom: 12px;">Add a new account and select <strong>"Gmail API"</strong></li>
            <li style="margin-bottom: 12px;">Enter your OAuth Client ID and Client Secret</li>
            <li style="margin-bottom: 12px;">Save the account, then click <strong>"Authorize Gmail"</strong></li>
            <li style="margin-bottom: 0;">Complete the Google authorization flow</li>
        </ol>
    </div>
</div>

<!-- Adding Office 365 Accounts -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fab fa-microsoft"></i>
            <span>Adding Office 365 Accounts</span>
        </div>
    </div>
    <div class="card-body">
        <ol style="padding-left: 24px; margin-bottom: 0;">
            <li style="margin-bottom: 12px;">Register an app in Azure AD / Microsoft 365 Admin Center</li>
            <li style="margin-bottom: 12px;">Add Mail.Read permission and create a client secret</li>
            <li style="margin-bottom: 12px;">Add a new account and select <strong>"Office 365 API"</strong></li>
            <li style="margin-bottom: 12px;">Enter your OAuth Client ID and Client Secret</li>
            <li style="margin-bottom: 12px;">Save the account, then click <strong>"Authorize Office 365"</strong></li>
            <li style="margin-bottom: 0;">Complete the Microsoft authorization flow</li>
        </ol>
    </div>
</div>

<!-- Managing Emails -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-inbox"></i>
            <span>Managing Emails</span>
        </div>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 16px;"><strong>Viewing Emails:</strong> Navigate to the Emails page to see all archived emails. You can search, filter by folder, view full content, and download raw .eml files.</p>
        <p style="margin-bottom: 16px;"><strong>Deleting Emails:</strong> Click the delete button next to an email for individual deletion, or use "Delete All" with filters for bulk operations.</p>
        <div class="alert alert-warning" style="margin-bottom: 0;">
            <i class="fas fa-exclamation-triangle"></i> <strong>Warning:</strong> Deletions are permanent and cannot be undone!
        </div>
    </div>
</div>

<!-- Worker Status -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-heartbeat"></i>
            <span>Worker Status Monitoring</span>
        </div>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 16px;">The Worker Status page shows the health of your email fetch workers, including status (green=running, red=stopped), last heartbeat, number of accounts being monitored, and recent errors.</p>
        <p style="margin-bottom: 0;">If the worker status is red, check that the worker process is running and review the error logs.</p>
    </div>
</div>

<!-- Global Settings -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-sliders"></i>
            <span>Global Settings</span>
        </div>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 16px;"><strong>Retention Policy:</strong> Configure automatic deletion of old emails. Set retention period (days, months, years) and optionally delete from mail servers (IMAP only).</p>
        <p style="margin-bottom: 16px;"><strong>Page Size & Date Format:</strong> Control items per page in email listings and configure your preferred date/time display format.</p>
        <div class="alert alert-info" style="margin-bottom: 0;">
            <i class="fas fa-info-circle"></i> Retention cleanup runs automatically during worker cycles. All deletions are tracked on the Dashboard.
        </div>
    </div>
</div>

<!-- Dashboard Analytics -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard & Analytics</span>
        </div>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 16px;">The Dashboard provides comprehensive statistics about your email archive including email volume trends, top senders/receivers, deletion statistics, mail server deletions, and storage metrics.</p>
        <p style="margin-bottom: 0;">All charts are interactive and update in real-time based on your archive data.</p>
    </div>
</div>

<!-- Troubleshooting -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-wrench"></i>
            <span>Troubleshooting</span>
        </div>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 16px;"><strong>Connection Issues:</strong> Use the Test button on fetch accounts, check firewall settings, verify SSL/TLS settings, and use app-specific passwords for Gmail with 2FA.</p>
        <p style="margin-bottom: 16px;"><strong>OAuth Authorization Failed:</strong> Verify Client ID and Secret, ensure redirect URI is properly configured, check API permissions, and try re-authorizing.</p>
        <p style="margin-bottom: 16px;"><strong>No Emails Being Fetched:</strong> Check that the account is Enabled, verify the worker is running, and review error emails in the logs.</p>
        <p style="margin-bottom: 0;"><strong>Performance Issues:</strong> Reduce poll interval, enable "Delete after processing" option, or implement retention policies to limit database size.</p>
    </div>
</div>

<!-- Email Deletion Behavior -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-trash-alt"></i>
            <span>Email Deletion Behavior</span>
        </div>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 16px;">When "Delete Email After Processed" is enabled, emails are removed from the mail server after being archived:</p>
        <ul style="padding-left: 24px; margin-bottom: 16px;">
            <li style="margin-bottom: 8px;"><strong>IMAP:</strong> Can mark as deleted (recoverable) or permanently expunge (not recoverable)</li>
            <li style="margin-bottom: 8px;"><strong>Gmail:</strong> Moves to Trash with 30-day recovery period</li>
            <li style="margin-bottom: 8px;"><strong>Office 365:</strong> Moves to Deleted Items (recoverable until emptied)</li>
        </ul>
        <div class="alert alert-danger" style="margin-bottom: 0;">
            <i class="fas fa-exclamation-triangle"></i> <strong>Warning:</strong> The "Permanently Expunge Deleted" option for IMAP accounts irreversibly removes emails from the server. Use with extreme caution!
        </div>
    </div>
</div>

<!-- User Management (Administrators Only) -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-users"></i>
            <span>User Management</span>
        </div>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 16px;">Administrators can manage system users through the <strong>User Management</strong> page in the administration section.</p>
        
        <p style="margin-bottom: 12px;"><strong>Creating Users:</strong></p>
        <ol style="padding-left: 24px; margin-bottom: 16px;">
            <li style="margin-bottom: 8px;">Navigate to <strong>User Management</strong> from the sidebar</li>
            <li style="margin-bottom: 8px;">Click <strong>"Create New User"</strong></li>
            <li style="margin-bottom: 8px;">Enter username, email, and select a role (viewer or administrator)</li>
            <li style="margin-bottom: 8px;">User will need to set their password on first login</li>
        </ol>

        <p style="margin-bottom: 12px;"><strong>User Roles:</strong></p>
        <ul style="padding-left: 24px; margin-bottom: 16px;">
            <li style="margin-bottom: 8px;"><strong>Administrator:</strong> Full access to all features including settings, user management, and logs</li>
            <li style="margin-bottom: 8px;"><strong>Viewer:</strong> Read-only access to view and search emails</li>
        </ul>

        <p style="margin-bottom: 0;"><strong>Managing Your Profile:</strong> All users can access their profile settings from the user menu (top-right) to change password and update personal information.</p>
    </div>
</div>

<!-- Audit Logs (Administrators Only) -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-list"></i>
            <span>Audit Logs</span>
        </div>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 16px;">The system maintains a complete audit trail of all actions. Administrators can view logs through the <strong>Logs</strong> page in the administration section.</p>
        
        <p style="margin-bottom: 12px;"><strong>Logged Actions Include:</strong></p>
        <ul style="padding-left: 24px; margin-bottom: 16px;">
            <li style="margin-bottom: 8px;">User login and logout events</li>
            <li style="margin-bottom: 8px;">Email deletions (manual and automated)</li>
            <li style="margin-bottom: 8px;">Fetch account creation and modifications</li>
            <li style="margin-bottom: 8px;">Settings changes</li>
            <li style="margin-bottom: 8px;">User management actions</li>
        </ul>

        <p style="margin-bottom: 0;">Each log entry includes a timestamp, username, action type, and details. Use the search and filter features to find specific events.</p>
    </div>
</div>

<!-- System Updates -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-sync-alt"></i>
            <span>System Updates</span>
        </div>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 16px;">Daygle Mail Archiver includes an automatic update script similar to mailcow's update system. The script handles checking for updates, pulling the latest code and Docker images, and restarting containers.</p>
        
        <p style="margin-bottom: 12px;"><strong>Command-line usage:</strong></p>
        <pre style="background-color: #f5f5f5; padding: 12px; border-radius: 4px; overflow-x: auto; margin-bottom: 16px;"><code># Check if updates are available
./update.sh --check

# Update the system (interactive, with confirmation)
./update.sh

# Update without confirmation prompts
./update.sh --force

# Update but don't restart containers
./update.sh --skip-start</code></pre>

        <p style="margin-bottom: 16px;"><strong>What happens during an update:</strong></p>
        <ol style="padding-left: 24px; margin-bottom: 16px;">
            <li style="margin-bottom: 8px;">Checks for available updates from the git repository</li>
            <li style="margin-bottom: 8px;">Saves any local changes to <code>update_diffs/</code> directory</li>
            <li style="margin-bottom: 8px;">Pulls the latest code from git</li>
            <li style="margin-bottom: 8px;">Pulls updated Docker images</li>
            <li style="margin-bottom: 8px;">Restarts all containers</li>
            <li style="margin-bottom: 8px;">Cleans up old Docker resources</li>
        </ol>

        <div class="alert alert-warning" style="margin-bottom: 0;">
            <i class="fas fa-exclamation-triangle"></i> <strong>Important:</strong> Always create a backup before updating: <code>./scripts/backup_restore.sh backup</code>. Your configuration file and local customizations are preserved during updates.
        </div>
    </div>
</div>

<!-- Backup and Restore -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-database"></i>
            <span>Backup and Restore</span>
        </div>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 16px;">Protect your email archive with the built-in command-line backup and restore script. Backups include both the database AND the configuration file with encryption keys.</p>
        
        <p style="margin-bottom: 12px;"><strong>Creating a Backup:</strong></p>
        <pre style="background-color: #f5f5f5; padding: 12px; border-radius: 4px; overflow-x: auto; margin-bottom: 16px;"><code>cd /opt/daygle-mail-archiver
./scripts/backup_restore.sh backup</code></pre>
        <p style="margin-bottom: 16px;">This creates a timestamped backup file in the <code>./backups/</code> directory (or custom location) containing the complete PostgreSQL database dump and <code>daygle_mail_archiver.conf</code> file with all encryption keys.</p>

        <p style="margin-bottom: 12px;"><strong>Listing Available Backups:</strong></p>
        <pre style="background-color: #f5f5f5; padding: 12px; border-radius: 4px; overflow-x: auto; margin-bottom: 16px;"><code>./scripts/backup_restore.sh list</code></pre>

        <p style="margin-bottom: 12px;"><strong>Restoring from Backup:</strong></p>
        <pre style="background-color: #f5f5f5; padding: 12px; border-radius: 4px; overflow-x: auto; margin-bottom: 16px;"><code>./scripts/backup_restore.sh restore daygle_mail_archiver_backup_20240105_120000.tar.gz</code></pre>
        <p style="margin-bottom: 16px;">After restore, restart the services with: <code>docker compose restart</code></p>

        <p style="margin-bottom: 12px;"><strong>Deleting Old Backups:</strong></p>
        <pre style="background-color: #f5f5f5; padding: 12px; border-radius: 4px; overflow-x: auto; margin-bottom: 16px;"><code>./scripts/backup_restore.sh delete daygle_mail_archiver_backup_20240105_120000.tar.gz</code></pre>

        <div class="alert alert-danger" style="margin-bottom: 0;">
            <i class="fas fa-exclamation-circle"></i> <strong>Security Warning:</strong> Store backups securely! They contain all email data, encryption keys (IMAP_PASSWORD_KEY, SESSION_SECRET), and database credentials. The configuration file is required to decrypt stored passwords.
        </div>
    </div>
</div>

<!-- Additional Resources -->
<div class="card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-book"></i>
            <span>Additional Resources</span>
        </div>
    </div>
    <div class="card-body">
        <ul style="padding-left: 24px; margin-bottom: 0;">
            <li style="margin-bottom: 8px;"><strong>GitHub Repository:</strong> View source code and report issues</li>
            <li style="margin-bottom: 8px;"><strong>Documentation:</strong> Check the README.md for technical details</li>
            <li style="margin-bottom: 8px;"><strong>Support:</strong> Contact the administrator or check the logs for detailed error information</li>
            <li style="margin-bottom: 8px;"><strong>Donate:</strong> Support development via the <a href="/donate">Donate</a> page</li>
        </ul>
    </div>
</div>
{% endblock %}
