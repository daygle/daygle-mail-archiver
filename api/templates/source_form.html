{% extends "base.html" %}
{% block content %}

<h1 class="mb-4 fw-bold">
    {% if source %}Edit Source: {{ source.name }}{% else %}New IMAP Source{% endif %}
</h1>

<div class="row">
    <div class="col-md-8">

        {% if error %}
            <div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
        {% endif %}

        {% if success %}
            <div class="alert alert-success" role="alert">
                {{ success }}
            </div>
        {% endif %}

        <form id="sourceForm" method="post" action="{% if source %}/sources/{{ source.id }}{% else %}/sources/new{% endif %}">

            <div class="card mb-4 shadow-sm">
                <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                    <span>Source Details</span>
                    {% if source %}
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary"
                                onclick="document.getElementById('testImapForm').submit()">
                            Test IMAP Connection
                        </button>
                    {% endif %}
                </div>
                <div class="card-body">

                    <div class="mb-3">
                        <label class="form-label">Name (identifier)</label>
                        <input type="text" name="name" class="form-control"
                               value="{{ source.name if source else '' }}" required>
                        <div class="form-text">
                            Used in worker logs and status pages.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Host</label>
                        <input type="text" name="host" class="form-control"
                               value="{{ source.host if source else '' }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Port</label>
                        <input type="number" name="port" class="form-control"
                               value="{{ source.port if source else 993 }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" name="username" class="form-control"
                               value="{{ source.username if source else '' }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" name="password" class="form-control"
                               placeholder="{% if source %}Leave blank to keep existing password{% else %}Enter password{% endif %}">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Use SSL</label>
                        <select name="use_ssl" class="form-select">
                            <option value="true" {% if not source or source.use_ssl %}selected{% endif %}>True</option>
                            <option value="false" {% if source and not source.use_ssl %}selected{% endif %}>False</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Require STARTTLS (port 143)</label>
                        <select name="require_starttls" class="form-select">
                            <option value="true" {% if source and source.require_starttls %}selected{% endif %}>True</option>
                            <option value="false" {% if not source or not source.require_starttls %}selected{% endif %}>False</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">CA Bundle Path (optional)</label>
                        <input type="text" name="ca_bundle" class="form-control"
                               value="{{ source.ca_bundle if source else '' }}"
                               placeholder="/etc/ssl/certs/ca-certificates.crt">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Poll Interval (seconds)</label>
                        <input type="number" name="poll_interval_seconds" class="form-control"
                               value="{{ source.poll_interval_seconds if source else 300 }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Delete After Processing</label>
                        <select name="delete_after_processing" class="form-select">
                            <option value="true" {% if not source or source.delete_after_processing %}selected{% endif %}>True</option>
                            <option value="false" {% if source and not source.delete_after_processing %}selected{% endif %}>False</option>
                        </select>
                    </div>

                    <div class="mb-0">
                        <label class="form-label">Enabled</label>
                        <select name="enabled" class="form-select">
                            <option value="true" {% if not source or source.enabled %}selected{% endif %}>True</option>
                            <option value="false" {% if source and not source.enabled %}selected{% endif %}>False</option>
                        </select>
                    </div>

                </div>
            </div>

            <div class="d-flex justify-content-between mb-4">
                <a href="/sources" class="btn btn-outline-secondary">Back to Sources</a>
                <button type="submit" class="btn btn-primary">
                    Save Source
                </button>
            </div>

        </form>

        {% if source %}
            <form id="testImapForm" method="post" action="/sources/{{ source.id }}/test-imap" style="display:none;"></form>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("sourceForm");
    const ssl = form.querySelector("select[name='use_ssl']");
    const starttls = form.querySelector("select[name='require_starttls']");

    function enforceMutualExclusion(event) {
        if (ssl.value === "true" && starttls.value === "true") {
            if (event && event.target === ssl) {
                starttls.value = "false";
                alert("SSL and STARTTLS cannot both be enabled. STARTTLS has been disabled.");
            } else {
                ssl.value = "false";
                alert("SSL and STARTTLS cannot both be enabled. SSL has been disabled.");
            }
        }
    }

    ssl.addEventListener("change", enforceMutualExclusion);
    starttls.addEventListener("change", enforceMutualExclusion);

    form.addEventListener("submit", (e) => {
        const requiredFields = ["name", "host", "port", "username", "poll_interval_seconds"];

        for (const field of requiredFields) {
            const el = form.querySelector(`[name='${field}']`);
            if (!el || !el.value || el.value.toString().trim() === "") {
                e.preventDefault();
                alert(`Field "${field}" is required.`);
                return;
            }
        }

        if (ssl.value === "true" && starttls.value === "true") {
            e.preventDefault();
            alert("SSL and STARTTLS cannot both be enabled.");
            return;
        }
    });
});
</script>

{% endblock %}