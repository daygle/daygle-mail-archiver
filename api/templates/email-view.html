{% extends "base.html" %}

{% block page_title %}Email View{% endblock %}

{% block content %}
<!-- Email Metadata Card -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="card-title">
            <i class="fas fa-envelope-open"></i>
            <span>Email Details</span>
        </div>
        <a href="/emails" class="btn btn-secondary btn-sm">
            <i class="fas fa-arrow-left"></i>
            <span class="hide-mobile">Back</span>
        </a>
    </div>
    <div class="card-body">
        <!-- Email Header Information -->
        <div class="mb-4">
            <h5 class="mb-3 text-primary">
                <i class="fas fa-envelope-open-text me-2"></i>Email Information
            </h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="email-detail-item">
                        <label class="email-detail-label">Subject</label>
                        <div class="email-detail-value">
                            <strong class="text-break">{{ email.subject or "(no subject)" }}</strong>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="email-detail-item">
                        <label class="email-detail-label">Date</label>
                        <div class="email-detail-value">{{ email.date_formatted or email.date }}</div>
                    </div>
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-12">
                    <div class="email-detail-item">
                        <label class="email-detail-label">Message ID</label>
                        <div class="email-detail-value">
                            <code class="text-break">{{ headers.message_id or "(no message id)" }}</code>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sender & Recipients -->
        <div class="mb-4">
            <h6 class="mb-3 text-muted">
                <i class="fas fa-users me-2"></i>Participants
            </h6>
            <div class="row g-3">
                <div class="col-12">
                    <div class="email-detail-item">
                        <label class="email-detail-label">From</label>
                        <div class="email-detail-value text-break">{{ email.sender }}</div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="email-detail-item">
                        <label class="email-detail-label">To</label>
                        <div class="email-detail-value text-break">{{ email.recipients }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Account & Organization -->
        <div class="mb-4">
            <h6 class="mb-3 text-muted">
                <i class="fas fa-folder-tree me-2"></i>Organization
            </h6>
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="email-detail-item">
                        <label class="email-detail-label">Account</label>
                        <div class="email-detail-value">
                            <span class="badge badge-primary">{{ email.source }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="email-detail-item">
                        <label class="email-detail-label">Folder</label>
                        <div class="email-detail-value">
                            <span class="badge badge-secondary">{{ email.folder }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security & Status -->
        {% if request.session.role == 'administrator' or email.virus_scanned %}
        <div class="mb-4">
            <h6 class="mb-3 text-muted">
                <i class="fas fa-shield-alt me-2"></i>Security & Status
            </h6>
            <div class="row g-3">
                {% if request.session.role == 'administrator' %}
                <div class="col-md-6">
                    <div class="email-detail-item">
                        <label class="email-detail-label">Integrity</label>
                        <div class="email-detail-value">
                            {% if integrity == 'ok' %}
                            <span class="badge bg-success"><i class="fas fa-check"></i> Integrity OK</span>
                            {% elif integrity == 'modified' %}
                            <span class="badge bg-danger"><i class="fas fa-exclamation-triangle"></i> Modified</span>
                            {% elif integrity == 'no_signature' %}
                            <span class="badge bg-secondary"><i class="fas fa-question"></i> No Signature</span>
                            {% else %}
                            <span class="badge bg-secondary"><i class="fas fa-question"></i> Unknown</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if email.virus_scanned %}
                <div class="col-md-6">
                    <div class="email-detail-item">
                        <label class="email-detail-label">Virus Scan</label>
                        <div class="email-detail-value">
                            {% if email.virus_detected %}
                            <span class="badge badge-danger">
                                <i class="fas fa-exclamation-triangle"></i> INFECTED: {{ email.virus_name }}
                            </span>
                            {% else %}
                            <span class="badge badge-success">
                                <i class="fas fa-check"></i> Clean
                            </span>
                            {% endif %}
                            {% if email.scan_timestamp %}
                            <br><small class="text-secondary">
                                Scanned: {{ email.scan_timestamp_formatted or 'N/A' }}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    <div class="card-footer">
        <div class="d-flex justify-content-end gap-2">
            {% if request.session.role != 'read_only' %}
            <a href="/emails/{{ email.id }}/download" class="btn btn-primary btn-sm">
                <i class="fas fa-download"></i>
                <span class="hide-mobile">Download EML</span>
            </a>
            {% endif %}
            {% if request.session.role == 'administrator' %}
            {% if not email.quarantined %}
            <form method="post" action="/emails/{{ email.id }}/quarantine" style="display:inline;">
                <button type="submit" class="btn btn-warning btn-sm">
                    <i class="fas fa-shield-virus"></i>
                    <span class="hide-mobile">Quarantine</span>
                </button>
            </form>
            {% endif %}
            <button type="button" class="btn btn-danger btn-sm" onclick="showDeleteConfirmation()">
                <i class="fas fa-trash"></i>
                <span class="hide-mobile">Delete</span>
            </button>
            {% endif %}
        </div>
    </div>
</div>


<!-- Body Card -->
<div class="card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-file-alt"></i>
            <span>Email Body</span>
        </div>
    </div>
    <div class="card-body">



        {% if body.html %}
            <div style="border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; background: var(--bg-primary);">
                {{ body.html | safe }}
            </div>
            <div class="mt-2">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i> Embedded images are displayed inline where available
                </small>
            </div>
        {% else %}
            <pre style="background: var(--bg-secondary); padding: 16px; border-radius: var(--radius-md); overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;">{{ body.text }}</pre>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Section (Initially Hidden) -->
<div id="delete-confirmation" class="card" style="display: none;">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
            <span>Confirm Deletion</span>
        </div>
    </div>
    <div class="card-body">
        <div class="alert alert-warning">
            <i class="fas fa-info-circle"></i>
            <span>You are about to delete <strong>1</strong> email.</span>
        </div>

        <p style="margin-top: 20px; margin-bottom: 20px;"><strong>Choose how you want to delete it:</strong></p>

        <form id="delete-form" method="post" action="/emails/delete">
            <input type="hidden" name="ids" value="{{ email.id }}">
            
            <div style="display: grid; gap: 12px; margin-bottom: 20px;">
                <button type="submit" name="mode" value="db" class="btn btn-danger w-100">
                    <i class="fas fa-database"></i>
                    <span class="hide-mobile">Delete from Database Only</span>
                </button>
                <button type="submit" name="mode" value="imap" class="btn btn-warning w-100">
                    <i class="fas fa-server"></i>
                    <span class="hide-mobile">Delete from Database and Mail Server</span>
                </button>
            </div>

            <div class="text-center">
                <button type="button" class="btn btn-secondary" onclick="hideDeleteConfirmation()">
                    <i class="fas fa-times"></i>
                    <span class="hide-mobile">Cancel</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
  function showDeleteConfirmation() {
    // Hide all cards and show delete confirmation
    document.querySelectorAll('.card').forEach(function(card) {
      if (card.id !== 'delete-confirmation') {
        card.style.display = 'none';
      }
    });
    document.getElementById('delete-confirmation').style.display = 'block';
    
    // Scroll to top
    window.scrollTo(0, 0);
  }

  function hideDeleteConfirmation() {
    // Show all cards and hide delete confirmation
    document.querySelectorAll('.card').forEach(function(card) {
      if (card.id !== 'delete-confirmation') {
        card.style.display = 'block';
      }
    });
    document.getElementById('delete-confirmation').style.display = 'none';
    
    // Scroll to top
    window.scrollTo(0, 0);
  }

    
</script>

{% endblock %}
