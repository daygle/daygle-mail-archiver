{% extends "base.html" %}

{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
<!-- GridStack CSS (Local) -->
<link rel="stylesheet" href="/static/vendor/gridstack.min.css" />
<link rel="stylesheet" href="/static/vendor/gridstack-extra.min.css" />
<style>
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Customization Toolbar -->
<div class="dashboard-toolbar">
    <div class="toolbar-left">
        <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
    </div>
    <div class="toolbar-right">
        <button id="btn-customize" class="btn btn-secondary">
            <i class="fas fa-cog"></i> Customize
        </button>
        <button id="btn-save-layout" class="btn btn-primary" style="display: none;">
            <i class="fas fa-save"></i> Save Layout
        </button>
        <button id="btn-reset-layout" class="btn btn-warning" style="display: none;">
            <i class="fas fa-undo"></i> Reset
        </button>
    </div>
</div>

<!-- Widget Customization Panel (Hidden by default) -->
<div id="customization-panel" class="customization-panel" style="display: none;">
    <div class="panel-header">
        <h3><i class="fas fa-sliders-h"></i> Widget Settings</h3>
        <button id="btn-close-panel" class="btn-icon">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="panel-body">
        <p class="text-muted">Toggle widgets on/off:</p>
        <div id="widget-toggles"></div>
    </div>
</div>

<!-- GridStack Dashboard -->
<div class="grid-stack" id="dashboard-grid">
    <!-- Widgets will be dynamically added here -->
</div>

<!-- Widget Templates (Hidden) -->
<div style="display: none;">
    <!-- Stats Widget Template -->
    <div id="template-stats" class="grid-stack-item-content widget-card">
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-chart-bar"></i>
                <span>Statistics</span>
            </div>
            <button class="widget-menu-btn" data-widget="stats">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>
        <div class="widget-body">
            <div class="stats-grid-mini">
                <div class="stat-mini stat-primary">
                    <div class="stat-icon"><i class="fas fa-envelope"></i></div>
                    <div class="stat-content">
                        <div class="stat-label">Total Emails</div>
                        <div class="stat-value" id="mini-stat-total-emails">
                            <span class="spinner"></span>
                        </div>
                    </div>
                </div>
                <div class="stat-mini stat-success">
                    <div class="stat-icon"><i class="fas fa-calendar-day"></i></div>
                    <div class="stat-content">
                        <div class="stat-label">Today</div>
                        <div class="stat-value" id="mini-stat-emails-today">
                            <span class="spinner"></span>
                        </div>
                    </div>
                </div>
                <div class="stat-mini stat-info">
                    <div class="stat-icon"><i class="fas fa-server"></i></div>
                    <div class="stat-content">
                        <div class="stat-label">Accounts</div>
                        <div class="stat-value" id="mini-stat-total-accounts">
                            <span class="spinner"></span>
                        </div>
                    </div>
                </div>
                <div class="stat-mini stat-warning">
                    <div class="stat-icon"><i class="fas fa-database"></i></div>
                    <div class="stat-content">
                        <div class="stat-label">DB Size</div>
                        <div class="stat-value" id="mini-stat-database-size">
                            <span class="spinner"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emails Per Day Chart Template -->
    <div id="template-emails-per-day" class="grid-stack-item-content widget-card">
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-chart-line"></i>
                <span>Emails Per Day (30d)</span>
            </div>
            <button class="widget-menu-btn" data-widget="emails-per-day">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>
        <div class="widget-body">
            <canvas id="emailsPerDayChart"></canvas>
        </div>
    </div>

    <!-- Top Senders Chart Template -->
    <div id="template-top-senders" class="grid-stack-item-content widget-card">
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-paper-plane"></i>
                <span>Top 10 Senders</span>
            </div>
            <button class="widget-menu-btn" data-widget="top-senders">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>
        <div class="widget-body">
            <canvas id="topSendersChart"></canvas>
        </div>
    </div>

    <!-- Top Receivers Chart Template -->
    <div id="template-top-receivers" class="grid-stack-item-content widget-card">
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-inbox"></i>
                <span>Top 10 Receivers</span>
            </div>
            <button class="widget-menu-btn" data-widget="top-receivers">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>
        <div class="widget-body">
            <canvas id="topReceiversChart"></canvas>
        </div>
    </div>

    <!-- Deletion Stats Chart Template -->
    <div id="template-deletion-stats" class="grid-stack-item-content widget-card">
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-trash-alt"></i>
                <span>Email Deletions (30d)</span>
            </div>
            <button class="widget-menu-btn" data-widget="deletion-stats">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>
        <div class="widget-body">
            <canvas id="deletionStatsChart"></canvas>
        </div>
    </div>

    <!-- Recent Activity Template -->
    <div id="template-recent-activity" class="grid-stack-item-content widget-card">
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-history"></i>
                <span>Recent Activity</span>
            </div>
            <button class="widget-menu-btn" data-widget="recent-activity">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>
        <div class="widget-body">
            <div id="recent-activity-list" class="activity-list">
                <div class="spinner-center"><span class="spinner"></span></div>
            </div>
        </div>
    </div>

    <!-- Storage Trends Template -->
    <div id="template-storage-trends" class="grid-stack-item-content widget-card">
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-chart-area"></i>
                <span>Storage Trends (7d)</span>
            </div>
            <button class="widget-menu-btn" data-widget="storage-trends">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>
        <div class="widget-body">
            <canvas id="storageTrendsChart"></canvas>
        </div>
    </div>

    <!-- Account Health Template -->
    <div id="template-account-health" class="grid-stack-item-content widget-card">
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-heartbeat"></i>
                <span>Account Health</span>
            </div>
            <button class="widget-menu-btn" data-widget="account-health">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>
        <div class="widget-body">
            <div id="account-health-list" class="health-list">
                <div class="spinner-center"><span class="spinner"></span></div>
            </div>
        </div>
    </div>

    <!-- System Status Template -->
    <div id="template-system-status" class="grid-stack-item-content widget-card">
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-server"></i>
                <span>System Status</span>
            </div>
            <button class="widget-menu-btn" data-widget="system-status">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>
        <div class="widget-body">
            <div id="system-status-content" class="status-content">
                <div class="spinner-center"><span class="spinner"></span></div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Template -->
    <div id="template-quick-actions" class="grid-stack-item-content widget-card">
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-bolt"></i>
                <span>Quick Actions</span>
            </div>
            <button class="widget-menu-btn" data-widget="quick-actions">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>
        <div class="widget-body">
            <div class="quick-actions-grid">
                <a href="/emails" class="quick-action-btn">
                    <i class="fas fa-envelope"></i>
                    <span>View Emails</span>
                </a>
                <a href="/fetch-accounts" class="quick-action-btn">
                    <i class="fas fa-server"></i>
                    <span>Accounts</span>
                </a>
                <a href="/global-settings" class="quick-action-btn">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
                <a href="/logs" class="quick-action-btn">
                    <i class="fas fa-file-alt"></i>
                    <span>Logs</span>
                </a>
                <a href="/worker-status" class="quick-action-btn">
                    <i class="fas fa-tasks"></i>
                    <span>Workers</span>
                </a>
                <a href="/users" class="quick-action-btn">
                    <i class="fas fa-users"></i>
                    <span>Users</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- GridStack JS (Local) -->
<script>
console.log('Loading GridStack from local files...');
</script>
<script src="/static/vendor/gridstack-all.js" 
        onload="console.log('GridStack loaded successfully');" 
        onerror="console.error('Failed to load local GridStack library')"></script>

<!-- Chart.js (Local) -->
<script src="/static/vendor/chart.min.js"></script>

<script>
// Dashboard Widget Manager
const DashboardManager = {
    grid: null,
    charts: {},
    editMode: false,
    
    // Default widget layout
    defaultWidgets: [
        { id: 'stats', x: 0, y: 0, w: 12, h: 2, visible: true },
        { id: 'emails-per-day', x: 0, y: 2, w: 6, h: 3, visible: true },
        { id: 'deletion-stats', x: 6, y: 2, w: 6, h: 3, visible: true },
        { id: 'top-senders', x: 0, y: 5, w: 6, h: 4, visible: true },
        { id: 'top-receivers', x: 6, y: 5, w: 6, h: 4, visible: true },
        { id: 'recent-activity', x: 0, y: 9, w: 4, h: 4, visible: true },
        { id: 'storage-trends', x: 4, y: 9, w: 4, h: 4, visible: true },
        { id: 'account-health', x: 8, y: 9, w: 4, h: 4, visible: true },
        { id: 'system-status', x: 0, y: 13, w: 4, h: 3, visible: true },
        { id: 'quick-actions', x: 4, y: 13, w: 8, h: 3, visible: true }
    ],

    init() {
        // Check if GridStack is loaded
        if (typeof GridStack === 'undefined') {
            console.error('GridStack library not loaded - CDN might be blocked or unavailable');
            alert('Dashboard failed to load: GridStack library not available. Please check your internet connection and refresh the page.');
            return;
        }

        // Initialize GridStack
        try {
            console.log('Initializing GridStack...');
            this.grid = GridStack.init({
                column: 12,
                cellHeight: 80,
                margin: 15,
                float: false,
                disableOneColumnMode: true,
                animate: true,
                draggable: { handle: '.widget-header' }
            });

            console.log('GridStack initialized successfully');

            // Disable editing by default
            this.grid.disable();

            // Load user preferences or use defaults
            this.loadLayout();

            // Setup event listeners
            this.setupEventListeners();
            
            console.log('Dashboard initialization complete');
        } catch (error) {
            console.error('Error initializing dashboard:', error);
            console.error('Error stack:', error.stack);
            alert('Dashboard failed to initialize: ' + error.message + '\n\nCheck the browser console for more details.');
        }
    },

    async loadLayout() {
        try {
            console.log('Loading dashboard layout...');
            const response = await fetch('/api/dashboard/preferences');
            console.log('Preferences response status:', response.status);
            
            if (!response.ok) {
                console.warn('Preferences API returned error, using defaults');
                this.renderWidgets(this.defaultWidgets);
                return;
            }
            
            const data = await response.json();
            console.log('Preferences data:', data);
            
            let widgets = data.widgets && data.widgets.length > 0 
                ? data.widgets.map(w => ({
                    id: w.widget_id,
                    x: w.x,
                    y: w.y,
                    w: w.w,
                    h: w.h,
                    visible: w.visible
                  }))
                : this.defaultWidgets;

            console.log('Using widgets:', widgets);
            this.renderWidgets(widgets);
        } catch (error) {
            console.error('Error loading layout:', error);
            console.log('Falling back to default widgets');
            this.renderWidgets(this.defaultWidgets);
        }
    },

    renderWidgets(widgets) {
        // Clear existing widgets
        this.grid.removeAll();

        // Add each visible widget
        widgets.forEach(widget => {
            if (widget.visible) {
                this.addWidget(widget);
            }
        });

        // Load data for all widgets
        this.loadAllData();

        // Update toggle panel
        this.updateWidgetToggles(widgets);
    },

    addWidget(config) {
        const template = document.getElementById(`template-${config.id}`);
        if (!template) return;

        const content = template.cloneNode(true);
        content.id = `widget-${config.id}`;
        content.style.display = 'block';

        this.grid.addWidget({
            x: config.x,
            y: config.y,
            w: config.w,
            h: config.h,
            content: content.outerHTML,
            id: config.id
        });
    },

    setupEventListeners() {
        // Customize button
        const customizeBtn = document.getElementById('btn-customize');
        if (!customizeBtn) {
            console.error('Customize button not found!');
            return;
        }
        console.log('Setting up customize button listener');
        customizeBtn.addEventListener('click', () => {
            console.log('Customize button clicked');
            this.toggleEditMode();
        });

        // Save layout button
        document.getElementById('btn-save-layout').addEventListener('click', () => {
            this.saveLayout();
        });

        // Reset layout button
        document.getElementById('btn-reset-layout').addEventListener('click', () => {
            if (confirm('Reset dashboard to default layout?')) {
                this.renderWidgets(this.defaultWidgets);
                this.saveLayout();
            }
        });

        // Close panel button
        document.getElementById('btn-close-panel').addEventListener('click', () => {
            document.getElementById('customization-panel').style.display = 'none';
        });

        // Grid change event
        this.grid.on('change', () => {
            if (this.editMode) {
                // Auto-save is optional, could add debounce here
            }
        });
    },

    toggleEditMode() {
        this.editMode = !this.editMode;

        if (this.editMode) {
            this.grid.enable();
            document.getElementById('btn-customize').style.display = 'none';
            document.getElementById('btn-save-layout').style.display = 'inline-block';
            document.getElementById('btn-reset-layout').style.display = 'inline-block';
            document.getElementById('customization-panel').style.display = 'block';
            document.querySelector('.grid-stack').classList.add('edit-mode');
        } else {
            this.grid.disable();
            document.getElementById('btn-customize').style.display = 'inline-block';
            document.getElementById('btn-save-layout').style.display = 'none';
            document.getElementById('btn-reset-layout').style.display = 'none';
            document.getElementById('customization-panel').style.display = 'none';
            document.querySelector('.grid-stack').classList.remove('edit-mode');
        }
    },

    async saveLayout() {
        const widgets = [];
        const items = this.grid.getGridItems();
        
        items.forEach(item => {
            const node = item.gridstackNode;
            widgets.push({
                widget_id: node.id,
                x: node.x,
                y: node.y,
                w: node.w,
                h: node.h,
                visible: true
            });
        });

        // Add hidden widgets
        this.defaultWidgets.forEach(dw => {
            if (!widgets.find(w => w.widget_id === dw.id)) {
                widgets.push({
                    widget_id: dw.id,
                    x: dw.x,
                    y: dw.y,
                    w: dw.w,
                    h: dw.h,
                    visible: false
                });
            }
        });

        try {
            const response = await fetch('/api/dashboard/preferences', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ widgets })
            });

            if (response.ok) {
                this.showFlashMessage('Dashboard layout saved successfully!', 'success');
                this.toggleEditMode();
            } else {
                this.showFlashMessage('Failed to save dashboard layout', 'error');
            }
        } catch (error) {
            console.error('Error saving layout:', error);
            this.showFlashMessage('Failed to save dashboard layout', 'error');
        }
    },

    showFlashMessage(message, type = 'success') {
        // Create flash message element
        const flash = document.createElement('div');
        flash.className = `flash flash-${type}`;
        flash.textContent = message;
        flash.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 10000; padding: 15px 20px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease;';
        
        if (type === 'success') {
            flash.style.backgroundColor = '#10b981';
            flash.style.color = 'white';
        } else {
            flash.style.backgroundColor = '#ef4444';
            flash.style.color = 'white';
        }
        
        document.body.appendChild(flash);
        
        // Remove after 3 seconds
        setTimeout(() => {
            flash.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => flash.remove(), 300);
        }, 3000);
    },

    updateWidgetToggles(widgets) {
        const container = document.getElementById('widget-toggles');
        container.innerHTML = '';

        this.defaultWidgets.forEach(widget => {
            const isVisible = widgets.find(w => w.id === widget.id)?.visible ?? true;
            
            const toggle = document.createElement('div');
            toggle.className = 'widget-toggle';
            toggle.innerHTML = `
                <label class="toggle-label">
                    <input type="checkbox" 
                           data-widget-id="${widget.id}" 
                           ${isVisible ? 'checked' : ''}>
                    <span>${this.getWidgetTitle(widget.id)}</span>
                </label>
            `;

            toggle.querySelector('input').addEventListener('change', (e) => {
                this.toggleWidget(widget.id, e.target.checked);
            });

            container.appendChild(toggle);
        });
    },

    toggleWidget(widgetId, visible) {
        if (visible) {
            const widget = this.defaultWidgets.find(w => w.id === widgetId);
            if (widget) {
                this.addWidget(widget);
                this.loadWidgetData(widgetId);
            }
        } else {
            const items = this.grid.getGridItems();
            items.forEach(item => {
                if (item.gridstackNode.id === widgetId) {
                    this.grid.removeWidget(item);
                }
            });
        }
    },

    getWidgetTitle(id) {
        const titles = {
            'stats': 'Statistics',
            'emails-per-day': 'Emails Per Day',
            'top-senders': 'Top Senders',
            'top-receivers': 'Top Receivers',
            'deletion-stats': 'Deletion Stats',
            'recent-activity': 'Recent Activity',
            'storage-trends': 'Storage Trends',
            'account-health': 'Account Health',
            'system-status': 'System Status',
            'quick-actions': 'Quick Actions'
        };
        return titles[id] || id;
    },

    // Load all widget data
    loadAllData() {
        this.loadStats();
        this.loadEmailsPerDay();
        this.loadTopSenders();
        this.loadTopReceivers();
        this.loadDeletionStats();
        this.loadRecentActivity();
        this.loadStorageTrends();
        this.loadAccountHealth();
        this.loadSystemStatus();
    },

    loadWidgetData(widgetId) {
        const loaders = {
            'stats': () => this.loadStats(),
            'emails-per-day': () => this.loadEmailsPerDay(),
            'top-senders': () => this.loadTopSenders(),
            'top-receivers': () => this.loadTopReceivers(),
            'deletion-stats': () => this.loadDeletionStats(),
            'recent-activity': () => this.loadRecentActivity(),
            'storage-trends': () => this.loadStorageTrends(),
            'account-health': () => this.loadAccountHealth(),
            'system-status': () => this.loadSystemStatus()
        };

        if (loaders[widgetId]) {
            loaders[widgetId]();
        }
    },

    async loadStats() {
        try {
            const response = await fetch('/api/dashboard/stats');
            const data = await response.json();
            
            document.getElementById('mini-stat-total-emails').textContent = data.total_emails.toLocaleString();
            document.getElementById('mini-stat-emails-today').textContent = data.emails_today.toLocaleString();
            document.getElementById('mini-stat-total-accounts').textContent = data.total_accounts.toLocaleString();
            document.getElementById('mini-stat-database-size').textContent = data.database_size;
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    },

    async loadEmailsPerDay() {
        try {
            const response = await fetch('/api/dashboard/emails-per-day');
            const data = await response.json();
            
            const ctx = document.getElementById('emailsPerDayChart');
            if (!ctx) return;

            if (this.charts.emailsPerDay) {
                this.charts.emailsPerDay.destroy();
            }

            this.charts.emailsPerDay = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Emails',
                        data: data.data,
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        } catch (error) {
            console.error('Error loading emails per day:', error);
        }
    },

    async loadTopSenders() {
        try {
            const response = await fetch('/api/dashboard/top-senders');
            const data = await response.json();
            
            const ctx = document.getElementById('topSendersChart');
            if (!ctx) return;

            if (this.charts.topSenders) {
                this.charts.topSenders.destroy();
            }

            this.charts.topSenders = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Emails Sent',
                        data: data.data,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                                        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } }
                }
            });
        } catch (error) {
            console.error('Error loading top senders:', error);
        }
    },

    async loadTopReceivers() {
        try {
            const response = await fetch('/api/dashboard/top-receivers');
            const data = await response.json();
            
            const ctx = document.getElementById('topReceiversChart');
            if (!ctx) return;

            if (this.charts.topReceivers) {
                this.charts.topReceivers.destroy();
            }

            this.charts.topReceivers = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Emails Received',
                        data: data.data,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                                        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } }
                }
            });
        } catch (error) {
            console.error('Error loading top receivers:', error);
        }
    },

    async loadDeletionStats() {
        try {
            const response = await fetch('/api/dashboard/deletion-stats');
            const data = await response.json();
            
            const ctx = document.getElementById('deletionStatsChart');
            if (!ctx) return;

            if (this.charts.deletionStats) {
                this.charts.deletionStats.destroy();
            }

            this.charts.deletionStats = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Manual',
                            data: data.manual,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)'
                        },
                        {
                            label: 'Retention',
                            data: data.retention,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)'
                        },
                        {
                            label: 'From Server',
                            data: data.deleted_from_server,
                            backgroundColor: 'rgba(255, 206, 86, 0.6)',
                            type: 'line'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true } }
                }
            });
        } catch (error) {
            console.error('Error loading deletion stats:', error);
        }
    },

    async loadRecentActivity() {
        try {
            const response = await fetch('/api/dashboard/recent-activity');
            const data = await response.json();
            
            const container = document.getElementById('recent-activity-list');
            if (!container) return;

            if (data.activities.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No recent activity</p>';
                return;
            }

            container.innerHTML = data.activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon"><i class="fas fa-envelope"></i></div>
                    <div class="activity-content">
                        <div class="activity-title">${activity.subject}</div>
                        <div class="activity-meta">
                            <span><i class="fas fa-user"></i> ${activity.sender}</span>
                            <span><i class="fas fa-clock"></i> ${activity.date}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading recent activity:', error);
        }
    },

    async loadStorageTrends() {
        try {
            const response = await fetch('/api/dashboard/storage-trends');
            const data = await response.json();
            
            const ctx = document.getElementById('storageTrendsChart');
            if (!ctx) return;

            if (this.charts.storageTrends) {
                this.charts.storageTrends.destroy();
            }

            this.charts.storageTrends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Storage (MB)',
                        data: data.sizes,
                        borderColor: '#9966FF',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        } catch (error) {
            console.error('Error loading storage trends:', error);
        }
    },

    async loadAccountHealth() {
        try {
            const response = await fetch('/api/dashboard/account-health');
            const data = await response.json();
            
            const container = document.getElementById('account-health-list');
            if (!container) return;

            if (!data.accounts || data.accounts.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No accounts configured</p>';
                return;
            }

            const statusColors = {
                'healthy': 'success',
                'disabled': 'secondary',
                'error': 'danger',
                'never_fetched': 'warning'
            };

            const statusIcons = {
                'healthy': 'check-circle',
                'disabled': 'ban',
                'error': 'exclamation-circle',
                'never_fetched': 'clock'
            };

            container.innerHTML = data.accounts.map(account => `
                <div class="health-item">
                    <div class="health-icon health-${statusColors[account.status]}">
                        <i class="fas fa-${statusIcons[account.status]}"></i>
                    </div>
                    <div class="health-content">
                        <div class="health-email">${account.email}</div>
                        <div class="health-meta">Last fetch: ${account.last_fetch}</div>
                        ${account.error ? `<div class="health-error">${account.error}</div>` : ''}
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading account health:', error);
            const container = document.getElementById('account-health-list');
            if (container) {
                container.innerHTML = '<p class="text-muted text-center">Error loading account health</p>';
            }
        }
    },

    async loadSystemStatus() {
        try {
            const response = await fetch('/api/dashboard/system-status');
            const data = await response.json();
            
            const container = document.getElementById('system-status-content');
            if (!container) return;

            container.innerHTML = `
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-icon ${data.database === 'healthy' ? 'status-success' : 'status-danger'}">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="status-label">Database</div>
                        <div class="status-value">${data.database === 'healthy' ? 'Healthy' : 'Error'}</div>
                    </div>
                    <div class="status-item">
                        <div class="status-icon status-info">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="status-label">Workers Online</div>
                        <div class="status-value">${data.workers_online}</div>
                    </div>
                    <div class="status-item">
                        <div class="status-icon status-warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="status-label">Pending Jobs</div>
                        <div class="status-value">${data.pending_jobs}</div>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading system status:', error);
        }
    }
};

// Initialize dashboard when DOM is ready
let initAttempts = 0;
const maxAttempts = 50; // 5 seconds max

function initDashboard() {
    initAttempts++;
    if (typeof GridStack === 'undefined') {
        console.log(`GridStack not loaded yet, waiting... (attempt ${initAttempts}/${maxAttempts})`);
        if (initAttempts >= maxAttempts) {
            console.error('GridStack failed to load after 5 seconds');
            alert('Dashboard initialization timeout. GridStack library did not load. Please check:\n\n1. Network tab in Developer Tools (F12)\n2. Your internet connection\n3. Firewall/antivirus blocking CDNs');
            return;
        }
        setTimeout(initDashboard, 100);
        return;
    }
    console.log('GridStack detected, initializing dashboard...');
    DashboardManager.init();
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, checking for GridStack...');
    initDashboard();
});
</script>

{% endblock %}
