{% extends "base.html" %}

{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
<!-- GridStack CSS (self-hosted) -->
<link rel="stylesheet" href="/static/vendor/gridstack/gridstack.min.css">
{# Dashboard-specific styles moved to api/static/styles.css #}
{% endblock %}

{% block content %}
<!-- Customisation Toolbar -->
<div class="dashboard-toolbar">
    <div class="toolbar-left">
    </div>
    <div class="toolbar-right">
        <button id="btn-customize" class="btn btn-secondary" title="Customise Dashboard">
            <i class="fas fa-cog"></i>
        </button>
        <button id="btn-add-widget" class="btn btn-info show-on-edit" title="Add Widget" onclick="DashboardManager.showWidgetSelector()">
            <i class="fas fa-plus"></i>
        </button>
        <button id="btn-save-layout" class="btn btn-primary show-on-edit" title="Save Layout">
            <i class="fas fa-save"></i>
        </button>
        <button id="btn-reset-layout" class="btn btn-warning show-on-edit" title="Reset Layout">
            <i class="fas fa-undo"></i>
        </button>
        <button id="btn-cancel" class="btn btn-secondary show-on-edit" title="Cancel">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<!-- API Unreachable Banner (hidden by default) -->
<div id="api-unreachable-banner" class="alert alert-warning d-none">
    <span id="api-unreachable-message">API unreachable — retrying...</span>
    <button id="api-retry-now" class="btn btn-sm btn-primary ml-1rem">Retry now</button>
</div>

<!-- Widget Selector Modal (Hidden by default) -->
<div id="widget-selector-modal" class="modal d-none">
    <div class="modal-overlay" id="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-plus-circle"></i> Add Widgets</h3>
            <button class="btn-icon" id="btn-close-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p class="text-muted mb-16">Select widgets to add to your dashboard:</p>
            <div id="widget-selector-list" class="d-grid gap-8"></div>
        </div>
    </div>
</div>

<!-- GridStack Dashboard -->
<div class="grid-stack" id="dashboard-grid">
    <!-- Widgets will be dynamically added here -->

    <!-- Temporary debug widget: visible static GridStack item to verify CSS/JS rendering -->
    <div class="grid-stack-item" gs-x="0" gs-y="0" gs-w="3" gs-h="3" id="static-debug-widget">
        <div class="grid-stack-item-content widget-card">
            <div class="widget-header">
                <div class="widget-title">Debug: Static Widget</div>
            </div>
            <div class="widget-body">
                <div class="stat-display">
                    <div class="stat-value">Test</div>
                    <div class="stat-label">Static debug widget to confirm GridStack rendering</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Widget Templates (Hidden) -->
<div style="display: none;">
    <!-- Total Emails Widget -->
    <div id="template-total-emails" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-envelope"></i>
                <span>Total Emails</span>
            </div>
        </div>
        <div class="widget-body">
            <div class="stat-display">
                <div class="stat-value" id="stat-total-emails">-</div>
                <div class="stat-label">Total archived emails</div>
            </div>
        </div>
    </div>

    <!-- Emails Today Widget -->
    <div id="template-emails-today" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-calendar-day"></i>
                <span>Emails Today</span>
            </div>
        </div>
        <div class="widget-body">
            <div class="stat-display">
                <div class="stat-value" id="stat-emails-today">-</div>
                <div class="stat-label">Emails received today</div>
            </div>
        </div>
    </div>

    <!-- Database Size Widget -->
    <div id="template-database-size" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-database"></i>
                <span>Database Size</span>
            </div>
        </div>
        <div class="widget-body">
            <div class="stat-display">
                <div class="stat-value" id="stat-database-size">-</div>
                <div class="stat-label">Current database size</div>
            </div>
        </div>
    </div>

    <!-- Active Accounts Widget -->
    <div id="template-active-accounts" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-server"></i>
                <span>Active Accounts</span>
            </div>
        </div>
        <div class="widget-body">
            <div class="stat-display">
                <div class="stat-value" id="stat-active-accounts">-</div>
                <div class="stat-label">Configured fetch accounts</div>
            </div>
        </div>
    </div>

    <!-- Workers Online Widget -->
    <div id="template-workers-online" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-heartbeat"></i>
                <span>Workers Online</span>
            </div>
        </div>
        <div class="widget-body">
            <div class="stat-display">
                <div class="stat-value" id="stat-workers-online">-</div>
                <div class="stat-label">Active worker processes</div>
            </div>
        </div>
    </div>

    <!-- Emails Last 7 Days Widget -->
    <div id="template-emails-last-7d" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-calendar-week"></i>
                <span>Last 7 Days</span>
            </div>
        </div>
        <div class="widget-body">
            <div class="stat-display">
                <div class="stat-value" id="stat-emails-last-7d">-</div>
                <div class="stat-label">Emails in past week</div>
            </div>
        </div>
    </div>

    <!-- Emails Last 30 Days Widget -->
    <div id="template-emails-last-30d" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-calendar-alt"></i>
                <span>Last 30 Days</span>
            </div>
        </div>
        <div class="widget-body">
            <div class="stat-display">
                <div class="stat-value" id="stat-emails-last-30d">-</div>
                <div class="stat-label">Emails in past month</div>
            </div>
        </div>
    </div>

    <!-- Storage Used Widget -->
    <div id="template-storage-used" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-hdd"></i>
                <span>Storage Used</span>
            </div>
        </div>
        <div class="widget-body">
            <div class="stat-display">
                <div class="stat-value" id="stat-storage-used">-</div>
                <div class="stat-label">Total storage consumed</div>
            </div>
        </div>
    </div>

    <!-- ClamAV Clean Widget -->
    <div id="template-clamav-clean" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-shield-alt"></i>
                <span>Clean Emails</span>
            </div>
        </div>
        <div class="widget-body">
            <div class="stat-display">
                <div class="stat-value" id="stat-clamav-clean">-</div>
                <div class="stat-label">Virus-free emails</div>
            </div>
        </div>
    </div>

    <!-- ClamAV Quarantined Widget -->
    <div id="template-clamav-quarantined" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Quarantined</span>
            </div>
        </div>
        <div class="widget-body">
            <div class="stat-display">
                <div class="stat-value" id="stat-clamav-quarantined">-</div>
                <div class="stat-label">Emails with viruses</div>
            </div>
        </div>
    </div>

    <!-- ClamAV Rejected Widget -->
    <div id="template-clamav-rejected" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-ban"></i>
                <span>Rejected</span>
            </div>
        </div>
        <div class="widget-body">
            <div class="stat-display">
                <div class="stat-value" id="stat-clamav-rejected">-</div>
                <div class="stat-label">Emails blocked by antivirus</div>
            </div>
        </div>
    </div>

    <!-- System Uptime Widget -->
    <div id="template-system-uptime" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-clock"></i>
                <span>System Uptime</span>
            </div>
        </div>
        <div class="widget-body">
            <div class="stat-display">
                <div class="stat-value" id="stat-system-uptime">-</div>
                <div class="stat-label">Time since last restart</div>
            </div>
        </div>
    </div>
</div>

<!-- GridStack JS (self-hosted) -->
<script src="/static/vendor/gridstack/gridstack-all.js"></script>

<script>
// Dashboard Widget Manager
const DashboardManager = {
    grid: null,
    charts: {},
    editMode: false,
    widgetSettings: {
        // No chart widgets currently implemented
    },
    currentSettingsWidget: null,

    // API connectivity helpers
    async sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); },

    showApiBanner(message) {
        const banner = document.getElementById('api-unreachable-banner');
        const msg = document.getElementById('api-unreachable-message');
        if (msg && message) msg.textContent = message;
        if (banner) banner.style.display = 'block';
    },

    hideApiBanner() {
        const banner = document.getElementById('api-unreachable-banner');
        if (banner) banner.style.display = 'none';
    },

    async retryAll() {
        // Retry loading all data
        this.showApiBanner('Retrying API requests...');
        try {
            await this.loadAllData();
        } catch (e) {
            // keep banner and message
            this.showApiBanner('API still unreachable — retrying...');
        }
    },

    async fetchWithRetry(url, options = {}, retries = 4, initialBackoff = 800) {
        let attempt = 0;
        while (true) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                this.hideApiBanner();
                return data;
            } catch (err) {
                attempt += 1;
                this.showApiBanner(`API unreachable — retrying (attempt ${attempt} of ${retries})`);
                if (attempt > retries) {
                    // Keep the banner visible and bubble error
                    throw err;
                }
                const backoff = initialBackoff * Math.pow(2, attempt - 1);
                await this.sleep(backoff);
            }
        }
    },

    // Default widget layout - now focused on customisable stat widgets
    defaultWidgets: [
        { id: 'total-emails', x: 0, y: 0, w: 3, h: 3, visible: true },
        { id: 'emails-today', x: 3, y: 0, w: 3, h: 3, visible: true },
        { id: 'database-size', x: 6, y: 0, w: 3, h: 3, visible: true },
        { id: 'active-accounts', x: 9, y: 0, w: 3, h: 3, visible: true },
        { id: 'workers-online', x: 0, y: 3, w: 3, h: 3, visible: true },
        { id: 'emails-last-7d', x: 3, y: 3, w: 3, h: 3, visible: true },
        { id: 'emails-last-30d', x: 6, y: 3, w: 3, h: 3, visible: true },
        { id: 'storage-used', x: 9, y: 3, w: 3, h: 3, visible: true },
        { id: 'clamav-clean', x: 0, y: 6, w: 3, h: 3, visible: true },
        { id: 'clamav-quarantined', x: 3, y: 6, w: 3, h: 3, visible: true },
        { id: 'clamav-rejected', x: 6, y: 6, w: 3, h: 3, visible: true },
        { id: 'system-uptime', x: 9, y: 6, w: 3, h: 3, visible: true }
    ],

    // Helper function to safely format numbers, returns "N/A" for invalid values
    formatNumber(value) {
        if (value === null || value === undefined || isNaN(value)) {
            return 'N/A';
        }
        return value.toLocaleString();
    },

    // Scale widgets for the current display columns. If the grid is using fewer columns
    // than the canonical 12 (e.g. 6 columns on small screens), scale x and w so the
    // layout preserves the intended arrangement. This does not mutate the input array.
    scaleWidgetsForDisplay(widgets) {
        if (!widgets || !Array.isArray(widgets)) return widgets;
        // If columns not set yet, assume desktop (12)
        const cols = this.columns || 12;
        if (cols === 12) return widgets;

        const factor = 12 / cols; // e.g. 2 when cols=6
        return widgets.map(w => {
            const newW = Math.min(Math.max(1, Math.round(w.w * factor)), cols);
            const newX = Math.min(Math.max(0, Math.round(w.x * factor)), cols - newW);
            return Object.assign({}, w, { x: newX, w: newW });
        });
    },

    init() {
        // Check if GridStack is loaded
        if (typeof GridStack === 'undefined') {
            console.error('GridStack library not loaded - CDN might be blocked or unavailable');
            alert('Dashboard failed to load: GridStack library not available. Please check your internet connection and refresh the page.');
            return;
        }

        // Initialise GridStack
        try {
            // Use fewer columns on small screens (2 columns) by halving the column count
            // Default layout is designed for 12 columns (4 columns of w=3). On small screens
            // we use 6 columns so widgets sized w=3 become w=6 (2 columns layout).
            this.columns = window.matchMedia('(max-width: 768px)').matches ? 6 : 12;

            this.grid = GridStack.init({
                column: this.columns,
                cellHeight: 80,
                margin: 20,
                float: false,
                disableOneColumnMode: true,
                animate: true,
                draggable: { handle: '.widget-header' }
            });

            // Ensure CSS variables are applied (force an explicit cellHeight application)
            try {
                if (typeof this.grid.cellHeight === 'function') {
                    this.grid.cellHeight(80);
                    console.debug('Dashboard: forced grid.cellHeight(80) to ensure CSS vars are set');
                }
            } catch (e) { console.warn('Dashboard: failed to force cellHeight', e); }

            // Disable editing by default
            this.grid.disable();

            // Load user preferences or use defaults
            this.loadLayout();

            // Setup event listeners
            this.setupEventListeners();

            // Bind retry button on banner
            const retryBtn = document.getElementById('api-retry-now');
            if (retryBtn) retryBtn.addEventListener('click', () => { this.retryAll(); });
        } catch (error) {
            console.error('Error initialising dashboard:', error);
            console.error('Error stack:', error.stack);
            alert('Dashboard failed to initialise: ' + error.message + '\n\nCheck the browser console for more details.');
        }
    },

    async loadLayout() {
        try {
            const response = await fetch('/api/dashboard/preferences');
            
            if (!response.ok) {
                console.warn('Preferences API returned error, using defaults');
                await this.loadWidgetSettingsFromPreferences();
                this.renderWidgets(this.defaultWidgets);
                return;
            }
            
            const data = await response.json();
            
                        let widgets = data.widgets && data.widgets.length > 0 
                                ? data.widgets.map(w => ({
                                        id: w.widget_id,
                                        x: w.x,
                                        y: w.y,
                                        w: w.w,
                                        h: w.h,
                                        visible: w.visible
                                    }))
                                : this.defaultWidgets.slice();

                        // Scale widgets for the current screen size (e.g. reduce 4 columns -> 2 columns)
                        widgets = this.scaleWidgetsForDisplay(widgets);

            // Drop any widgets that do not have a matching template (avoids corrupted saved layouts)
            widgets = widgets.filter(w => this.templateExists(w.id));

            // If everything was filtered out, fall back to defaults
            if (widgets.length === 0) {
                console.warn('No valid widgets found in preferences, using defaults');
                widgets = this.defaultWidgets;
            }

            // If only a single widget is visible (likely from a broken prior save), reset to defaults
            const visibleCount = widgets.filter(w => w.visible).length;
            if (visibleCount <= 1) {
                console.warn('Only one widget visible from preferences; reverting to defaults');
                widgets = this.defaultWidgets;
            }

            // Load widget settings before rendering
            await this.loadWidgetSettingsFromPreferences();
            
            this.renderWidgets(widgets);
        } catch (error) {
            console.error('Error loading layout:', error);
            await this.loadWidgetSettingsFromPreferences();
            this.renderWidgets(this.defaultWidgets);
        }
    },

    renderWidgets(widgets) {
        // Clear existing widgets
        this.grid.removeAll();

        // Ensure we have something visible; if not, revert to defaults
        const hasVisible = widgets.some(w => w.visible);
        const listToRender = hasVisible ? widgets : this.defaultWidgets;

        // Add each visible widget
        listToRender.forEach(widget => {
            if (widget.visible) {
                this.addWidget(widget);
            }
        });

        // Wait for widgets to be added to DOM before loading data
        setTimeout(() => {
            try {
                console.debug('Dashboard: render complete, grid items count:', this.grid && typeof this.grid.getGridItems === 'function' ? this.grid.getGridItems().length : 0);

                // Log computed CSS vars on grid element
                try {
                    const gridEl = this.grid && this.grid.el ? this.grid.el : document.querySelector('.grid-stack');
                    if (gridEl) {
                        const cs = getComputedStyle(gridEl);
                        console.debug('Dashboard: CSS --gs-cell-height:', cs.getPropertyValue('--gs-cell-height'));
                        console.debug('Dashboard: CSS --gs-column-width:', cs.getPropertyValue('--gs-column-width'));
                    }
                } catch (e) { }

                if (this.grid && typeof this.grid.getGridItems === 'function') {
                    this.grid.getGridItems().forEach(item => {
                        try {
                            console.debug('Dashboard: grid item node id:', item.gridstackNode ? item.gridstackNode.id : item.id);
                            const el = item.el || (item.gridstackNode && item.gridstackNode.el);
                            if (el) {
                                console.debug('  attrs gs-x,gs-y,gs-w,gs-h:', el.getAttribute('gs-x'), el.getAttribute('gs-y'), el.getAttribute('gs-w'), el.getAttribute('gs-h'));
                                console.debug('  inline styles top,left,width,height:', el.style.top, el.style.left, el.style.width, el.style.height);
                                const rect = el.getBoundingClientRect();
                                console.debug('  bounding rect:', rect.top, rect.left, rect.width, rect.height);
                            }
                        } catch (e) { }
                    });
                }
            } catch (e) { console.error('Dashboard post-render debug error:', e); }

            this.loadAllData();
        }, 100);
    },

    addWidget(config) {
        const template = document.getElementById(`template-${config.id}`);
        if (!template) {
            console.warn(`Template for widget '${config.id}' not found; skipping`);
            return;
        }

        const content = template.cloneNode(true);
        content.id = `widget-${config.id}`;
        content.style.display = 'block';

        // Debug: log what we're adding
        try {
            console.debug('Dashboard: adding widget', config.id, { x: config.x, y: config.y, w: config.w, h: config.h });
            console.debug('Template exists, content length:', content.outerHTML.length);
        } catch (e) { /* ignore */ }

        // Create a grid-stack item element and attach the content node so the DOM keeps the id attribute
        try {
            const wrapper = document.createElement('div');
            wrapper.className = 'grid-stack-item';
            wrapper.setAttribute('gs-x', String(config.x));
            wrapper.setAttribute('gs-y', String(config.y));
            wrapper.setAttribute('gs-w', String(config.w));
            wrapper.setAttribute('gs-h', String(config.h));
            wrapper.appendChild(content);

            // Use GridStack.makeWidget to convert the DOM element into a grid item (preserves inner IDs)
            if (this.grid && typeof this.grid.makeWidget === 'function') {
                this.grid.makeWidget(wrapper, { id: config.id });
            } else if (this.grid && typeof this.grid.addWidget === 'function') {
                // Fallback: older GridStack may accept object; use content as last resort
                this.grid.addWidget({
                    x: config.x,
                    y: config.y,
                    w: config.w,
                    h: config.h,
                    content: content.outerHTML,
                    id: config.id
                });
            } else {
                console.error('GridStack API not available to add widget');
            }
        } catch (e) {
            console.error('Error adding widget to grid:', e);
        }

        // Debug: verify it was added
        try {
            const items = (this.grid && typeof this.grid.getGridItems === 'function') ? this.grid.getGridItems() : [];
            console.debug('Dashboard: after addWidget, grid item count =', items.length);
            const domEl = document.getElementById(`widget-${config.id}`);
            console.debug(`Dashboard: DOM element for widget-${config.id} present:`, !!domEl);
        } catch (e) { console.error('Dashboard addWidget debug error:', e); }
    },

    templateExists(id) {
        return Boolean(document.getElementById(`template-${id}`));
    },

    setupEventListeners() {
        
        // Customise button
        const customizeBtn = document.getElementById('btn-customize');
        if (!customizeBtn) {
            console.error('Customise button not found!');
            return;
        }
        customizeBtn.addEventListener('click', () => {
            this.toggleEditMode();
        });

        // Add widget button
        const addWidgetBtn = document.getElementById('btn-add-widget');
        if (!addWidgetBtn) {
            console.error('Add widget button not found!');
            return;
        }
        addWidgetBtn.addEventListener('click', () => {
            this.showWidgetSelector();
        });

        // Save layout button
        document.getElementById('btn-save-layout').addEventListener('click', () => {
            this.saveLayout();
        });

        // Reset layout button
        document.getElementById('btn-reset-layout').addEventListener('click', () => {
            if (confirm('Reset dashboard to default layout?')) {
                this.renderWidgets(this.defaultWidgets);
                this.saveLayout();
            }
        });

        // Cancel button
        document.getElementById('btn-cancel').addEventListener('click', () => {
            this.cancelEdit();
        });

        // Close modal button
        document.getElementById('btn-close-modal').addEventListener('click', () => {
            this.hideModal(document.getElementById('widget-selector-modal'));
        });

        // Modal overlay click
        document.getElementById('modal-overlay').addEventListener('click', () => {
            this.hideModal(document.getElementById('widget-selector-modal'));
        });

        // Widget action buttons (delegated event handling)
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.widget-action-btn');
            if (!btn || !this.editMode) return;

            const action = btn.getAttribute('data-action');
            const widgetElement = btn.closest('.grid-stack-item');
            
            if (action === 'remove' && widgetElement) {
                this.grid.removeWidget(widgetElement);
            }
        });

        // Grid change event
        this.grid.on('change', () => {
            if (this.editMode) {
                // Auto-save is optional, could add debounce here
            }
        });
    },

    toggleEditMode() {
        this.editMode = !this.editMode;

        if (this.editMode) {
            this.grid.enable();
            document.getElementById('btn-customize').style.display = 'none';
            document.getElementById('btn-add-widget').style.display = 'inline-block';
            document.getElementById('btn-save-layout').style.display = 'inline-block';
            document.getElementById('btn-reset-layout').style.display = 'inline-block';
            document.getElementById('btn-cancel').style.display = 'inline-block';
            document.querySelector('.grid-stack').classList.add('edit-mode');
            const toolbar = document.querySelector('.dashboard-toolbar');
            if (toolbar) toolbar.classList.add('editing');
        } else {
            this.grid.disable();
            document.getElementById('btn-customize').style.display = 'inline-block';
            document.getElementById('btn-add-widget').style.display = 'none';
            document.getElementById('btn-save-layout').style.display = 'none';
            document.getElementById('btn-reset-layout').style.display = 'none';
            document.getElementById('btn-cancel').style.display = 'none';
            document.querySelector('.grid-stack').classList.remove('edit-mode');
            const toolbar = document.querySelector('.dashboard-toolbar');
            if (toolbar) toolbar.classList.remove('editing');
        }
    },

    cancelEdit() {
        // Exit edit mode
        this.editMode = true; // Set to true so toggleEditMode will set it to false
        this.toggleEditMode();
        
        // Reload saved layout to discard changes
        this.loadLayout();
    },

    showWidgetSelector() {
        console.debug('showWidgetSelector called');
        let modal = document.getElementById('widget-selector-modal');
        let container = document.getElementById('widget-selector-list');
        
        if (!modal || !container) {
            console.error('Modal or container not found', { modal, container });
            // Try a fallback selector for the container and modal
            const fallbackModal = document.querySelector('#widget-selector-modal');
            const fallbackContainer = document.querySelector('#widget-selector-list');
            if (!fallbackModal || !fallbackContainer) return;
            modal = fallbackModal; // eslint-disable-line no-param-reassign
            container = fallbackContainer; // eslint-disable-line no-param-reassign
        }
        container.innerHTML = '';

        // Determine currently visible widgets. Use GridStack if available, otherwise fall back to DOM lookup.
        const visibleWidgets = new Set();
        try {
            if (this.grid && typeof this.grid.getGridItems === 'function') {
                const items = this.grid.getGridItems() || [];
                items.forEach(item => {
                    try {
                        if (item && item.gridstackNode && item.gridstackNode.id) visibleWidgets.add(item.gridstackNode.id);
                    } catch (e) { /* ignore item */ }
                });
            }
        } catch (e) {
            console.warn('GridStack getGridItems failed; falling back to DOM check', e);
        }

        // DOM fallback: if GridStack didn't report items, check for existing widget elements
        if (visibleWidgets.size === 0) {
            this.defaultWidgets.forEach(w => {
                if (document.getElementById(`widget-${w.id}`)) visibleWidgets.add(w.id);
            });
        }

        // Always populate the selector from defaultWidgets so it's visible even if detection fails
        this.defaultWidgets.forEach(widget => {
            const isVisible = visibleWidgets.has(widget.id);
            const item = document.createElement('div');
            item.className = 'widget-selector-item' + (isVisible ? ' disabled' : '');
            item.innerHTML = `
                <div>
                    <strong>${this.getWidgetTitle(widget.id)}</strong>
                </div>
                <div>
                    ${isVisible ? '<i class="fas fa-check"></i> Added' : '<i class="fas fa-plus"></i> Add'}
                </div>
            `;

            if (!isVisible) {
                item.addEventListener('click', () => {
                    this.addWidget(widget);
                    try { this.loadWidgetData(widget.id); } catch (e) { /* ignore */ }
                    this.hideModal(modal);
                });
            }

            container.appendChild(item);
        });

        this.showModal(modal);
    },

    showModal(modal) {
        // Remove Bootstrap d-none (display: none !important) and then show
        modal.classList.remove('d-none');
        modal.style.display = 'flex';
        // Use RAF to ensure CSS transitions fire
        requestAnimationFrame(() => modal.classList.add('show'));
    },

    hideModal(modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            // Add d-none so Bootstrap utilities fully hide the element
            modal.classList.add('d-none');
            modal.style.display = 'none';
        }, 150);
    },

    showWidgetSettings(widgetId) {
        // No chart widgets currently implemented
        return;
    },

    saveWidgetSettings() {
        // No chart widgets currently implemented
        return;
    },

    async saveWidgetSettingsToPreferences() {
        // No chart widgets currently implemented
        return;
    },

    async loadWidgetSettingsFromPreferences() {
        // No chart widgets currently implemented
        return;
    },

    updateWidgetTitle(widgetId, days) {
        // No chart widgets currently implemented
        return;
    },

    async saveLayout() {
        const widgets = [];
        const items = this.grid.getGridItems();
        
        // When the UI is using a reduced column count (e.g. 6), normalize values back
        // to canonical 12-column coordinates before saving so preferences remain device-agnostic.
        const cols = this.columns || 12;
        const saveFactor = cols === 12 ? 1 : (12 / cols);

        items.forEach(item => {
            const node = item.gridstackNode;
            const normW = saveFactor === 1 ? node.w : Math.max(1, Math.round(node.w / saveFactor));
            const normX = saveFactor === 1 ? node.x : Math.max(0, Math.round(node.x / saveFactor));
            widgets.push({
                widget_id: node.id,
                x: normX,
                y: node.y,
                w: normW,
                h: node.h,
                visible: true
            });
        });

        // Add hidden widgets
        this.defaultWidgets.forEach(dw => {
            if (!widgets.find(w => w.widget_id === dw.id)) {
                widgets.push({
                    widget_id: dw.id,
                    x: dw.x,
                    y: dw.y,
                    w: dw.w,
                    h: dw.h,
                    visible: false
                });
            }
        });

        // Create and submit a form to save the layout
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/api/dashboard/preferences';
        form.style.display = 'none';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'widgets';
        input.value = JSON.stringify(widgets);
        form.appendChild(input);

        document.body.appendChild(form);
        form.submit();
    },

    getWidgetTitle(id) {
        const titles = {
            'total-emails': 'Total Emails',
            'emails-today': 'Emails Today',
            'database-size': 'Database Size',
            'active-accounts': 'Active Accounts',
            'workers-online': 'Workers Online',
            'emails-last-7d': 'Emails Last 7 Days',
            'emails-last-30d': 'Emails Last 30 Days',
            'storage-used': 'Storage Used',
            'clamav-clean': 'ClamAV Clean',
            'clamav-quarantined': 'ClamAV Quarantined',
            'clamav-rejected': 'ClamAV Rejected',
            'system-uptime': 'System Uptime'
        };
        return titles[id] || id;
    },

    // Load all widget data
    loadAllData() {
        // Load individual stat widgets
        this.loadTotalEmails();
        this.loadEmailsToday();
        this.loadDatabaseSize();
        this.loadActiveAccounts();
        this.loadWorkersOnline();
        this.loadEmailsLast7d();
        this.loadEmailsLast30d();
        this.loadStorageUsed();
        this.loadClamAVClean();
        this.loadClamAVQuarantined();
        this.loadClamAVRejected();
        this.loadSystemUptime();
    },

    loadWidgetData(widgetId) {
        // No chart widgets currently implemented
        return;
    },

    async loadOverview() {
        try {
            const response = await fetch('/api/dashboard/stats');
            const data = await response.json();
            
            const totalEmailsEl = document.getElementById('overview-total-emails');
            const emailsTodayEl = document.getElementById('overview-emails-today');
            const totalAccountsEl = document.getElementById('overview-accounts');
            const databaseSizeEl = document.getElementById('overview-db-size');
            
            if (totalEmailsEl) totalEmailsEl.textContent = this.formatNumber(data.total_emails);
            if (emailsTodayEl) emailsTodayEl.textContent = this.formatNumber(data.emails_today);
            if (totalAccountsEl) totalAccountsEl.textContent = this.formatNumber(data.total_accounts);
            if (databaseSizeEl) databaseSizeEl.textContent = data.database_size;

            // Load system status data
            const statusResponse = await fetch('/api/dashboard/system-status');
            const statusData = await statusResponse.json();
            
            const workersEl = document.getElementById('overview-workers');
            
            if (workersEl) workersEl.textContent = this.formatNumber(statusData.workers_online);
            

        } catch (error) {
            console.error('Error loading overview:', error);
        }
    },

    // Individual stat widget loading functions
    async loadTotalEmails() {
        try {
            const data = await this.fetchWithRetry('/api/dashboard/stats');
            const el = document.getElementById('stat-total-emails');
            if (el) el.textContent = this.formatNumber(data.total_emails);
        } catch (error) {
            console.error('Error loading total emails:', error);
        }
    },

    async loadEmailsToday() {
        try {
            const data = await this.fetchWithRetry('/api/dashboard/stats');
            const el = document.getElementById('stat-emails-today');
            if (el) el.textContent = this.formatNumber(data.emails_today);
        } catch (error) {
            console.error('Error loading emails today:', error);
        }
    },

    async loadDatabaseSize() {
        try {
            const data = await this.fetchWithRetry('/api/dashboard/stats');
            const el = document.getElementById('stat-database-size');
            if (el) el.textContent = data.database_size;
        } catch (error) {
            console.error('Error loading database size:', error);
        }
    },

    async loadActiveAccounts() {
        try {
            const data = await this.fetchWithRetry('/api/dashboard/stats');
            const el = document.getElementById('stat-active-accounts');
            if (el) el.textContent = this.formatNumber(data.total_accounts);
        } catch (error) {
            console.error('Error loading active accounts:', error);
        }
    },

    async loadWorkersOnline() {
        try {
            const data = await this.fetchWithRetry('/api/dashboard/system-status');
            const el = document.getElementById('stat-workers-online');
            if (el) el.textContent = this.formatNumber(data.workers_online);
        } catch (error) {
            console.error('Error loading workers online:', error);
        }
    },

    async loadEmailsLast7d() {
        try {
            const data = await this.fetchWithRetry('/api/dashboard/emails-last-7d');
            const el = document.getElementById('stat-emails-last-7d');
            if (el) el.textContent = this.formatNumber(data.count);
        } catch (error) {
            console.error('Error loading emails last 7d:', error);
        }
    },

    async loadEmailsLast30d() {
        try {
            const data = await this.fetchWithRetry('/api/dashboard/emails-last-30d');
            const el = document.getElementById('stat-emails-last-30d');
            if (el) el.textContent = this.formatNumber(data.count);
        } catch (error) {
            console.error('Error loading emails last 30d:', error);
        }
    },

    async loadStorageUsed() {
        try {
            const data = await this.fetchWithRetry('/api/dashboard/storage-used');
            const el = document.getElementById('stat-storage-used');
            if (el) el.textContent = data.size;
        } catch (error) {
            console.error('Error loading storage used:', error);
        }
    },

    async loadClamAVClean() {
        try {
            const data = await this.fetchWithRetry('/api/dashboard/clamav-stats');
            const el = document.getElementById('stat-clamav-clean');
            if (el) el.textContent = this.formatNumber(data.clean);
        } catch (error) {
            console.error('Error loading ClamAV clean:', error);
        }
    },

    async loadClamAVQuarantined() {
        try {
            const data = await this.fetchWithRetry('/api/dashboard/clamav-stats');
            const el = document.getElementById('stat-clamav-quarantined');
            if (el) el.textContent = this.formatNumber(data.quarantined);
        } catch (error) {
            console.error('Error loading ClamAV quarantined:', error);
        }
    },

    async loadClamAVRejected() {
        try {
            const data = await this.fetchWithRetry('/api/dashboard/clamav-stats');
            const el = document.getElementById('stat-clamav-rejected');
            if (el) el.textContent = this.formatNumber(data.rejected);
        } catch (error) {
            console.error('Error loading ClamAV rejected:', error);
        }
    },

    async loadSystemUptime() {
        try {
            const data = await this.fetchWithRetry('/api/dashboard/system-uptime');
            const el = document.getElementById('stat-system-uptime');
            // Normalize very small uptimes to a compact form for UI
            let uptime = data.uptime || '';
            if (uptime === 'Less than 1 minute') uptime = '< 1 minute';
            if (el) el.textContent = uptime;
        } catch (error) {
            console.error('Error loading system uptime:', error);
        }
    }
};

// Initialise dashboard when DOM is ready
let initAttempts = 0;
const maxAttempts = 50; // 5 seconds max

function initDashboard() {
    initAttempts++;
    if (typeof GridStack === 'undefined') {
        if (initAttempts >= maxAttempts) {
            console.error('GridStack failed to load after 5 seconds');
            alert('Dashboard initialisation timeout. GridStack library did not load. Please check:\n\n1. Network tab in Developer Tools (F12)\n2. Your internet connection\n3. Firewall/antivirus blocking CDNs');
            return;
        }
        setTimeout(initDashboard, 100);
        return;
    }
    DashboardManager.init();
}

document.addEventListener('DOMContentLoaded', () => {
    initDashboard();
});
</script>

{% endblock %}


