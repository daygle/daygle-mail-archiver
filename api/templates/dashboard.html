{% extends "base.html" %}

{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
<!-- GridStack CSS (Local) -->
<link rel="stylesheet" href="/static/vendor/gridstack.min.css" />
<link rel="stylesheet" href="/static/vendor/gridstack-extra.min.css" />
<style>
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
/* Responsive stat boxes for Overview and ClamAV widgets */
.stats-grid-container {
    align-content: start;
}
.stat-box {
    transition: all 0.2s ease;
}
.stat-box .stat-icon {
    flex-shrink: 0;
    position: static !important;
    opacity: 1 !important;
    transform: none !important;
}
/* Modal styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}
.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
}
.modal-content {
    position: relative;
    background: var(--bg-primary);
    border-radius: var(--radius-lg);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    z-index: 1;
}
.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
}
/* Widget action buttons in edit mode */
.widget-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: none;
    gap: 4px;
    z-index: 100;
}
.grid-stack.edit-mode .widget-actions {
    display: flex;
}
.widget-action-btn {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    cursor: pointer;
    color: var(--text-primary);
    font-size: 0.85rem;
    transition: all 0.2s;
}
.widget-action-btn:hover {
    background: var(--accent-primary);
    color: white;
    border-color: var(--accent-primary);
}
.widget-action-btn.danger:hover {
    background: #ef4444;
    border-color: #ef4444;
}
.widget-settings-btn:hover {
    background: #f59e0b;
    border-color: #f59e0b;
}
.widget-selector-item {
    padding: 0.75rem 1rem;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: all 0.2s;
}
.widget-selector-item:hover {
    background: var(--accent-primary);
    color: white;
}
.widget-selector-item.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.widget-selector-item.disabled:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}
</style>
{% endblock %}

{% block content %}
<!-- Customization Toolbar -->
<div class="dashboard-toolbar">
    <div class="toolbar-left">
    </div>
    <div class="toolbar-right">
        <button id="btn-customize" class="btn btn-secondary" title="Customize Dashboard">
            <i class="fas fa-cog"></i>
        </button>
        <button id="btn-add-widget" class="btn btn-info" style="display: none;" title="Add Widget">
            <i class="fas fa-plus"></i>
        </button>
        <button id="btn-save-layout" class="btn btn-primary" style="display: none;" title="Save Layout">
            <i class="fas fa-save"></i>
        </button>
        <button id="btn-reset-layout" class="btn btn-warning" style="display: none;" title="Reset Layout">
            <i class="fas fa-undo"></i>
        </button>
        <button id="btn-cancel" class="btn btn-secondary" style="display: none;" title="Cancel">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<!-- Widget Selector Modal (Hidden by default) -->
<div id="widget-selector-modal" class="modal" style="display: none;">
    <div class="modal-overlay" id="modal-overlay"></div>
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3><i class="fas fa-plus-circle"></i> Add Widgets</h3>
            <button class="btn-icon" id="btn-close-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p class="text-muted" style="margin-bottom: 1rem;">Select widgets to add to your dashboard:</p>
            <div id="widget-selector-list" style="display: grid; gap: 0.5rem;"></div>
        </div>
    </div>
</div>

<!-- Widget Settings Modal (Hidden by default) -->
<div id="widget-settings-modal" class="modal" style="display: none;">
    <div class="modal-overlay" id="settings-modal-overlay"></div>
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3><i class="fas fa-cog"></i> Widget Settings</h3>
            <button class="btn-icon" id="btn-close-settings-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="widget-settings-content">
                <div class="form-group">
                    <label for="widget-days-range" class="form-label">Days to Display</label>
                    <select id="widget-days-range" class="form-select">
                        <option value="7">7 days</option>
                        <option value="14">14 days</option>
                        <option value="30" selected>30 days</option>
                        <option value="60">60 days</option>
                        <option value="90">90 days</option>
                    </select>
                    <small class="form-text">Select the number of days to display in the chart</small>
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button id="btn-cancel-settings" class="btn btn-secondary">Cancel</button>
                <button id="btn-save-settings" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- GridStack Dashboard -->
<div class="grid-stack" id="dashboard-grid">
    <!-- Widgets will be dynamically added here -->
</div>

<!-- Widget Templates (Hidden) -->
<div style="display: none;">
    <!-- Overview Stats Widget Template -->
    <div id="template-overview" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-chart-line"></i>
                <span>Overview</span>
            </div>
        </div>
        <div class="widget-body">
            <div class="stats-grid-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                <div class="stat-box" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius-md); min-width: 0;">
                    <div class="stat-icon" style="width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; background: rgba(59, 130, 246, 0.1); border-radius: var(--radius-md); color: #3b82f6; font-size: 1.25rem;">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div style="flex: 1; min-width: 0; overflow: hidden;">
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Total Emails</div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="overview-total-emails">-</div>
                    </div>
                </div>
                <div class="stat-box" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius-md); min-width: 0;">
                    <div class="stat-icon" style="width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-md); color: #10b981; font-size: 1.25rem;">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div style="flex: 1; min-width: 0; overflow: hidden;">
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Emails Today</div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="overview-emails-today">-</div>
                    </div>
                </div>
                <div class="stat-box" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius-md); min-width: 0;">
                    <div class="stat-icon" style="width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-md); color: #f59e0b; font-size: 1.25rem;">
                        <i class="fas fa-database"></i>
                    </div>
                    <div style="flex: 1; min-width: 0; overflow: hidden;">
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Database Size</div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="overview-db-size">-</div>
                    </div>
                </div>
                <div class="stat-box" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius-md); min-width: 0;">
                    <div class="stat-icon" style="width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; background: rgba(139, 92, 246, 0.1); border-radius: var(--radius-md); color: #8b5cf6; font-size: 1.25rem;">
                        <i class="fas fa-server"></i>
                    </div>
                    <div style="flex: 1; min-width: 0; overflow: hidden;">
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Active Accounts</div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="overview-accounts">-</div>
                    </div>
                </div>
                <div class="stat-box" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius-md); min-width: 0;">
                    <div class="stat-icon" style="width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; background: rgba(34, 197, 94, 0.1); border-radius: var(--radius-md); color: #22c55e; font-size: 1.25rem;">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div style="flex: 1; min-width: 0; overflow: hidden;">
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Workers Online</div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="overview-workers">-</div>
                    </div>
                </div>
            </div>
            
            <!-- System Update Notification -->
            <div id="system-update-banner" style="display: none; margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: var(--radius-md); position: relative;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: rgba(59, 130, 246, 0.2); border-radius: var(--radius-md); color: #3b82f6; font-size: 1.5rem;">
                        <i class="fas fa-download"></i>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">
                            <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                            System Update Available
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;" id="update-details">
                            Loading update information...
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <a href="#" onclick="DashboardManager.showUpdateInstructions(); return false;" class="btn btn-sm btn-primary" style="text-decoration: none;">
                                <i class="fas fa-book"></i> View Instructions
                            </a>
                            <button onclick="DashboardManager.dismissUpdateBanner()" class="btn btn-sm btn-ghost">
                                <i class="fas fa-times"></i> Dismiss
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emails Per Day Chart Template -->
    <div id="template-emails-per-day" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn widget-settings-btn" data-action="settings" data-widget="emails-per-day" title="Widget settings">
                <i class="fas fa-cog"></i>
            </button>
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-chart-line"></i>
                <span id="emails-per-day-title">Emails Per Day (30d)</span>
            </div>
            
        </div>
        <div class="widget-body">
            <canvas id="emailsPerDayChart"></canvas>
        </div>
    </div>

    <!-- Top Senders Chart Template -->
    <div id="template-top-senders" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-paper-plane"></i>
                <span>Top 10 Senders</span>
            </div>
            
        </div>
        <div class="widget-body">
            <canvas id="topSendersChart"></canvas>
        </div>
    </div>

    <!-- Top Receivers Chart Template -->
    <div id="template-top-receivers" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-inbox"></i>
                <span>Top 10 Receivers</span>
            </div>
            
        </div>
        <div class="widget-body">
            <canvas id="topReceiversChart"></canvas>
        </div>
    </div>

    <!-- Deletion Stats Chart Template -->
    <div id="template-deletion-stats" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn widget-settings-btn" data-action="settings" data-widget="deletion-stats" title="Widget settings">
                <i class="fas fa-cog"></i>
            </button>
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-trash-alt"></i>
                <span id="deletion-stats-title">Email Deletions (30d)</span>
            </div>
            
        </div>
        <div class="widget-body">
            <canvas id="deletionStatsChart"></canvas>
        </div>
    </div>

    <!-- Recent Activity Template -->
    <div id="template-recent-activity" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-history"></i>
                <span>Recent Activity</span>
            </div>
            
        </div>
        <div class="widget-body">
            <div id="recent-activity-list" class="activity-list">
                <div class="spinner-center"><span class="spinner"></span></div>
            </div>
        </div>
    </div>

    <!-- Storage Trends Template -->
    <div id="template-storage-trends" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn widget-settings-btn" data-action="settings" data-widget="storage-trends" title="Widget settings">
                <i class="fas fa-cog"></i>
            </button>
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-chart-area"></i>
                <span id="storage-trends-title">Storage Trends (7d)</span>
            </div>
            
        </div>
        <div class="widget-body">
            <canvas id="storageTrendsChart"></canvas>
        </div>
    </div>

    <!-- Account Health Template -->
    <div id="template-account-health" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-heartbeat"></i>
                <span>Account Health</span>
            </div>
            
        </div>
        <div class="widget-body">
            <div id="account-health-list" class="health-list">
                <div class="spinner-center"><span class="spinner"></span></div>
            </div>
        </div>
    </div>

    <!-- ClamAV Virus Scanning Stats Template -->
    <div id="template-clamav-stats" class="grid-stack-item-content widget-card">
        <div class="widget-actions">
            <button class="widget-action-btn danger" data-action="remove" title="Remove widget">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="widget-header">
            <div class="widget-title">
                <i class="fas fa-shield-virus"></i>
                <span>ClamAV Virus Scanning</span>
            </div>
            
        </div>
        <div class="widget-body">
            <div class="stats-grid-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                <div class="stat-box" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius-md); min-width: 0;">
                    <div class="stat-icon" style="width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-md); color: #ef4444; font-size: 1.25rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div style="flex: 1; min-width: 0; overflow: hidden;">
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Quarantined</div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="clamav-quarantine">-</div>
                    </div>
                </div>
                <div class="stat-box" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius-md); min-width: 0;">
                    <div class="stat-icon" style="width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-md); color: #f59e0b; font-size: 1.25rem;">
                        <i class="fas fa-ban"></i>
                    </div>
                    <div style="flex: 1; min-width: 0; overflow: hidden;">
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Rejected</div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="clamav-reject">-</div>
                    </div>
                </div>
                <div class="stat-box" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius-md); min-width: 0;">
                    <div class="stat-icon" style="width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; background: rgba(59, 130, 246, 0.1); border-radius: var(--radius-md); color: #3b82f6; font-size: 1.25rem;">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div style="flex: 1; min-width: 0; overflow: hidden;">
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Logged Only</div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="clamav-log">-</div>
                    </div>
                </div>
                <div class="stat-box" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: var(--radius-md); min-width: 0;">
                    <div class="stat-icon" style="width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; background: rgba(16, 185, 129, 0.1); border-radius: var(--radius-md); color: #10b981; font-size: 1.25rem;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div style="flex: 1; min-width: 0; overflow: hidden;">
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Clean</div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="clamav-clean">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- GridStack JS (Local) -->
<script>
console.log('Loading GridStack from local files...');
</script>
<script src="/static/vendor/gridstack-all.js" 
        onload="console.log('GridStack loaded successfully');" 
        onerror="console.error('Failed to load local GridStack library')"></script>

<!-- Chart.js (Local) -->
<script src="/static/vendor/chart.min.js"></script>

<script>
// Dashboard Widget Manager
const DashboardManager = {
    grid: null,
    charts: {},
    editMode: false,
    widgetSettings: {
        'emails-per-day': { days: 30 },
        'deletion-stats': { days: 30 },
        'storage-trends': { days: 7 }
    },
    currentSettingsWidget: null,
    
    // Default widget layout
    defaultWidgets: [
        { id: 'overview', x: 0, y: 0, w: 12, h: 3, visible: true },
        { id: 'emails-per-day', x: 0, y: 3, w: 6, h: 3, visible: true },
        { id: 'deletion-stats', x: 6, y: 3, w: 6, h: 3, visible: true },
        { id: 'top-senders', x: 0, y: 6, w: 6, h: 4, visible: true },
        { id: 'top-receivers', x: 6, y: 6, w: 6, h: 4, visible: true },
        { id: 'clamav-stats', x: 0, y: 10, w: 6, h: 3, visible: true },
        { id: 'recent-activity', x: 6, y: 10, w: 6, h: 4, visible: true },
        { id: 'storage-trends', x: 0, y: 13, w: 6, h: 4, visible: true },
        { id: 'account-health', x: 6, y: 13, w: 6, h: 4, visible: true }
    ],

    init() {
        // Check if GridStack is loaded
        if (typeof GridStack === 'undefined') {
            console.error('GridStack library not loaded - CDN might be blocked or unavailable');
            alert('Dashboard failed to load: GridStack library not available. Please check your internet connection and refresh the page.');
            return;
        }

        // Initialize GridStack
        try {
            console.log('Initializing GridStack...');
            this.grid = GridStack.init({
                column: 12,
                cellHeight: 80,
                margin: 20,
                float: false,
                disableOneColumnMode: true,
                animate: true,
                draggable: { handle: '.widget-header' }
            });

            console.log('GridStack initialized successfully');

            // Disable editing by default
            this.grid.disable();

            // Load user preferences or use defaults
            this.loadLayout();

            // Setup event listeners
            this.setupEventListeners();
            
            console.log('Dashboard initialization complete');
        } catch (error) {
            console.error('Error initializing dashboard:', error);
            console.error('Error stack:', error.stack);
            alert('Dashboard failed to initialize: ' + error.message + '\n\nCheck the browser console for more details.');
        }
    },

    async loadLayout() {
        try {
            console.log('Loading dashboard layout...');
            const response = await fetch('/api/dashboard/preferences');
            console.log('Preferences response status:', response.status);
            
            if (!response.ok) {
                console.warn('Preferences API returned error, using defaults');
                await this.loadWidgetSettingsFromPreferences();
                this.renderWidgets(this.defaultWidgets);
                return;
            }
            
            const data = await response.json();
            console.log('Preferences data:', data);
            
            let widgets = data.widgets && data.widgets.length > 0 
                ? data.widgets.map(w => ({
                    id: w.widget_id,
                    x: w.x,
                    y: w.y,
                    w: w.w,
                    h: w.h,
                    visible: w.visible
                  }))
                : this.defaultWidgets;

            // Drop any widgets that do not have a matching template (avoids corrupted saved layouts)
            widgets = widgets.filter(w => this.templateExists(w.id));

            // If everything was filtered out, fall back to defaults
            if (widgets.length === 0) {
                console.warn('No valid widgets found in preferences, using defaults');
                widgets = this.defaultWidgets;
            }

            // If only a single widget is visible (likely from a broken prior save), reset to defaults
            const visibleCount = widgets.filter(w => w.visible).length;
            if (visibleCount <= 1) {
                console.warn('Only one widget visible from preferences; reverting to defaults');
                widgets = this.defaultWidgets;
            }

            console.log('Using widgets:', widgets);
            
            // Load widget settings before rendering
            await this.loadWidgetSettingsFromPreferences();
            
            this.renderWidgets(widgets);
        } catch (error) {
            console.error('Error loading layout:', error);
            console.log('Falling back to default widgets');
            await this.loadWidgetSettingsFromPreferences();
            this.renderWidgets(this.defaultWidgets);
        }
    },

    renderWidgets(widgets) {
        // Clear existing widgets
        this.grid.removeAll();

        // Ensure we have something visible; if not, revert to defaults
        const hasVisible = widgets.some(w => w.visible);
        const listToRender = hasVisible ? widgets : this.defaultWidgets;

        // Add each visible widget
        listToRender.forEach(widget => {
            if (widget.visible) {
                this.addWidget(widget);
            }
        });

        // Wait for widgets to be added to DOM before loading data
        setTimeout(() => {
            this.loadAllData();
        }, 100);
    },

    addWidget(config) {
        const template = document.getElementById(`template-${config.id}`);
        if (!template) {
            console.warn(`Template for widget '${config.id}' not found; skipping`);
            return;
        }

        const content = template.cloneNode(true);
        content.id = `widget-${config.id}`;
        content.style.display = 'block';

        this.grid.addWidget({
            x: config.x,
            y: config.y,
            w: config.w,
            h: config.h,
            content: content.outerHTML,
            id: config.id
        });
    },

    templateExists(id) {
        return Boolean(document.getElementById(`template-${id}`));
    },

    setupEventListeners() {
        console.log('setupEventListeners called');
        
        // Customize button
        const customizeBtn = document.getElementById('btn-customize');
        console.log('Customize button:', customizeBtn);
        if (!customizeBtn) {
            console.error('Customize button not found!');
            return;
        }
        console.log('Setting up customize button listener');
        customizeBtn.addEventListener('click', () => {
            console.log('Customize button clicked');
            this.toggleEditMode();
        });

        // Add widget button
        const addWidgetBtn = document.getElementById('btn-add-widget');
        console.log('Add widget button:', addWidgetBtn);
        if (!addWidgetBtn) {
            console.error('Add widget button not found!');
            return;
        }
        console.log('Setting up add widget button listener');
        addWidgetBtn.addEventListener('click', () => {
            console.log('Add widget button clicked');
            this.showWidgetSelector();
        });

        // Save layout button
        console.log('Setting up save layout button listener');
        document.getElementById('btn-save-layout').addEventListener('click', () => {
            this.saveLayout();
        });

        // Reset layout button
        console.log('Setting up reset layout button listener');
        document.getElementById('btn-reset-layout').addEventListener('click', () => {
            if (confirm('Reset dashboard to default layout?')) {
                this.renderWidgets(this.defaultWidgets);
                this.saveLayout();
            }
        });

        // Cancel button
        console.log('Setting up cancel button listener');
        document.getElementById('btn-cancel').addEventListener('click', () => {
            this.cancelEdit();
        });

        // Close modal button
        console.log('Setting up close modal button listener');
        document.getElementById('btn-close-modal').addEventListener('click', () => {
            this.hideModal(document.getElementById('widget-selector-modal'));
        });

        // Modal overlay click
        console.log('Setting up modal overlay listener');
        document.getElementById('modal-overlay').addEventListener('click', () => {
            this.hideModal(document.getElementById('widget-selector-modal'));
        });

        // Widget settings modal listeners
        document.getElementById('btn-close-settings-modal').addEventListener('click', () => {
            this.hideModal(document.getElementById('widget-settings-modal'));
        });
        
        document.getElementById('settings-modal-overlay').addEventListener('click', () => {
            this.hideModal(document.getElementById('widget-settings-modal'));
        });
        
        document.getElementById('btn-cancel-settings').addEventListener('click', () => {
            this.hideModal(document.getElementById('widget-settings-modal'));
        });
        
        document.getElementById('btn-save-settings').addEventListener('click', () => {
            this.saveWidgetSettings();
        });

        // Widget action buttons (delegated event handling)
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.widget-action-btn');
            if (!btn || !this.editMode) return;

            const action = btn.getAttribute('data-action');
            const widgetElement = btn.closest('.grid-stack-item');
            
            if (action === 'remove' && widgetElement) {
                this.grid.removeWidget(widgetElement);
            } else if (action === 'settings') {
                const widgetId = btn.getAttribute('data-widget');
                this.showWidgetSettings(widgetId);
            }
        });

        // Grid change event
        this.grid.on('change', () => {
            if (this.editMode) {
                // Auto-save is optional, could add debounce here
            }
        });
    },

    toggleEditMode() {
        this.editMode = !this.editMode;

        if (this.editMode) {
            this.grid.enable();
            document.getElementById('btn-customize').style.display = 'none';
            document.getElementById('btn-add-widget').style.display = 'inline-block';
            document.getElementById('btn-save-layout').style.display = 'inline-block';
            document.getElementById('btn-reset-layout').style.display = 'inline-block';
            document.getElementById('btn-cancel').style.display = 'inline-block';
            document.querySelector('.grid-stack').classList.add('edit-mode');
        } else {
            this.grid.disable();
            document.getElementById('btn-customize').style.display = 'inline-block';
            document.getElementById('btn-add-widget').style.display = 'none';
            document.getElementById('btn-save-layout').style.display = 'none';
            document.getElementById('btn-reset-layout').style.display = 'none';
            document.getElementById('btn-cancel').style.display = 'none';
            document.querySelector('.grid-stack').classList.remove('edit-mode');
        }
    },

    cancelEdit() {
        // Exit edit mode
        this.editMode = true; // Set to true so toggleEditMode will set it to false
        this.toggleEditMode();
        
        // Reload saved layout to discard changes
        this.loadLayout();
    },

    showWidgetSelector() {
        console.log('showWidgetSelector called');
        const modal = document.getElementById('widget-selector-modal');
        const container = document.getElementById('widget-selector-list');
        
        if (!modal || !container) {
            console.error('Modal or container not found', { modal, container });
            return;
        }
        
        console.log('Modal and container found');
        container.innerHTML = '';

        // Get currently visible widgets
        const visibleWidgets = new Set();
        const items = this.grid.getGridItems();
        items.forEach(item => {
            if (item.gridstackNode) {
                visibleWidgets.add(item.gridstackNode.id);
            }
        });
        
        console.log('Visible widgets:', Array.from(visibleWidgets));

        // Show all available widgets
        this.defaultWidgets.forEach(widget => {
            const isVisible = visibleWidgets.has(widget.id);
            const item = document.createElement('div');
            item.className = 'widget-selector-item' + (isVisible ? ' disabled' : '');
            item.innerHTML = `
                <div>
                    <strong>${this.getWidgetTitle(widget.id)}</strong>
                </div>
                <div>
                    ${isVisible ? '<i class="fas fa-check"></i> Added' : '<i class="fas fa-plus"></i> Add'}
                </div>
            `;
            
            if (!isVisible) {
                item.addEventListener('click', () => {
                    console.log('Adding widget:', widget.id);
                    this.addWidget(widget);
                    this.loadWidgetData(widget.id);
                    this.hideModal(modal);
                });
            }
            
            container.appendChild(item);
        });

        console.log('Showing modal');
        this.showModal(modal);
    },

    showModal(modal) {
        modal.style.display = 'flex';
        modal.classList.add('show');
    },

    hideModal(modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 150);
    },

    showWidgetSettings(widgetId) {
        this.currentSettingsWidget = widgetId;
        const modal = document.getElementById('widget-settings-modal');
        const daysSelect = document.getElementById('widget-days-range');
        
        // Load current settings
        const settings = this.widgetSettings[widgetId] || { days: 30 };
        daysSelect.value = settings.days;
        
        this.showModal(modal);
    },

    saveWidgetSettings() {
        if (!this.currentSettingsWidget) return;
        
        const daysSelect = document.getElementById('widget-days-range');
        const days = parseInt(daysSelect.value);
        
        // Update settings
        this.widgetSettings[this.currentSettingsWidget] = { days };
        
        // Save to preferences
        this.saveWidgetSettingsToPreferences();
        
        // Update widget title
        this.updateWidgetTitle(this.currentSettingsWidget, days);
        
        // Reload widget data with new settings
        this.loadWidgetData(this.currentSettingsWidget);
        
        // Hide modal
        this.hideModal(document.getElementById('widget-settings-modal'));
        
        this.showFlashMessage('Widget settings saved successfully!', 'success');
    },

    async saveWidgetSettingsToPreferences() {
        // Create and submit a form to save widget settings
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/api/dashboard/widget-settings';
        form.style.display = 'none';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'settings';
        input.value = JSON.stringify(this.widgetSettings);
        form.appendChild(input);

        document.body.appendChild(form);
        form.submit();
    },

    async loadWidgetSettingsFromPreferences() {
        try {
            const response = await fetch('/api/dashboard/widget-settings');
            if (response.ok) {
                const data = await response.json();
                if (data.settings) {
                    this.widgetSettings = { ...this.widgetSettings, ...data.settings };
                    
                    // Update titles for all widgets with custom settings
                    Object.keys(this.widgetSettings).forEach(widgetId => {
                        this.updateWidgetTitle(widgetId, this.widgetSettings[widgetId].days);
                    });
                }
            }
        } catch (error) {
            console.error('Error loading widget settings:', error);
        }
    },

    updateWidgetTitle(widgetId, days) {
        const titleElement = document.getElementById(`${widgetId}-title`);
        if (titleElement) {
            const widgetNames = {
                'emails-per-day': 'Emails Per Day',
                'deletion-stats': 'Email Deletions',
                'storage-trends': 'Storage Trends'
            };
            const name = widgetNames[widgetId] || widgetId;
            titleElement.textContent = `${name} (${days}d)`;
        }
    },

    async saveLayout() {
        const widgets = [];
        const items = this.grid.getGridItems();
        
        items.forEach(item => {
            const node = item.gridstackNode;
            widgets.push({
                widget_id: node.id,
                x: node.x,
                y: node.y,
                w: node.w,
                h: node.h,
                visible: true
            });
        });

        // Add hidden widgets
        this.defaultWidgets.forEach(dw => {
            if (!widgets.find(w => w.widget_id === dw.id)) {
                widgets.push({
                    widget_id: dw.id,
                    x: dw.x,
                    y: dw.y,
                    w: dw.w,
                    h: dw.h,
                    visible: false
                });
            }
        });

        // Create and submit a form to save the layout
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/api/dashboard/preferences';
        form.style.display = 'none';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'widgets';
        input.value = JSON.stringify(widgets);
        form.appendChild(input);

        document.body.appendChild(form);
        form.submit();
    },

    getWidgetTitle(id) {
        const titles = {
            'overview': 'Overview',
            'emails-per-day': 'Emails Per Day',
            'top-senders': 'Top Senders',
            'top-receivers': 'Top Receivers',
            'deletion-stats': 'Deletion Stats',
            'clamav-stats': 'ClamAV Virus Scanning',
            'recent-activity': 'Recent Activity',
            'storage-trends': 'Storage Trends',
            'account-health': 'Account Health'
        };
        return titles[id] || id;
    },

    // Load all widget data
    loadAllData() {
        this.loadOverview();
        this.loadEmailsPerDay();
        this.loadTopSenders();
        this.loadTopReceivers();
        this.loadDeletionStats();
        this.loadClamAVStats();
        this.loadRecentActivity();
        this.loadStorageTrends();
        this.loadAccountHealth();
    },

    loadWidgetData(widgetId) {
        const loaders = {
            'overview': () => this.loadOverview(),
            'emails-per-day': () => this.loadEmailsPerDay(),
            'top-senders': () => this.loadTopSenders(),
            'top-receivers': () => this.loadTopReceivers(),
            'deletion-stats': () => this.loadDeletionStats(),
            'clamav-stats': () => this.loadClamAVStats(),
            'recent-activity': () => this.loadRecentActivity(),
            'storage-trends': () => this.loadStorageTrends(),
            'account-health': () => this.loadAccountHealth()
        };

        if (loaders[widgetId]) {
            loaders[widgetId]();
        }
    },

    async loadOverview() {
        try {
            const response = await fetch('/api/dashboard/stats');
            const data = await response.json();
            
            const totalEmailsEl = document.getElementById('overview-total-emails');
            const emailsTodayEl = document.getElementById('overview-emails-today');
            const totalAccountsEl = document.getElementById('overview-accounts');
            const databaseSizeEl = document.getElementById('overview-db-size');
            
            if (totalEmailsEl) totalEmailsEl.textContent = data.total_emails.toLocaleString();
            if (emailsTodayEl) emailsTodayEl.textContent = data.emails_today.toLocaleString();
            if (totalAccountsEl) totalAccountsEl.textContent = data.total_accounts.toLocaleString();
            if (databaseSizeEl) databaseSizeEl.textContent = data.database_size;

            // Load system status data
            const statusResponse = await fetch('/api/dashboard/system-status');
            const statusData = await statusResponse.json();
            
            const workersEl = document.getElementById('overview-workers');
            
            if (workersEl) workersEl.textContent = statusData.workers_online;
            
            // Check for system updates
            this.checkForUpdates();
        } catch (error) {
            console.error('Error loading overview:', error);
        }
    },

    async checkForUpdates() {
        try {
            const response = await fetch('/api/dashboard/check-updates');
            
            // Check response status
            if (!response.ok) {
                console.warn(`Update check failed with status: ${response.status}`);
                return;
            }
            
            const data = await response.json();
            
            const banner = document.getElementById('system-update-banner');
            const detailsEl = document.getElementById('update-details');
            
            if (!banner || !detailsEl) return;
            
            // Check if user has dismissed this update
            const dismissedUpdate = localStorage.getItem('dismissedUpdate');
            if (dismissedUpdate === data.latest_commit) {
                banner.style.display = 'none';
                return;
            }
            
            if (data.updates_available && !data.error) {
                let detailsText = `Version ${data.latest_commit} is available`;
                if (data.commits_behind > 0) {
                    detailsText += ` (${data.commits_behind} commit${data.commits_behind > 1 ? 's' : ''} behind)`;
                }
                if (data.latest_message) {
                    detailsText += `: ${data.latest_message}`;
                }
                
                detailsEl.textContent = detailsText;
                banner.style.display = 'block';
            } else {
                banner.style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking for updates:', error);
            // Silently fail - don't show error to user
        }
    },

    dismissUpdateBanner() {
        const banner = document.getElementById('system-update-banner');
        if (banner) {
            banner.style.display = 'none';
            
            // Remember dismissal for this specific update
            fetch('/api/dashboard/check-updates')
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP ${r.status}`);
                    }
                    return r.json();
                })
                .then(data => {
                    if (data.latest_commit) {
                        localStorage.setItem('dismissedUpdate', data.latest_commit);
                    }
                })
                .catch(err => console.error('Error saving dismissal:', err));
        }
    },

    showUpdateInstructions() {
        const message = `To update Daygle Mail Archiver:

1. Connect to your server via SSH
2. Navigate to the installation directory:
   cd /opt/daygle-mail-archiver

3. Check what will be updated:
   ./update.sh --check

4. Run the update (with automatic backup):
   ./update.sh

The update script will:
• Create an automatic backup
• Pull the latest code
• Update Docker images
• Restart containers

For more options, run: ./update.sh --help`;

        alert(message);
    },

    async loadEmailsPerDay() {
        try {
            const days = this.widgetSettings['emails-per-day']?.days || 30;
            const response = await fetch(`/api/dashboard/emails-per-day?days=${days}`);
            const data = await response.json();
            
            const ctx = document.getElementById('emailsPerDayChart');
            if (!ctx) return;

            if (this.charts.emailsPerDay) {
                this.charts.emailsPerDay.destroy();
            }

            this.charts.emailsPerDay = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Emails',
                        data: data.data,
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        } catch (error) {
            console.error('Error loading emails per day:', error);
        }
    },

    async loadTopSenders() {
        try {
            const response = await fetch('/api/dashboard/top-senders');
            const data = await response.json();
            
            const ctx = document.getElementById('topSendersChart');
            if (!ctx) return;

            if (this.charts.topSenders) {
                this.charts.topSenders.destroy();
            }

            this.charts.topSenders = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Emails Sent',
                        data: data.data,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                                        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } }
                }
            });
        } catch (error) {
            console.error('Error loading top senders:', error);
        }
    },

    async loadTopReceivers() {
        try {
            const response = await fetch('/api/dashboard/top-receivers');
            const data = await response.json();
            
            const ctx = document.getElementById('topReceiversChart');
            if (!ctx) return;

            if (this.charts.topReceivers) {
                this.charts.topReceivers.destroy();
            }

            this.charts.topReceivers = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Emails Received',
                        data: data.data,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                                        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } }
                }
            });
        } catch (error) {
            console.error('Error loading top receivers:', error);
        }
    },

    async loadDeletionStats() {
        try {
            const days = this.widgetSettings['deletion-stats']?.days || 30;
            const response = await fetch(`/api/dashboard/deletion-stats?days=${days}`);
            const data = await response.json();
            
            const ctx = document.getElementById('deletionStatsChart');
            if (!ctx) return;

            if (this.charts.deletionStats) {
                this.charts.deletionStats.destroy();
            }

            this.charts.deletionStats = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Manual',
                            data: data.manual,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)'
                        },
                        {
                            label: 'Retention',
                            data: data.retention,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)'
                        },
                        {
                            label: 'From Server',
                            data: data.deleted_from_server,
                            backgroundColor: 'rgba(255, 206, 86, 0.6)',
                            type: 'line'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true } }
                }
            });
        } catch (error) {
            console.error('Error loading deletion stats:', error);
        }
    },

    async loadRecentActivity() {
        try {
            const response = await fetch('/api/dashboard/recent-activity');
            const data = await response.json();
            
            const container = document.getElementById('recent-activity-list');
            if (!container) return;

            if (data.activities.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No recent activity</p>';
                return;
            }

            container.innerHTML = data.activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon"><i class="fas fa-envelope"></i></div>
                    <div class="activity-content">
                        <div class="activity-title">${activity.subject}</div>
                        <div class="activity-meta">
                            <span><i class="fas fa-user"></i> ${activity.sender}</span>
                            <span><i class="fas fa-clock"></i> ${activity.date}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading recent activity:', error);
        }
    },

    async loadStorageTrends() {
        try {
            const days = this.widgetSettings['storage-trends']?.days || 7;
            const response = await fetch(`/api/dashboard/storage-trends?days=${days}`);
            const data = await response.json();
            
            const ctx = document.getElementById('storageTrendsChart');
            if (!ctx) return;

            if (this.charts.storageTrends) {
                this.charts.storageTrends.destroy();
            }

            this.charts.storageTrends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Storage (MB)',
                        data: data.sizes,
                        borderColor: '#9966FF',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        } catch (error) {
            console.error('Error loading storage trends:', error);
        }
    },

    async loadAccountHealth() {
        try {
            const response = await fetch('/api/dashboard/account-health');
            const data = await response.json();
            
            const container = document.getElementById('account-health-list');
            if (!container) return;

            if (!data.accounts || data.accounts.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No accounts configured</p>';
                return;
            }

            const statusColors = {
                'healthy': 'success',
                'disabled': 'secondary',
                'error': 'danger',
                'never_fetched': 'warning'
            };

            const statusIcons = {
                'healthy': 'check-circle',
                'disabled': 'ban',
                'error': 'exclamation-circle',
                'never_fetched': 'clock'
            };

            container.innerHTML = data.accounts.map(account => `
                <div class="health-item">
                    <div class="health-icon health-${statusColors[account.status]}">
                        <i class="fas fa-${statusIcons[account.status]}"></i>
                    </div>
                    <div class="health-content">
                        <div class="health-email">${account.email}</div>
                        <div class="health-meta">Last fetch: ${account.last_fetch}</div>
                        ${account.error ? `<div class="health-error">${account.error}</div>` : ''}
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading account health:', error);
            const container = document.getElementById('account-health-list');
            if (container) {
                container.innerHTML = '<p class="text-muted text-center">Error loading account health</p>';
            }
        }
    },

    async loadClamAVStats() {
        try {
            const response = await fetch('/api/dashboard/clamav-stats');
            const data = await response.json();
            
            const quarantineEl = document.getElementById('clamav-quarantine');
            const rejectEl = document.getElementById('clamav-reject');
            const logEl = document.getElementById('clamav-log');
            const cleanEl = document.getElementById('clamav-clean');
            
            if (quarantineEl) quarantineEl.textContent = data.quarantined.toLocaleString();
            if (rejectEl) rejectEl.textContent = data.rejected.toLocaleString();
            if (logEl) logEl.textContent = data.logged.toLocaleString();
            if (cleanEl) cleanEl.textContent = data.clean.toLocaleString();
        } catch (error) {
            console.error('Error loading ClamAV stats:', error);
        }
    }
};

// Initialize dashboard when DOM is ready
let initAttempts = 0;
const maxAttempts = 50; // 5 seconds max

function initDashboard() {
    initAttempts++;
    if (typeof GridStack === 'undefined') {
        console.log(`GridStack not loaded yet, waiting... (attempt ${initAttempts}/${maxAttempts})`);
        if (initAttempts >= maxAttempts) {
            console.error('GridStack failed to load after 5 seconds');
            alert('Dashboard initialization timeout. GridStack library did not load. Please check:\n\n1. Network tab in Developer Tools (F12)\n2. Your internet connection\n3. Firewall/antivirus blocking CDNs');
            return;
        }
        setTimeout(initDashboard, 100);
        return;
    }
    console.log('GridStack detected, initializing dashboard...');
    DashboardManager.init();
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, checking for GridStack...');
    initDashboard();
});
</script>

{% endblock %}


