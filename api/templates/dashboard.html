{% extends "base.html" %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Stats Cards Grid -->
<div class="stats-grid">
    <div class="stat-card stat-card-primary">
        <div class="stat-icon">
            <i class="fas fa-envelope"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Total Emails</div>
            <div class="stat-value" id="stat-total-emails">
                <span class="spinner"></span>
            </div>
        </div>
    </div>

    <div class="stat-card stat-card-success">
        <div class="stat-icon">
            <i class="fas fa-calendar-day"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Today</div>
            <div class="stat-value" id="stat-emails-today">
                <span class="spinner"></span>
            </div>
        </div>
    </div>

    <div class="stat-card stat-card-info">
        <div class="stat-icon">
            <i class="fas fa-server"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Fetch Accounts</div>
            <div class="stat-value" id="stat-total-accounts">
                <span class="spinner"></span>
            </div>
        </div>
    </div>

    <div class="stat-card stat-card-warning">
        <div class="stat-icon">
            <i class="fas fa-database"></i>
        </div>
        <div class="stat-content">
            <div class="stat-label">Database Size</div>
            <div class="stat-value" id="stat-database-size">
                <span class="spinner"></span>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="card">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-chart-line"></i>
            <span>Emails Per Day (Last 30 Days)</span>
        </div>
    </div>
    <div class="card-body">
        <canvas id="emailsPerDayChart" style="height: 300px;"></canvas>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <div class="card-title">
            <i class="fas fa-trash-alt"></i>
            <span>Email Deletions (Last 30 Days)</span>
        </div>
    </div>
    <div class="card-body">
        <canvas id="deletionStatsChart" style="height: 300px;"></canvas>
    </div>
</div>

<div class="grid grid-cols-2 gap-4 mt-4">
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-paper-plane"></i>
                <span>Top 10 Senders</span>
            </div>
        </div>
        <div class="card-body">
            <canvas id="topSendersChart" style="height: 400px;"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-inbox"></i>
                <span>Top 10 Receivers</span>
            </div>
        </div>
        <div class="card-body">
            <canvas id="topReceiversChart" style="height: 400px;"></canvas>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
// Chart configurations
const chartColors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
];

// Load stats
async function loadStats() {
    try {
        const response = await fetch('/api/dashboard/stats');
        const data = await response.json();
        
        document.getElementById('stat-total-emails').textContent = data.total_emails.toLocaleString();
        document.getElementById('stat-emails-today').textContent = data.emails_today.toLocaleString();
        document.getElementById('stat-total-accounts').textContent = data.total_accounts.toLocaleString();
        document.getElementById('stat-database-size').textContent = data.database_size;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Emails Per Day Chart
async function loadEmailsPerDay() {
    try {
        const response = await fetch('/api/dashboard/emails-per-day');
        const data = await response.json();
        
        const ctx = document.getElementById('emailsPerDayChart');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Emails',
                    data: data.data,
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading emails per day chart:', error);
    }
}

// Top Senders Chart
async function loadTopSenders() {
    try {
        const response = await fetch('/api/dashboard/top-senders');
        const data = await response.json();
        
        const ctx = document.getElementById('topSendersChart');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Emails Sent',
                    data: data.data,
                    backgroundColor: chartColors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading top senders chart:', error);
    }
}

// Top Receivers Chart
async function loadTopReceivers() {
    try {
        const response = await fetch('/api/dashboard/top-receivers');
        const data = await response.json();
        
        const ctx = document.getElementById('topReceiversChart');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Emails Received',
                    data: data.data,
                    backgroundColor: chartColors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading top receivers chart:', error);
    }
}

// Load all data
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadEmailsPerDay();
    loadDeletionStats();
    loadTopSenders();
    loadTopReceivers();
});

// Deletion Stats Chart
async function loadDeletionStats() {
    try {
        const response = await fetch('/api/dashboard/deletion-stats');
        const data = await response.json();
        
        const ctx = document.getElementById('deletionStatsChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Manual Deletions',
                        data: data.manual,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Retention Cleanup',
                        data: data.retention,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Deleted from Mail Server',
                        data: data.deleted_from_server,
                        backgroundColor: 'rgba(255, 206, 86, 0.6)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        borderWidth: 1,
                        type: 'line'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading deletion stats:', error);
    }
}
</script>

{% endblock %}
