{% extends "base.html" %}

{% block page_title %}{{ "Edit Fetch Account" if account else "New Fetch Account" }}{% endblock %}

{% block content %}
<form method="post" action="{{ '/fetch_accounts/' ~ account.id ~ '/edit' if account else '/fetch_accounts/new' }}">
    <input type="hidden" name="account_id" value="{{ account.id if account else '' }}">

    <!-- Account Details Card -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-server"></i>
                <span>Account Details</span>
            </div>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="name" class="form-label">Account Name <span class="text-danger">*</span></label>
                <input id="name" class="form-control" name="name" value="{{ account.name if account else '' }}" placeholder="My Email Account" required>
                <small class="form-text">A friendly name to identify this account</small>
            </div>

            <div class="form-group mt-3">
                <label for="account_type" class="form-label">Account Type <span class="text-danger">*</span></label>
                <select id="account_type" class="form-select" name="account_type" required onchange="toggleAccountFields()">
                    <option value="imap" {% if not account or account.account_type == 'imap' %}selected{% endif %}>IMAP</option>
                    <option value="gmail" {% if account and account.account_type == 'gmail' %}selected{% endif %}>Gmail API</option>
                    <option value="o365" {% if account and account.account_type == 'o365' %}selected{% endif %}>Office 365 API</option>
                </select>
                <small class="form-text">Select the type of email service to fetch from</small>
            </div>
        </div>
    </div>

    <!-- IMAP Configuration Card -->
    <div id="imap_fields" class="card" style="display: none; margin-bottom: 24px;">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-envelope"></i>
                <span>IMAP Configuration</span>
            </div>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                    <label for="host" class="form-label">Host <span class="text-danger">*</span></label>
                    <input id="host" class="form-control" name="host" value="{{ account.host if account else '' }}" placeholder="imap.example.com">
                </div>

                <div class="form-group">
                    <label for="port" class="form-label">Port <span class="text-danger">*</span></label>
                    <input id="port" class="form-control" name="port" type="number" value="{{ account.port if account else '993' }}" placeholder="993">
                </div>
            </div>

            <div class="form-group" style="margin-top: 16px;">
                <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                <input id="username" class="form-control" name="username" value="{{ account.username if account else '' }}" placeholder="user@example.com">
            </div>

            <div class="form-group" style="margin-top: 16px;">
                <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
                <input id="password" class="form-control" name="password" type="password" placeholder="{{ 'Leave blank to keep existing' if account else 'Enter password' }}">
                {% if account %}
                <small class="form-text">Leave blank to keep the existing password</small>
                {% endif %}
            </div>

            <div style="margin-top: 16px;">
                <div style="margin-bottom: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="use_ssl" name="use_ssl" {% if account and account.use_ssl %}checked{% endif %}>
                        <div>
                            <strong>Use SSL/TLS</strong>
                            <small style="display: block; color: var(--text-secondary);">Recommended for secure connections (port 993)</small>
                        </div>
                    </label>
                </div>

                <div>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="require_starttls" name="require_starttls" {% if account and account.require_starttls %}checked{% endif %}>
                        <div>
                            <strong>Require STARTTLS</strong>
                            <small style="display: block; color: var(--text-secondary);">For plain connections that upgrade to TLS (port 143)</small>
                        </div>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- OAuth Configuration Card -->
    <div id="oauth_fields" class="card" style="display: none; margin-bottom: 24px;">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-key"></i>
                <span>OAuth Configuration</span>
            </div>
        </div>
        <div class="card-body">
            <div class="alert alert-info" style="margin-bottom: 24px;">
                <i class="fas fa-info-circle"></i>
                <strong>OAuth Setup Required</strong>
                <p class="mt-2 mb-2">To use Gmail or Office 365, you need to:</p>
                <ol class="mb-0" style="padding-left: 20px;">
                    <li>Create an OAuth app in Google/Microsoft developer console</li>
                    <li>Enter your Client ID and Client Secret below</li>
                    <li>Save the account</li>
                    <li>Click "Authorize" to grant access</li>
                </ol>
            </div>

            <div class="form-group">
                <label for="oauth_client_id" class="form-label">OAuth Client ID <span class="text-danger">*</span></label>
                <input id="oauth_client_id" class="form-control" name="oauth_client_id" value="{{ account.oauth_client_id if account else '' }}" placeholder="Enter your OAuth Client ID">
                <small class="form-text">From your Google/Microsoft OAuth app</small>
            </div>

            <div class="form-group mt-3">
                <label for="oauth_client_secret" class="form-label">OAuth Client Secret <span class="text-danger">*</span></label>
                <input id="oauth_client_secret" class="form-control" name="oauth_client_secret" type="password" value="{{ account.oauth_client_secret if account else '' }}" placeholder="Enter your OAuth Client Secret">
                <small class="form-text">Keep this secret secure</small>
            </div>

            {% if account and account.oauth_client_id %}
            <div class="mt-4">
                {% if account.oauth_refresh_token %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> OAuth authorized successfully
                    {% if account.oauth_token_expiry %}
                        <br><small>Token expires: {{ account.oauth_token_expiry.strftime('%Y-%m-%d %H:%M UTC') }}</small>
                    {% endif %}
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> OAuth not yet authorized - please authorize after saving
                </div>
                {% endif %}

                {% if account.account_type == 'gmail' %}
                <a href="/oauth/gmail/start/{{ account.id }}" class="btn btn-danger">
                    <i class="fab fa-google"></i>
                    <span>Authorize Gmail</span>
                </a>
                {% elif account.account_type == 'o365' %}
                <a href="/oauth/o365/start/{{ account.id }}" class="btn btn-primary">
                    <i class="fab fa-microsoft"></i>
                    <span>Authorize Office 365</span>
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Fetch Settings Card -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header">
            <div class="card-title">
                <i class="fas fa-cog"></i>
                <span>Fetch Settings</span>
            </div>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="poll_interval_common" class="form-label">Poll Interval (seconds)</label>
                <input id="poll_interval_common" class="form-control" name="poll_interval_seconds" type="number" value="{{ account.poll_interval_seconds if account else '300' }}" min="60" placeholder="300" style="max-width: 200px;">
                <small class="form-text">How often to check for new emails (minimum 60 seconds)</small>
            </div>

            <div style="margin-top: 24px;">
                <div style="margin-bottom: 16px;">
                    <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="delete_after" name="delete_after_processing" {% if account and account.delete_after_processing %}checked{% endif %}>
                        <div>
                            <strong>Delete Email After Processing</strong>
                            <small style="display: block; color: var(--text-secondary);">
                                Gmail: moves to Trash | Office 365: moves to Deleted Items | IMAP: marks as deleted (recoverable)
                            </small>
                        </div>
                    </label>
                </div>

                <div id="expunge_deleted_group" style="display: none; margin-bottom: 16px;">
                    <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="expunge_deleted" name="expunge_deleted" {% if account and account.expunge_deleted %}checked{% endif %}>
                        <div>
                            <strong>Permanently Expunge Deleted (IMAP only)</strong>
                            <small style="display: block; color: var(--danger);">⚠️ Warning: Permanently removes deleted emails from server - cannot be recovered</small>
                        </div>
                    </label>
                </div>

                <div>
                    <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="enabled" name="enabled" {% if not account or account.enabled %}checked{% endif %}>
                        <div>
                            <strong>Enabled</strong>
                            <small style="display: block; color: var(--text-secondary);">Enable automatic email fetching for this account</small>
                        </div>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-3">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i>
            <span>{{ "Update Account" if account else "Create Account" }}</span>
        </button>
        <a href="/fetch_accounts" class="btn btn-secondary">
            <i class="fas fa-times"></i>
            <span>Cancel</span>
        </a>
    </div>
</form>

<script>
    function toggleAccountFields() {
        const accountType = document.getElementById('account_type').value;
        const imapFields = document.getElementById('imap_fields');
        const oauthFields = document.getElementById('oauth_fields');
        const expungeGroup = document.getElementById('expunge_deleted_group');

        if (accountType === 'imap') {
            imapFields.style.display = 'block';
            oauthFields.style.display = 'none';
            expungeGroup.style.display = 'block';
        } else {
            imapFields.style.display = 'none';
            oauthFields.style.display = 'block';
            expungeGroup.style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', toggleAccountFields);
</script>

{% endblock %}
