{% extends "base.html" %}
{% block content %}

<h2>{{ "Edit Fetch Account" if account else "New Fetch Account" }}</h2>

<!-- Fetch Account Form Section -->
<div class="settings-section">
    <h3>{{ "Edit Account Settings" if account else "Account Settings" }}</h3>
    <p class="section-description">{{ "Update the settings for this fetch account" if account else "Configure a new email fetch account" }}</p>

    <!-- TEST CONNECTION FORM (at top) -->
    {% if account and account.account_type == 'imap' %}
    <div style="margin-bottom: 30px;">
        <form method="post" action="/fetch_accounts/test" class="test-connection-form">
            <input type="hidden" name="account_id" value="{{ account.id if account else '' }}">
            <input type="hidden" name="name" value="{{ account.name if account else '' }}">
            <input type="hidden" name="account_type" value="{{ account.account_type if account else 'imap' }}">
            <input type="hidden" name="host" value="{{ account.host if account else '' }}">
            <input type="hidden" name="port" value="{{ account.port if account else '993' }}">
            <input type="hidden" name="username" value="{{ account.username if account else '' }}">
            <input type="hidden" name="password" value="{{ account.password if account else '' }}">
            <input type="hidden" name="use_ssl" value="{{ 'true' if account and account.use_ssl else 'false' }}">
            <input type="hidden" name="require_starttls" value="{{ 'true' if account and account.require_starttls else 'false' }}">
            <input type="hidden" name="poll_interval_seconds" value="{{ account.poll_interval_seconds if account else '300' }}">
            <input type="hidden" name="delete_after_processing" value="{{ 'true' if account and account.delete_after_processing else 'false' }}">
            <input type="hidden" name="enabled" value="{{ 'true' if not account or account.enabled else 'false' }}">
            <button type="submit" class="btn btn-secondary"><i class="fa-solid fa-plug"></i> Test Connection</button>
        </form>
    </div>
    {% endif %}

    <!-- MAIN FORM: Create/Update Account -->
    <form method="post" action="{{ '/fetch_accounts/' ~ account.id ~ '/edit' if account else '/fetch_accounts/new' }}">

        <input type="hidden" name="account_id" value="{{ account.id if account else '' }}">

        <div class="form-group">
            <label for="name">Account Name <span class="text-danger">*</span></label>
            <input id="name" class="form-control" name="name" value="{{ account.name if account else '' }}" required>
        </div>

        <div class="form-group">
            <label for="account_type">Account Type <span class="text-danger">*</span></label>
            <select id="account_type" class="form-control" name="account_type" required onchange="toggleAccountFields()">
                <option value="imap" {% if not account or account.account_type == 'imap' %}selected{% endif %}>IMAP</option>
                <option value="gmail" {% if account and account.account_type == 'gmail' %}selected{% endif %}>Gmail API</option>
                <option value="o365" {% if account and account.account_type == 'o365' %}selected{% endif %}>Office 365 API</option>
            </select>
            <small class="text-muted">Select the type of email service to fetch from</small>
        </div>

        <!-- IMAP-specific fields -->
        <div id="imap_fields" style="display: none;">
            <div class="form-group">
                <label for="host">Host</label>
                <input id="host" class="form-control" name="host" value="{{ account.host if account else '' }}">
            </div>

            <div class="form-group">
                <label for="port">Port</label>
                <input id="port" class="form-control" name="port" type="number" value="{{ account.port if account else '993' }}">
            </div>

            <div class="form-group">
                <label for="username">Username</label>
                <input id="username" class="form-control" name="username" value="{{ account.username if account else '' }}">
            </div>

            <div class="form-group">
                <label for="password">Password {% if account %}(leave blank to keep existing){% endif %}</label>
                <input id="password" class="form-control" name="password" type="password">
            </div>

            <div class="form-checkboxes">
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="use_ssl" name="use_ssl" {% if account and account.use_ssl %}checked{% endif %}>
                    <label for="use_ssl">Use SSL</label>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="require_starttls" name="require_starttls" {% if account and account.require_starttls %}checked{% endif %}>
                    <label for="require_starttls">Require STARTTLS</label>
                </div>
            </div>
        </div>

        <!-- Gmail/O365 fields (OAuth2) -->
        <div id="oauth_fields" style="display: none;">
            <div class="alert alert-info">
                <strong><i class="fas fa-info-circle"></i> Note:</strong> Gmail and Office 365 support will require OAuth2 configuration. This feature is coming soon!
            </div>
        </div>

        <!-- Common fields -->
        <div class="form-group">
            <label for="poll_interval_common">Poll Interval (seconds)</label>
            <input id="poll_interval_common" class="form-control" name="poll_interval_seconds" type="number" value="{{ account.poll_interval_seconds if account else '300' }}">
        </div>

        <div class="form-checkboxes">
            <div class="form-group checkbox-group">
                <input type="checkbox" id="delete_after" name="delete_after_processing" {% if account and account.delete_after_processing %}checked{% endif %}>
                <label for="delete_after">Delete Email After Processed</label>
            </div>

            <div class="form-group checkbox-group">
                <input type="checkbox" id="enabled" name="enabled" {% if not account or account.enabled %}checked{% endif %}>
                <label for="enabled">Enabled</label>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary"><i class="fa-solid fa-save"></i> {{ "Update Account" if account else "Create Account" }}</button>
            <a href="/fetch_accounts" class="btn btn-secondary">Cancel</a>
        </div>

    </form>
</div>

<script>
function toggleAccountFields() {
    const accountType = document.getElementById('account_type').value;
    const imapFields = document.getElementById('imap_fields');
    const oauthFields = document.getElementById('oauth_fields');
    
    if (accountType === 'imap') {
        imapFields.style.display = 'block';
        oauthFields.style.display = 'none';
    } else {
        imapFields.style.display = 'none';
        oauthFields.style.display = 'block';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', toggleAccountFields);
</script>

{% endblock %}
