{% extends "base.html" %}
{% block content %}

<h2>{{ "Edit IMAP Account" if account else "New IMAP Account" }}</h2>

<!-- Removed duplicate flash display, as base.html handles it -->

<!-- MAIN FORM: Create/Update Account -->
<form method="post" action="{{ '/imap_accounts/' ~ account.id ~ '/edit' if account else '/imap_accounts/new' }}">

    <input type="hidden" name="account_id" value="{{ account.id if account else '' }}">

    <div class="form-group">
        <label for="name">Name</label>
        <input id="name" class="form-control" name="name" value="{{ account.name if account else '' }}">
    </div>

    <div class="form-group">
        <label for="host">Host</label>
        <input id="host" class="form-control" name="host" value="{{ account.host if account else '' }}">
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="port">Port</label>
            <input id="port" class="form-control" name="port" type="number" value="{{ account.port if account else '993' }}">
        </div>
        <div class="form-group">
            <label for="poll_interval">Poll Interval (seconds)</label>
            <input id="poll_interval" class="form-control" name="poll_interval_seconds" type="number" value="{{ account.poll_interval_seconds if account else '300' }}">
        </div>
    </div>

    <div class="form-group">
        <label for="username">Username</label>
        <input id="username" class="form-control" name="username" value="{{ account.username if account else '' }}">
    </div>

    <div class="form-group">
        <label for="password">Password {% if account %}(leave blank to keep existing){% endif %}</label>
        <input id="password" class="form-control" name="password" type="password">
    </div>

    <div class="form-checkboxes">
        <div class="form-group checkbox-group">
            <input type="checkbox" id="use_ssl" name="use_ssl" {% if account and account.use_ssl %}checked{% endif %}>
            <label for="use_ssl">Use SSL</label>
        </div>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="require_starttls" name="require_starttls" {% if account and account.require_starttls %}checked{% endif %}>
            <label for="require_starttls">Require STARTTLS</label>
        </div>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="delete_after" name="delete_after_processing" {% if account and account.delete_after_processing %}checked{% endif %}>
            <label for="delete_after">Delete Email After Processed</label>
        </div>

        <div class="form-group checkbox-group">
            <input type="checkbox" id="enabled" name="enabled" {% if not account or account.enabled %}checked{% endif %}>
            <label for="enabled">Enabled</label>
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary"><i class="fa-solid fa-save"></i> {{ "Update Account" if account else "Create Account" }}</button>
    </div>

</form>

<!-- SEPARATE FORM: Test Connection -->
<form method="post" action="/imap_accounts/test" class="test-connection-form">
    <input type="hidden" name="account_id" value="{{ account.id if account else '' }}">
    <input type="hidden" name="name" value="{{ account.name if account else '' }}">
    <input type="hidden" name="host" value="{{ account.host if account else '' }}">
    <input type="hidden" name="port" value="{{ account.port if account else '993' }}">
    <input type="hidden" name="username" value="{{ account.username if account else '' }}">
    <input type="hidden" name="password" value="{{ account.password if account else '' }}">
    <input type="hidden" name="use_ssl" value="{{ 'true' if account and account.use_ssl else 'false' }}">
    <input type="hidden" name="require_starttls" value="{{ 'true' if account and account.require_starttls else 'false' }}">
    <input type="hidden" name="poll_interval_seconds" value="{{ account.poll_interval_seconds if account else '300' }}">
    <input type="hidden" name="delete_after_processing" value="{{ 'true' if account and account.delete_after_processing else 'false' }}">
    <input type="hidden" name="enabled" value="{{ 'true' if not account or account.enabled else 'false' }}">
    <button type="submit" class="btn btn-secondary"><i class="fa-solid fa-plug"></i> Test Connection</button>
</form>

{% endblock %}
