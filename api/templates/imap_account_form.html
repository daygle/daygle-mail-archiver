{% extends "base.html" %}
{% block content %}

<h2>{{ "Edit IMAP Account" if account else "New IMAP Account" }}</h2>

{% if flash %}
<div class="flash">{{ flash }}</div>
{% endif %}

<!-- MAIN FORM: Create/Update Account -->
<form method="post" action="{{ '/imap_accounts/' ~ account.id ~ '/edit' if account else '/imap_accounts/new' }}">

    <input type="hidden" name="account_id" value="{{ account.id if account else '' }}">

    <div class="form-group">
        <label>Name</label>
        <input name="name" value="{{ account.name if account else '' }}">
    </div>

    <div class="form-group">
        <label>Host</label>
        <input name="host" value="{{ account.host if account else '' }}">
    </div>

    <div class="form-group">
        <label>Port</label>
        <input name="port" type="number" value="{{ account.port if account else '993' }}">
    </div>

    <div class="form-group">
        <label>Username</label>
        <input name="username" value="{{ account.username if account else '' }}">
    </div>

    <div class="form-group">
        <label>Password {% if account %}(leave blank to keep existing){% endif %}</label>
        <input name="password" type="password">
    </div>

    <div class="form-group">
        <label>Use SSL</label>
        <input type="checkbox" name="use_ssl" {% if account and account.use_ssl %}checked{% endif %}>
    </div>

    <div class="form-group">
        <label>Require STARTTLS</label>
        <input type="checkbox" name="require_starttls" {% if account and account.require_starttls %}checked{% endif %}>
    </div>

    <div class="form-group">
        <label>
            <input type="checkbox" name="delete_after_processing"
                {% if account and account.delete_after_processing %}checked{% endif %}>
            Delete Email After Processed
        </label>
    </div>

    <div class="form-group">
        <label>Poll Interval (seconds)</label>
        <input name="poll_interval_seconds" type="number" value="{{ account.poll_interval_seconds if account else '300' }}">
    </div>

    <div class="form-group">
        <label>Enabled</label>
        <input type="checkbox" name="enabled" {% if not account or account.enabled %}checked{% endif %}>
    </div>

    <div class="form-actions">
        <button type="submit">{{ "Update Account" if account else "Create Account" }}</button>
    </div>

</form>


<!-- SEPARATE FORM: Test Connection -->
<form method="post" action="/imap_accounts/test" class="test-connection-form">

    <input type="hidden" name="account_id" value="{{ account.id if account else '' }}">
    <input type="hidden" name="name" value="{{ account.name if account else '' }}">
    <input type="hidden" name="host" value="{{ account.host if account else '' }}">
    <input type="hidden" name="port" value="{{ account.port if account else '993' }}">
    <input type="hidden" name="username" value="{{ account.username if account else '' }}">

    <!-- Use stored password -->
    <input type="hidden" name="password" value="{{ account.password if account else '' }}">

    <input type="hidden" name="use_ssl" value="{{ 'true' if account and account.use_ssl else 'false' }}">
    <input type="hidden" name="require_starttls" value="{{ 'true' if account and account.require_starttls else 'false' }}">
    <input type="hidden" name="poll_interval_seconds" value="{{ account.poll_interval_seconds if account else '300' }}">
    <input type="hidden" name="delete_after_processing" value="{{ 'true' if account and account.delete_after_processing else 'false' }}">
    <input type="hidden" name="enabled" value="{{ 'true' if not account or account.enabled else 'false' }}">

    <button type="submit" class="test-btn">Test Connection</button>

</form>

{% endblock %}
